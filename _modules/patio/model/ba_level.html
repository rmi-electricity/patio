<!doctype html>
<html class="no-js" lang="en" data-content_root="../../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />
        <link rel="prefetch" href="../../../_static/Small_PNG-RMI_logo_PrimaryUse.PNG" as="image" />
        <link rel="prefetch" href="../../../_static/Small_PNG-RMI_logo_PrimaryUse_White_Horizontal.PNG" as="image" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>patio.model.ba_level - Patio 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">Patio 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../../_static/Small_PNG-RMI_logo_PrimaryUse.PNG" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../../_static/Small_PNG-RMI_logo_PrimaryUse_White_Horizontal.PNG" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Patio 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../LICENSE.html">Licensing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code_of_conduct.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../autoapi/patio/index.html">patio</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of patio</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/_version/index.html">patio._version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/cli/index.html">patio.cli</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/constants/index.html">patio.constants</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/patio/data/index.html">patio.data</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of patio.data</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/data/asset_data/index.html">patio.data.asset_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/data/cems/index.html">patio.data.cems</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/data/entity_ids/index.html">patio.data.entity_ids</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/data/profile_data/index.html">patio.data.profile_data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/exceptions/index.html">patio.exceptions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/helpers/index.html">patio.helpers</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../autoapi/patio/model/index.html">patio.model</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of patio.model</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/ba_level/index.html">patio.model.ba_level</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/ba_scenario/index.html">patio.model.ba_scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/base/index.html">patio.model.base</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_common/index.html">patio.model.colo_common</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_core/index.html">patio.model.colo_core</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_data/index.html">patio.model.colo_data</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_lp/index.html">patio.model.colo_lp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_resources/index.html">patio.model.colo_resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../autoapi/patio/model/colo_results/index.html">patio.model.colo_results</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../autoapi/patio/re_ninja/index.html">patio.re_ninja</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for patio.model.ba_level</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;a model I first heard of while on a patio</span>

<span class="sd">This module contains the core logic of the model.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">multiprocessing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">nullcontext</span><span class="p">,</span> <span class="n">suppress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span><span class="p">,</span> <span class="n">lru_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">traceback</span><span class="w"> </span><span class="kn">import</span> <span class="n">TracebackException</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">cvxpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">DispatchModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dispatch.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">COLOR_MAP</span><span class="p">,</span> <span class="n">PLOT_MAP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dispatch.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">dispatch_key</span><span class="p">,</span> <span class="n">zero_profiles_outside_operating_dates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">etoolbox.datazip</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataZip</span><span class="p">,</span> <span class="n">IOMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">etoolbox.utils.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AZURE_CACHE_PATH</span><span class="p">,</span>
    <span class="n">cached_path</span><span class="p">,</span>
    <span class="n">rmi_cloud_fs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">etoolbox.utils.cloud</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">put</span> <span class="k">as</span> <span class="n">rmi_cloud_put</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">etoolbox.utils.pudl</span><span class="w"> </span><span class="kn">import</span> <span class="n">pl_scan_pudl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">etoolbox.utils.pudl_helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">simplify_columns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">hash_pandas_object</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">platformdirs</span><span class="w"> </span><span class="kn">import</span> <span class="n">user_documents_path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bounds</span><span class="p">,</span> <span class="n">LinearConstraint</span><span class="p">,</span> <span class="n">milp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.auto</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm.contrib.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">logging_redirect_tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">patio.constants</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">BAD_COLO_BAS</span><span class="p">,</span>
    <span class="n">CLEAN_TD_MAP</span><span class="p">,</span>
    <span class="n">ES_TECHS</span><span class="p">,</span>
    <span class="n">FOSSIL_PRIME_MOVER_MAP</span><span class="p">,</span>
    <span class="n">MTDF</span><span class="p">,</span>
    <span class="n">OTHER_TD_MAP</span><span class="p">,</span>
    <span class="n">PATIO_DOC_PATH</span><span class="p">,</span>
    <span class="n">PATIO_PUDL_RELEASE</span><span class="p">,</span>
    <span class="n">REGION_MAP</span><span class="p">,</span>
    <span class="n">ROOT_PATH</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.data.asset_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">AssetData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.data.entity_ids</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_ba_code</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.data.profile_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProfileData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">PatioData</span><span class="p">,</span>
    <span class="n">ScenarioError</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.helpers</span><span class="w"> </span><span class="kn">import</span> <span class="n">_git_commit_info</span><span class="p">,</span> <span class="n">make_core_lhs_rhs</span><span class="p">,</span> <span class="n">pl_distance</span><span class="p">,</span> <span class="n">solver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.model.ba_scenario</span><span class="w"> </span><span class="kn">import</span> <span class="n">BAScenario</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.model.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScenarioConfig</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">patio.model.colo_common</span><span class="w"> </span><span class="kn">import</span> <span class="n">capture_stderr</span><span class="p">,</span> <span class="n">capture_stdout</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;patio&quot;</span><span class="p">)</span>
<span class="c1"># warnings.simplefilter(&quot;once&quot;)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="s2">&quot;BAs&quot;</span><span class="p">]</span>
<span class="n">RNG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">2021</span><span class="p">)</span>
<span class="c1"># trick the linter</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">ES_TECHS</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">PATIO_DOC_PATH</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">PATIO_DOC_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">MIN_UPTIME_BY_PRIME</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;ST&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># steam turbine</span>
        <span class="s2">&quot;GT&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># gas turbine xCC</span>
        <span class="s2">&quot;IC&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># internal combustion</span>
        <span class="s2">&quot;CA&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># steam part of CC</span>
        <span class="s2">&quot;CT&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># gas turbine part of CC</span>
        <span class="s2">&quot;CS&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># single shaft CC</span>
        <span class="s2">&quot;CC&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># CC in planning</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="sd">&quot;&quot;&quot;CCS adders/factors.</span>

<span class="sd">NREL ATB 2022 v2, Coal_Retrofits vs Coal-CCS-90%, 2035 moderate case.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">INTERCON_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;130&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;177&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;186&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;195&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;210&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;22&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;531&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;552&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;556&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;569&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;57&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;58&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;656&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;658&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AEC&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;AECI&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;APS&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CAISO&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DUKE&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EPE&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ERCO&quot;</span><span class="p">:</span> <span class="s2">&quot;erco&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ETR&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;EVRG&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FMPP&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FPC&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;FPL&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ISNE&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;JEA&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LDWP&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;LGEE&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MISO&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NYIS&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NEVP&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PAC&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PJM&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PNM&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PNW&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PSCO&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SC&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SCEG&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SEC&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SOCO&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SRP&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;SWPP&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TEC&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TEPC&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TVA&quot;</span><span class="p">:</span> <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WACM&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WALC&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WAUW&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="c1"># def make_subplant_ids(</span>
<span class="c1">#     crosswalk: pd.DataFrame,</span>
<span class="c1">#     source_keys: list[str],</span>
<span class="c1">#     source_name: str,</span>
<span class="c1">#     target_keys: list[str],</span>
<span class="c1">#     target_name: str,</span>
<span class="c1">#     new_key_name: str,</span>
<span class="c1"># ) -&gt; pd.DataFrame:</span>
<span class="c1">#     &quot;&quot;&quot;Identify prime fuel sub-plants in the EPA/EIA crosswalk and EIA 860 graph.</span>
<span class="c1">#     Any row filtering should be done before this step.</span>
<span class="c1">#     Usage Example:</span>
<span class="c1">#     epacems = pudl.output.epacems.epacems(states=[&#39;ID&#39;]) # small subset for quick test</span>
<span class="c1">#     epacamd_eia = pudl_out.epacamd_eia()</span>
<span class="c1">#     filtered_crosswalk = filter_crosswalk(epacamd_eia, epacems)</span>
<span class="c1">#     crosswalk_with_subplant_ids = make_subplant_ids(filtered_crosswalk)</span>
<span class="c1">#     Note that sub-plant ids should be used in conjunction with `plant_id_eia` vs.</span>
<span class="c1">#     `plant_id_epa` because the former is more granular and integrated into CEMS during</span>
<span class="c1">#     the transform process.</span>
<span class="c1">#</span>
<span class="c1">#     Args:</span>
<span class="c1">#         crosswalk (pd.DataFrame): The epacamd_eia crosswalk</span>
<span class="c1">#         source_keys: columns that comprise the source composite key</span>
<span class="c1">#         source_name: name of the source composite key column</span>
<span class="c1">#         target_keys: columns that comprise the target composite key</span>
<span class="c1">#         target_name: name of the target composite key column</span>
<span class="c1">#         new_key_name: name of the new subplant column that makes up a</span>
<span class="c1">#             composite key with plant_id_eia</span>
<span class="c1">#     Returns:</span>
<span class="c1">#         pd.DataFrame: An edge list connecting EPA units to EIA generators, with</span>
<span class="c1">#             connected pieces issued a subplant_id</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     edge_list = _prep_for_networkx(</span>
<span class="c1">#         crosswalk,</span>
<span class="c1">#         source_keys=source_keys,</span>
<span class="c1">#         target_keys=target_keys,</span>
<span class="c1">#         source_name=source_name,</span>
<span class="c1">#         target_name=target_name,</span>
<span class="c1">#     )</span>
<span class="c1">#     edge_list = _subplant_ids_from_prepped_crosswalk(</span>
<span class="c1">#         edge_list,</span>
<span class="c1">#         source_name=source_name,</span>
<span class="c1">#         target_name=target_name,</span>
<span class="c1">#         new_key_name=new_key_name,</span>
<span class="c1">#     )</span>
<span class="c1">#     # edge_list = _convert_global_id_to_composite_id(edge_list, new_key_name=new_key_name)</span>
<span class="c1">#     return edge_list</span>


<div class="viewcode-block" id="BA">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BA</span><span class="p">(</span><span class="n">IOMixin</span><span class="p">):</span>
<div class="viewcode-block" id="BA._parquet_out">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._parquet_out">[docs]</a>
    <span class="n">_parquet_out</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;plant_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;load&quot;</span><span class="p">,</span>
        <span class="s2">&quot;profiles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_re_profiles&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re_plant_specs&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;fuel_profile&quot;,</span>
        <span class="c1"># &quot;_co2_profile&quot;,</span>
        <span class="s2">&quot;cost_data&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;cems_change&quot;,</span>
        <span class="c1"># &quot;mini_re_prof&quot;,</span>
        <span class="c1"># &quot;old_re_specs&quot;,</span>
        <span class="c1"># &quot;old_re_profs&quot;,</span>
        <span class="c1"># &quot;old_re_prof&quot;,</span>
        <span class="s2">&quot;adj_load&quot;</span><span class="p">,</span>
        <span class="s2">&quot;missing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;proposed_clean_prof&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Ab&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;re_prof_ilr_adj&quot;,</span>
        <span class="s2">&quot;net_load_prof&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fuel_curve&quot;</span><span class="p">,</span>
        <span class="s2">&quot;augmented_load&quot;</span><span class="p">,</span>
        <span class="s2">&quot;existing_re_prof&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re_plant_specs_pre_downselect&quot;</span><span class="p">,</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="BA.re_spec_cols">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.re_spec_cols">[docs]</a>
    <span class="n">re_spec_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;operating_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;retirement_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ilr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;energy_community&quot;</span><span class="p">,</span>
        <span class="s2">&quot;category&quot;</span><span class="p">,</span>
        <span class="s2">&quot;class_atb&quot;</span><span class="p">,</span>
    <span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ba_code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">profiles</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">re_profiles</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">re_plant_specs</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">plant_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">cost_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="c1"># cems_change: pd.DataFrame,</span>
        <span class="n">baseload_replace</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">missing</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">fuel_curve</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">queue</span><span class="p">,</span>
        <span class="n">regime</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ccs_convert</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scenario_configs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ScenarioConfig</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># old_re_prof: pd.DataFrame | None = None,</span>
        <span class="c1"># old_re_specs: pd.DataFrame | None = None,</span>
        <span class="c1"># old_re_profs: pd.DataFrame | None = None,</span>
        <span class="n">existing_re_prof</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_figs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># noqa: FBT001</span>
        <span class="n">exclude_or_mothball</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_re</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">year_mapper</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">re_limits_dispatch</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
        <span class="n">max_wind_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">max_solar_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span>
        <span class="n">min_re_site_mw</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cr_eligible_techs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colo_techs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">colo_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="s2">&quot;iter&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">old_clean_adj_net_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">colo_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pudl_release</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="n">scenario_configs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">scen</span><span class="o">.</span><span class="n">nuclear_scen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;nuclear scenarios are untested&quot;</span>
            <span class="k">assert</span> <span class="n">scen</span><span class="o">.</span><span class="n">ccs_scen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;ccs scenarios are untested&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ba_code</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">plant_data</span><span class="o">.</span><span class="n">respondent_name</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># noqa: PD009</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">ba_code</span>
<div class="viewcode-block" id="BA._metadata">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._metadata">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ba_code&quot;</span><span class="p">:</span> <span class="n">ba_code</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;eia_ba&quot;</span><span class="p">:</span> <span class="n">plant_data</span><span class="o">.</span><span class="n">balancing_authority_code_eia</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># noqa: PD009</span>
            <span class="s2">&quot;year_mapper&quot;</span><span class="p">:</span> <span class="n">year_mapper</span><span class="p">,</span>
            <span class="s2">&quot;max_solar_distance&quot;</span><span class="p">:</span> <span class="n">max_solar_distance</span><span class="p">,</span>
            <span class="s2">&quot;max_wind_distance&quot;</span><span class="p">:</span> <span class="n">max_wind_distance</span><span class="p">,</span>
            <span class="s2">&quot;min_re_site_mw&quot;</span><span class="p">:</span> <span class="n">min_re_site_mw</span><span class="p">,</span>
            <span class="s2">&quot;cr_eligible_techs&quot;</span><span class="p">:</span> <span class="n">cr_eligible_techs</span><span class="p">,</span>
            <span class="s2">&quot;colo_techs&quot;</span><span class="p">:</span> <span class="n">colo_techs</span><span class="p">,</span>
            <span class="s2">&quot;regime&quot;</span><span class="p">:</span> <span class="n">regime</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="BA.pudl_release">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.pudl_release">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span> <span class="o">=</span> <span class="n">pudl_release</span></div>

        <span class="n">profiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_profiles</span><span class="p">(</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_series</span><span class="p">())),</span>
            <span class="n">re_profiles</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scenario_configs</span><span class="p">:</span>
            <span class="c1"># for power we want all years to be the same length</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="n">profiles_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">re_profiles_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">())</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="n">dfr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">==</span> <span class="n">yr</span><span class="p">)</span>
                <span class="n">dfp</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;datetime.dt.year == @yr&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">8760</span><span class="p">:</span>
                    <span class="n">re_profiles_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">dfr</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                    <span class="p">(</span>
                                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
                                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">()</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span>
                                    <span class="p">)</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span>
                                <span class="p">),</span>
                                <span class="n">dfr</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8760</span><span class="p">),</span>
                            <span class="p">],</span>
                            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">profiles_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">dfp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8760</span><span class="p">)</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span>
                            <span class="n">dfp</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~(datetime.dt.month == 2 &amp; datetime.dt.day == 29)&quot;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">profiles_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfp</span><span class="p">)</span>
                    <span class="n">re_profiles_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfr</span><span class="p">)</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">profiles_out</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">re_profiles_out</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">profiles_out</span><span class="p">,</span> <span class="n">re_profiles_out</span>

<div class="viewcode-block" id="BA.queue">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.queue">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">colo_techs</span><span class="o">=</span><span class="n">colo_techs</span><span class="p">,</span>
            <span class="c1"># colo_config={&quot;years&quot;: bad_re_yrs},</span>
            <span class="n">colo_method</span><span class="o">=</span><span class="n">colo_method</span><span class="p">,</span>
        <span class="p">)</span>
<div class="viewcode-block" id="BA.colo_dir">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.colo_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">colo_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">colo_dir</span></div>

        <span class="n">max_re_distance</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_wind_distance</span><span class="p">,</span> <span class="n">max_solar_distance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_re_distance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">re_plant_specs</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_re_distance</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;max distance in re_plant_specs &gt; </span><span class="si">{</span><span class="n">max_re_distance</span><span class="si">=}</span><span class="s2">; filtering must occur before data is passed to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">min_re_site_mw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_re_site_mw</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;min site capacity in re_plant_specs &lt; </span><span class="si">{</span><span class="n">min_re_site_mw</span><span class="si">=}</span><span class="s2">; filtering must occur before data is passed to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># self.old_clean_adj_net_load = old_clean_adj_net_load</span>
        <span class="k">if</span> <span class="n">re_limits_dispatch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;`re_limits_dispatch` must be one of (&#39;both&#39;, True, False)&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BA.re_limits_dispatch">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.re_limits_dispatch">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_limits_dispatch</span> <span class="o">=</span> <span class="n">re_limits_dispatch</span></div>

<div class="viewcode-block" id="BA.plant_data">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.plant_data">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span> <span class="o">=</span> <span class="n">plant_data</span></div>


<div class="viewcode-block" id="BA.load">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.load">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">fossil_list</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

        <span class="c1"># this needs to come after we calculate load to not have retirements affect</span>
        <span class="c1"># load profile</span>
<div class="viewcode-block" id="BA.profiles">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.profiles">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span> <span class="o">=</span> <span class="n">zero_profiles_outside_operating_dates</span><span class="p">(</span>
            <span class="n">profiles</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">profiles</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;operating_date&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">profiles</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;retirement_date&quot;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="BA._re_plant_specs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._re_plant_specs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">_re_plant_specs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">re_plant_specs</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">category</span><span class="o">=</span><span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span>
                <span class="n">area_per_mw</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">area_sq_km</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="p">,</span>
                <span class="n">ones</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">icx_genid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;icx_id&quot;</span><span class="p">,</span> <span class="s2">&quot;icx_gen&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">icx_id</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="s2">&quot;ngroup&quot;</span>
                <span class="p">),</span>
                <span class="n">combi_id</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">plant_id_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">hash_pandas_object</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">),</span>
                <span class="n">cf_mult</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cf_atb</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">cf_ilr_prof_site</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="n">capacity_mw_nrel_site_lim</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site_lim</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">area_sq_km_lim</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">area_sq_km_lim</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;combi_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="p">[[</span><span class="s2">&quot;retirement_date&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_date&quot;</span><span class="p">,</span> <span class="s2">&quot;ever_gas&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;icx_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">:</span> <span class="s2">&quot;icx_gen&quot;</span><span class="p">}),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;icx_id&quot;</span><span class="p">,</span> <span class="s2">&quot;icx_gen&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_icx&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

        <span class="k">if</span> <span class="n">regime</span> <span class="o">==</span> <span class="s2">&quot;reference&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_re_plant_specs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cr_eligible&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">regime</span> <span class="o">==</span> <span class="s2">&quot;limited&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_re_plant_specs</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">capacity_mw_nrel_site_ref</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="p">,</span>
                    <span class="n">area_sq_km_ref</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">area_sq_km</span><span class="p">,</span>
                    <span class="n">capacity_mw_nrel_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site_lim</span><span class="p">,</span>
                    <span class="n">area_sq_km</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">area_sq_km_lim</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;cr_eligible &amp; area_sq_km &gt; @min_re_site_mw&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;regime must be one of (&#39;reference&#39;, &#39;limited&#39;), not </span><span class="si">{</span><span class="n">regime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">re_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_prof_ilr_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_re_profiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span>

<div class="viewcode-block" id="BA.ccs_convert">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.ccs_convert">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">ccs_convert</span> <span class="o">=</span> <span class="n">ccs_convert</span></div>

<div class="viewcode-block" id="BA.include_figs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.include_figs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_figs</span> <span class="o">=</span> <span class="n">include_figs</span></div>

<div class="viewcode-block" id="BA.no_limit_prime">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.no_limit_prime">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,)</span></div>


<div class="viewcode-block" id="BA.cost_data">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.cost_data">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">cost_data</span> <span class="o">=</span> <span class="n">cost_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cost_data</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fossil_list</span><span class="p">],</span> <span class="p">:</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="BA.fuel_curve">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.fuel_curve">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">fuel_curve</span> <span class="o">=</span> <span class="n">fuel_curve</span></div>

        <span class="c1"># self.cems_change = cems_change</span>
<div class="viewcode-block" id="BA.baseload_replace">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.baseload_replace">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseload_replace</span> <span class="o">=</span> <span class="n">baseload_replace</span></div>

<div class="viewcode-block" id="BA.max_re">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.max_re">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_re</span> <span class="o">=</span> <span class="n">max_re</span></div>

        <span class="k">if</span> <span class="n">exclude_or_mothball</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_or_mothball</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude_or_mothball</span> <span class="o">=</span> <span class="n">exclude_or_mothball</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span> <span class="o">=</span> <span class="n">exclude</span>
        <span class="k">if</span> <span class="n">scenario_configs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">BAs</span><span class="o">.</span><span class="n">def_scen_configs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split_ccs</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scenario_configs</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split_ccs</span><span class="p">()]</span>

<div class="viewcode-block" id="BA._scenarios">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._scenarios">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BAScenario</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></div>

        <span class="c1"># self.n_years = self.profiles.index.year.nunique()</span>
        <span class="c1"># self.align_profiles()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="c1"># ramp_rate=lambda x: x.capacity_mw / x.ramp_hrs,</span>
            <span class="c1"># currently using CEMS ramp because 860 is too imprecise</span>
            <span class="n">cems_ramp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">ramp_rate</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">technology_description</span> <span class="o">==</span> <span class="s2">&quot;GT&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">cems_ramp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="c1"># TODO: assuming all proposed plants can ramp in 1hr is not great</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">),</span>
                <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span><span class="p">,</span>
                <span class="n">x</span><span class="o">.</span><span class="n">cems_ramp</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="c1"># min_uptime to deal with deficits was bad, we&#39;re trying dynamic</span>
            <span class="c1"># storage reserves instead</span>
            <span class="c1"># min_uptime=lambda x: x.prime_mover_code.map(MIN_UPTIME_BY_PRIME),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cems_ramp&quot;</span><span class="p">])</span>

        <span class="c1"># self.plant_data = self.plant_data.loc[self.profiles.columns, :]</span>
        <span class="c1"># self.profiles = self.profiles[self.plant_data.index]</span>
        <span class="c1"># assert np.all(</span>
        <span class="c1">#     self.plant_data.index == self.profiles.columns</span>
        <span class="c1"># ), &quot;plant_data and req_profiles indexes do not match&quot;</span>
        <span class="c1"># self.re_plant_specs = self.re_plant_specs</span>
        <span class="c1"># adj_load = self.load.to_numpy()</span>

        <span class="c1"># annual load should never drop below the leap-year adjusted level of the most</span>
        <span class="c1"># recent historical year</span>
<div class="viewcode-block" id="BA.augmented_load">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.augmented_load">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">augmented_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span></div>


<div class="viewcode-block" id="BA.existing_re_prof">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.existing_re_prof">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_re_prof</span> <span class="o">=</span> <span class="n">existing_re_prof</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span>
        <span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="BA.adj_load">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.adj_load">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">adj_load</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="mf">0.0</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">augmented_load</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_re_prof</span><span class="o">.</span><span class="n">synthetic</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
        <span class="p">)</span></div>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proposed_clean_prof</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">zero_profiles_outside_operating_dates</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">]</span>
                        <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="s2">&quot;ilr&quot;</span><span class="p">],</span>
                        <span class="mf">1.0</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="s2">&quot;operating_date&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="s2">&quot;retirement_date&quot;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="s2">&quot;capacity_mw&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">to_numpy</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proposed_clean_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adj_load</span><span class="p">)</span>

<div class="viewcode-block" id="BA.net_load_prof">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.net_load_prof">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_load_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adj_load</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposed_clean_prof</span><span class="p">,</span>
            <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BA.re_plant_specs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.re_plant_specs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_prof_ilr_adj</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">net_load_prof</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">net_load_prof</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_load_prof</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;total_norm_match&quot;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">re_prof_ilr_adj</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;re_site_gen&quot;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">re_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lcoe</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">re_site_gen</span><span class="p">,</span>
                <span class="n">avoided_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_var_mwh</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">total_norm_match</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">re_cost</span><span class="p">,</span>
                <span class="n">re_max_obj_coef</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;re_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lcoe</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span>
                    <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">test</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;total_var_mwh.isna()&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> unable to calculate avoided cost for </span><span class="si">%s</span><span class="s2"> re sites&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s2">&quot;avoided_cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">})</span>

<div class="viewcode-block" id="BA.Ab">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.Ab">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="o">=</span> <span class="n">make_core_lhs_rhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BA.re_plant_specs_pre_downselect">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.re_plant_specs_pre_downselect">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs_pre_downselect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="BA.msg">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.msg">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span></div>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">en</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">cf_atb</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span>
                <span class="n">wind_lb</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span> <span class="s2">&quot;limited&quot;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;max energy MILP failed at BA level -&gt; using LP&quot;</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">en</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp</span><span class="p">(</span><span class="n">c</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">cf_atb</span><span class="p">)</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=-</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="o">+</span> <span class="mi">1</span>
                <span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;savings&quot;</span><span class="p">,</span>
                <span class="n">wind_lb</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span> <span class="s2">&quot;limited&quot;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;max savings MILP failed at BA level -&gt; using LP&quot;</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">=-</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">cap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_max_obj_coef</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;capacity&quot;</span><span class="p">,</span>
                <span class="n">wind_lb</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;reference&quot;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span> <span class="s2">&quot;limited&quot;</span><span class="p">:</span> <span class="mf">25.0</span><span class="p">}[</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]],</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;max capacity MILP failed at BA level -&gt; using LP&quot;</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">cap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lp</span><span class="p">(</span><span class="n">c</span><span class="o">=-</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_max_obj_coef</span><span class="p">)</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">en</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;energy_max&quot;</span><span class="p">),</span>
                    <span class="n">cap</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;cap_max&quot;</span><span class="p">),</span>
                    <span class="n">save</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;savings_max&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="c1"># want to always include RE where fossil generator is retiring</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">retirement_date_icx</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ops</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;more than 10k re/fos site combos so downselecting at BA level (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs_pre_downselect</span><span class="p">)</span> <span class="o">==</span> <span class="n">re_len</span><span class="p">,</span> <span class="p">(</span>
                <span class="s2">&quot;We lost RE sites pre-downselection&quot;</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">ops</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="o">=</span> <span class="n">make_core_lhs_rhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_energy</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">energy_max</span>
                <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">cf_atb</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_load_prof</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_energy</span> <span class="o">=</span> <span class="mf">0.0</span>

<div class="viewcode-block" id="BA.counterfactual">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.counterfactual">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual</span><span class="p">:</span> <span class="n">BAScenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_cfl</span><span class="p">()</span></div>

<div class="viewcode-block" id="BA.missing">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.missing">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">historical_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">net_generation_mwh</span><span class="p">),</span>
            <span class="n">historical_mmbtu</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_for_electricity_mmbtu</span><span class="p">,</span>
            <span class="n">historical_co2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">historical_mmbtu</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">co2_factor</span><span class="p">,</span>
            <span class="n">historical_cost_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">historical_mwh</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_per_mwh</span><span class="p">,</span>
            <span class="n">historical_cost_vom</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">historical_mwh</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">vom_per_mwh</span><span class="p">,</span>
            <span class="n">historical_cost_fom</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">fom_per_kw</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">redispatch_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">historical_mwh</span><span class="p">,</span>
            <span class="n">redispatch_mmbtu</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_consumed_for_electricity_mmbtu</span><span class="p">,</span>
            <span class="n">redispatch_co2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mmbtu</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">co2_factor</span><span class="p">,</span>
            <span class="n">redispatch_cost_fuel</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">fuel_per_mwh</span><span class="p">,</span>
            <span class="n">redispatch_cost_vom</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">vom_per_mwh</span><span class="p">,</span>
            <span class="n">redispatch_cost_fom</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">fom_per_kw</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;net_generation_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fuel_consumed_for_electricity_mmbtu&quot;</span><span class="p">,</span>
                <span class="c1"># &quot;fuel_consumed_mmbtu&quot;,</span>
                <span class="s2">&quot;vom_per_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fuel_per_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_var_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fom_per_kw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;start_per_kw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heat_rate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;co2_factor&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

        <span class="k">if</span> <span class="s2">&quot;technology_description&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">missing</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;technology_description_x&quot;</span><span class="p">:</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="c1"># if self.old_clean_adj_net_load:</span>
        <span class="c1">#     self.missing = pd.concat(</span>
        <span class="c1">#         [</span>
        <span class="c1">#             self.missing,</span>
        <span class="c1">#             self.old_re_specs.reset_index()</span>
        <span class="c1">#             .assign()</span>
        <span class="c1">#             .merge(</span>
        <span class="c1">#                 (self.old_re_profs * self.old_re_specs.capacity_mw)</span>
        <span class="c1">#                 .groupby(pd.Grouper(freq=&quot;YS&quot;))</span>
        <span class="c1">#                 .sum()</span>
        <span class="c1">#                 .stack([0, 1])</span>
        <span class="c1">#                 .reset_index(name=&quot;redispatch_mwh&quot;),</span>
        <span class="c1">#                 on=[&quot;plant_id_eia&quot;, &quot;generator_id&quot;],</span>
        <span class="c1">#                 validate=&quot;1:m&quot;,</span>
        <span class="c1">#             )</span>
        <span class="c1">#             .set_index([&quot;plant_id_eia&quot;, &quot;generator_id&quot;, &quot;datetime&quot;])</span>
        <span class="c1">#             .assign(</span>
        <span class="c1">#                 historical_mwh=lambda x: x.redispatch_mwh, final_ba_code=ba_code</span>
        <span class="c1">#             ),</span>
        <span class="c1">#         ]</span>
        <span class="c1">#     )</span>

<div class="viewcode-block" id="BA.setup_re_profiles">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.setup_re_profiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_re_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">re_specs</span><span class="p">):</span>
        <span class="n">re_pro_help</span> <span class="o">=</span> <span class="n">re_specs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])[</span>
            <span class="p">[</span><span class="s2">&quot;cf_mult&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_date&quot;</span><span class="p">,</span> <span class="s2">&quot;retirement_date&quot;</span><span class="p">,</span> <span class="s2">&quot;ilr&quot;</span><span class="p">,</span> <span class="s2">&quot;combined&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">re_profiles_large</span> <span class="o">=</span> <span class="n">zero_profiles_outside_operating_dates</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_re_profiles</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)[</span><span class="n">re_pro_help</span><span class="o">.</span><span class="n">combined</span><span class="p">]</span>
                <span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="n">re_pro_help</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">re_pro_help</span><span class="o">.</span><span class="n">cf_mult</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">re_pro_help</span><span class="o">.</span><span class="n">operating_date</span><span class="p">,</span>
            <span class="n">re_pro_help</span><span class="o">.</span><span class="n">retirement_date</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">re_prof_ilr_adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">re_profiles_large</span> <span class="o">*</span> <span class="n">re_pro_help</span><span class="o">.</span><span class="n">ilr</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">re_profiles_large</span><span class="p">,</span> <span class="n">re_prof_ilr_adj</span></div>


<div class="viewcode-block" id="BA.make_mini_re_profiles">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.make_mini_re_profiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_mini_re_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create aggregated RE profiles to use in ``equal_energy``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span>
        <span class="n">mini_meta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;ba_weight&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;ilr&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">pd</span><span class="o">.</span><span class="n">testing</span><span class="o">.</span><span class="n">assert_index_equal</span><span class="p">(</span>
            <span class="n">mini_meta</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">check_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">check_order</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mini_re_prof</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span> <span class="o">*</span> <span class="n">mini_meta</span><span class="o">.</span><span class="n">ilr</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">mini_meta</span><span class="o">.</span><span class="n">ba_weight</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">re_t</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;onshore_wind&quot;</span><span class="p">,</span> <span class="s2">&quot;solar&quot;</span><span class="p">,</span> <span class="s2">&quot;offshore_wind&quot;</span><span class="p">]</span>
        <span class="n">fill</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re_t</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mini_re_prof</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mini_re_prof</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="n">fill</span><span class="p">)[</span><span class="n">re_t</span><span class="p">]</span></div>


<div class="viewcode-block" id="BA.lp">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.lp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">lp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Ab_eq</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">Ab_ub</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">solver_</span> <span class="o">=</span> <span class="n">solver</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">GUROBI</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;TimeLimit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">,</span>
                <span class="s2">&quot;Threads&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="c1"># &quot;LogToConsole&quot;: 1,</span>
                <span class="s2">&quot;reoptimize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">HIGHS</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;time_limit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">,</span> <span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">},</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">COPT</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TimeLimit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">},</span>
        <span class="p">}[</span><span class="n">solver_</span><span class="p">]</span>

        <span class="n">Ab_ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="k">if</span> <span class="n">Ab_ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Ab</span><span class="p">,</span> <span class="n">Ab_ub</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c</span>
        <span class="n">A_eq</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">Ab_eq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Ab_eq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">b_eq</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">Ab_eq</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Ab_eq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lb</span>

        <span class="n">ub</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_max_re_scen</span>
            <span class="k">if</span> <span class="s2">&quot;capacity_max_re_scen&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ub</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">),</span> <span class="s2">&quot;lb &gt; ub&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Ab_ub</span> <span class="o">=</span> <span class="n">Ab_ub</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">cons</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ab_ub</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Ab_ub</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">lb</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Ab_eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A_eq</span> <span class="o">@</span> <span class="n">x</span> <span class="o">==</span> <span class="n">b_eq</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span><span class="p">),</span> <span class="n">cons</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver_</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span></div>


        <span class="c1"># r = linprog(</span>
        <span class="c1">#     A_ub=Ab_ub.iloc[:, :-1].to_numpy(),</span>
        <span class="c1">#     b_ub=Ab_ub.iloc[:, -1].to_numpy(),</span>
        <span class="c1">#     A_eq=A_eq,</span>
        <span class="c1">#     b_eq=b_eq,</span>
        <span class="c1">#     c=c.to_numpy(),</span>
        <span class="c1">#     # bounds=(0, None),</span>
        <span class="c1">#     bounds=list(iter(np.vstack((lb, ub)).transpose())),</span>
        <span class="c1">#     method=&quot;highs&quot;,</span>
        <span class="c1"># )</span>
        <span class="c1"># if r.success is False:</span>
        <span class="c1">#     return False, r.message</span>
        <span class="c1"># return True, pd.Series(</span>
        <span class="c1">#     r.x,</span>
        <span class="c1">#     index=pd.MultiIndex.from_frame(</span>
        <span class="c1">#         self.re_plant_specs[[&quot;icx_genid&quot;, &quot;re_site_id&quot;, &quot;re_type&quot;]]</span>
        <span class="c1">#     ),</span>
        <span class="c1"># )</span>

<div class="viewcode-block" id="BA.milp">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.milp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">milp</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">Ab_eq</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">Ab_ub</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">lb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wind_lb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="mf">80.0</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
        <span class="n">mip_rel_gap</span><span class="o">=</span><span class="mf">1.5e-4</span><span class="p">,</span>
        <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">c_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c</span>
        <span class="n">Ab_ub_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="k">if</span> <span class="n">Ab_ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Ab</span><span class="p">,</span> <span class="n">Ab_ub</span><span class="p">])</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span> <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lb</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">lb</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">solver_</span> <span class="o">=</span> <span class="n">solver</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">GUROBI</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;TimeLimit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">,</span>
                <span class="s2">&quot;Threads&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;LogToConsole&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;reoptimize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;MIPGap&quot;</span><span class="p">:</span> <span class="n">mip_rel_gap</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">HIGHS</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;time_limit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">,</span> <span class="s2">&quot;parallel&quot;</span><span class="p">:</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;mip_rel_gap&quot;</span><span class="p">:</span> <span class="n">mip_rel_gap</span><span class="p">},</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">COPT</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;TimeLimit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">},</span>
        <span class="p">}[</span><span class="n">solver_</span><span class="p">]</span>

        <span class="n">ub</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_max_re_scen</span>
            <span class="k">if</span> <span class="s2">&quot;capacity_max_re_scen&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">lb_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="c1"># we only use the wind_lb as the lower bound when there is not already</span>
            <span class="c1"># some wind at that site and the site is large enough to build as much</span>
            <span class="c1"># as the wind_lb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&gt;</span> <span class="n">wind_lb</span><span class="p">),</span>
            <span class="n">wind_lb</span><span class="p">,</span>
            <span class="c1"># sometimes rounding causes problems and the previous scenario&#39;s selection</span>
            <span class="c1"># is close and actually a little more than the upper bound which makes the</span>
            <span class="c1"># problem infeasible, so we fix that here</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lb</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span> <span class="n">ub</span><span class="p">,</span> <span class="n">lb</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ub</span> <span class="o">&gt;=</span> <span class="n">lb_</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;lb&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lb_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">combi_id</span><span class="p">),</span>
                        <span class="s2">&quot;ub&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">combi_id</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;lb &gt; ub&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScenarioError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> lb &gt; ub </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;re_cap&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Ab_eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">b_eq</span> <span class="o">=</span> <span class="n">Ab_eq</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">A_eq</span> <span class="o">=</span> <span class="n">Ab_eq</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">[</span><span class="n">A_eq</span> <span class="o">@</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="n">b_eq</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">A_eq</span> <span class="o">@</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">b_eq</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">semicon</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&gt;</span> <span class="n">wind_lb</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">semicon_idx</span> <span class="o">:=</span> <span class="n">semicon</span><span class="p">[</span><span class="n">semicon</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">():</span>
            <span class="n">bin_var</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">semicon_idx</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bin&quot;</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">semicon_con</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span><span class="p">[</span><span class="n">semicon_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">cp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">lb_</span><span class="p">[</span><span class="n">semicon_idx</span><span class="p">],</span> <span class="n">bin_var</span><span class="p">),</span>
                <span class="n">x</span><span class="p">[</span><span class="n">semicon_idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">semicon_idx</span><span class="p">],</span> <span class="n">bin_var</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">semicon_con</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">con_idx</span> <span class="o">=</span> <span class="n">semicon</span><span class="p">[</span><span class="o">~</span><span class="n">semicon</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">too_little</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&lt;</span> <span class="n">wind_lb</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">too_little_idx</span> <span class="o">=</span> <span class="n">too_little</span><span class="p">[</span><span class="n">too_little</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">Ab_ub__</span> <span class="o">=</span> <span class="n">Ab_ub_</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cp_con</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">Ab_ub__</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">@</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">Ab_ub__</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="o">*</span><span class="n">eq</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[</span><span class="n">con_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lb_</span><span class="p">[</span><span class="n">con_idx</span><span class="p">],</span>
                <span class="n">x</span><span class="p">[</span><span class="n">con_idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ub</span><span class="p">[</span><span class="n">con_idx</span><span class="p">],</span>
                <span class="o">*</span><span class="n">semicon_con</span><span class="p">,</span>
                <span class="o">*</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">too_little_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">]</span> <span class="k">if</span> <span class="n">too_little_idx</span> <span class="k">else</span> <span class="p">[]),</span>
            <span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">c_</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">@</span> <span class="n">x</span><span class="p">),</span> <span class="n">cp_con</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">capture_stdout</span><span class="p">()</span> <span class="k">as</span> <span class="n">c_out</span><span class="p">,</span> <span class="n">capture_stderr</span><span class="p">()</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver_</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">cp</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">c_out</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="n">err</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">c_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">err</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="o">.</span><span class="n">OPTIMAL</span><span class="p">:</span>  <span class="c1"># noinspection PyUnreachableCode</span>
                <span class="c1"># noinspection PyUnreachableCode</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>  <span class="c1"># noinspection PyUnreachableCode</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="o">.</span><span class="n">USER_LIMIT</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">mip_gap</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">attr</span><span class="p">[</span><span class="s2">&quot;solver_specific_stats&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">MIPGAP</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-3</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> using MILP results with </span><span class="si">{</span><span class="n">mip_gap</span><span class="si">=}</span><span class="s2"> after </span><span class="si">{</span><span class="n">time_limit</span><span class="si">=}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">cp</span><span class="o">.</span><span class="n">INFEASIBLE</span> <span class="ow">and</span> <span class="n">wind_lb</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> MILP failed with </span><span class="si">{</span><span class="n">wind_lb</span><span class="si">=}</span><span class="s2"> -&gt; trying again with </span><span class="si">{</span><span class="n">wind_lb</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">Ab_eq</span><span class="o">=</span><span class="n">Ab_eq</span><span class="p">,</span>
                    <span class="n">Ab_ub</span><span class="o">=</span><span class="n">Ab_ub</span><span class="p">,</span>
                    <span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
                    <span class="n">wind_lb</span><span class="o">=</span><span class="n">wind_lb</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                    <span class="n">time_limit</span><span class="o">=</span><span class="n">time_limit</span><span class="p">,</span>
                    <span class="n">mip_rel_gap</span><span class="o">=</span><span class="n">mip_rel_gap</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">status</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> failed: </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">SOLVER_ERROR</span></div>


        <span class="c1"># q = (</span>
        <span class="c1">#     self.re_plant_specs.assign(mw=x.value, lb_=lb_, ub=ub)</span>
        <span class="c1">#     .join(pd.DataFrame(bin_var.value, index=semicon_idx, columns=[&quot;bin&quot;]))[</span>
        <span class="c1">#         [</span>
        <span class="c1">#             co</span>
        <span class="c1">#             for co in (</span>
        <span class="c1">#                 &quot;re_site_id&quot;,</span>
        <span class="c1">#                 &quot;re_type&quot;,</span>
        <span class="c1">#                 &quot;capacity_mw_nrel_site&quot;,</span>
        <span class="c1">#                 &quot;capacity_max_re_scen&quot;,</span>
        <span class="c1">#             )</span>
        <span class="c1">#             if co in self.re_plant_specs</span>
        <span class="c1">#         ]</span>
        <span class="c1">#         + [&quot;mw&quot;, &quot;bin&quot;, &quot;lb_&quot;, &quot;ub&quot;]</span>
        <span class="c1">#     ]</span>
        <span class="c1">#     .query(&quot;mw &gt; 0 | bin &gt; 0&quot;)</span>
        <span class="c1"># )</span>

<div class="viewcode-block" id="BA.milp_scipy">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.milp_scipy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">milp_scipy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">c</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">Ab_eq</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">Ab_ub</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># noqa: N803</span>
        <span class="n">lb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">wind_lb</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">80.0</span><span class="p">,</span>
        <span class="n">time_limit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">desc</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">mip_rel_gap</span><span class="o">=</span><span class="mf">1.5e-4</span><span class="p">,</span>
        <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">presolve</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">|</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">c_</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">avoided_cost</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">c</span>
        <span class="n">Ab_ub_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="k">if</span> <span class="n">Ab_ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Ab</span><span class="p">,</span> <span class="n">Ab_ub</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Ab_eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eq_con</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_eq</span> <span class="o">=</span> <span class="n">Ab_eq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">eq_con</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">LinearConstraint</span><span class="p">(</span>
                    <span class="n">A</span><span class="o">=</span><span class="n">Ab_eq</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">lb</span><span class="o">=</span><span class="n">b_eq</span> <span class="o">*</span> <span class="mf">0.95</span><span class="p">,</span>
                    <span class="n">ub</span><span class="o">=</span><span class="n">b_eq</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c_</span><span class="p">)</span> <span class="k">if</span> <span class="n">lb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lb</span>

        <span class="n">ub</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_max_re_scen</span>
            <span class="k">if</span> <span class="s2">&quot;capacity_max_re_scen&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">lb_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="c1"># we only use the wind_lb as the lower bound when there is not already</span>
            <span class="c1"># some wind at that site and the site is large enough to build as much</span>
            <span class="c1"># as the wind_lb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&gt;</span> <span class="n">wind_lb</span><span class="p">),</span>
            <span class="n">wind_lb</span><span class="p">,</span>
            <span class="c1"># sometimes rounding causes problems and the previous scenario&#39;s selection</span>
            <span class="c1"># is close and actually a little more than the upper bound which makes the</span>
            <span class="c1"># problem infeasible, so we fix that here</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lb</span> <span class="o">&gt;</span> <span class="n">ub</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span> <span class="n">ub</span><span class="p">,</span> <span class="n">lb</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ub</span> <span class="o">&gt;=</span> <span class="n">lb_</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;lb&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">lb_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">combi_id</span><span class="p">),</span>
                        <span class="s2">&quot;ub&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">combi_id</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;lb &gt; ub&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ScenarioError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> lb &gt; ub </span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">df</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">milp</span><span class="p">(</span>
            <span class="n">c</span><span class="o">=</span><span class="n">c_</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
            <span class="n">integrality</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="c1"># these must follow the same logic as lb_ otherwise some wind sites</span>
                <span class="c1"># could be 0.0 even after an earlier scenario built there</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;wind&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">ub</span> <span class="o">&gt;</span> <span class="n">wind_lb</span><span class="p">),</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span>
                <span class="n">LinearConstraint</span><span class="p">(</span>
                    <span class="n">A</span><span class="o">=</span><span class="n">Ab_ub_</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                    <span class="n">ub</span><span class="o">=</span><span class="n">Ab_ub_</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                <span class="p">),</span>
                <span class="o">*</span><span class="n">eq_con</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">Bounds</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="n">lb_</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">),</span>
            <span class="n">options</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;time_limit&quot;</span><span class="p">:</span> <span class="n">time_limit</span><span class="p">,</span>
                <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="n">disp</span><span class="p">,</span>
                <span class="s2">&quot;mip_rel_gap&quot;</span><span class="p">:</span> <span class="n">mip_rel_gap</span><span class="p">,</span>
                <span class="s2">&quot;presolve&quot;</span><span class="p">:</span> <span class="n">presolve</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">mip_gap</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> using MILP results with </span><span class="si">{</span><span class="n">r</span><span class="o">.</span><span class="n">mip_gap</span><span class="si">=}</span><span class="s2"> after </span><span class="si">{</span><span class="n">time_limit</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_frame</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;icx_genid&quot;</span><span class="p">,</span> <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">]]</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">presolve</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> MILP failed with </span><span class="si">{</span><span class="n">presolve</span><span class="si">=}</span><span class="s2"> -&gt; trying again with False &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(known bug in HIGHS https://github.com/scipy/scipy/issues/18907)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp_scipy</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">Ab_eq</span><span class="o">=</span><span class="n">Ab_eq</span><span class="p">,</span>
                <span class="n">Ab_ub</span><span class="o">=</span><span class="n">Ab_ub</span><span class="p">,</span>
                <span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
                <span class="n">wind_lb</span><span class="o">=</span><span class="n">wind_lb</span><span class="p">,</span>
                <span class="n">mip_rel_gap</span><span class="o">=</span><span class="n">mip_rel_gap</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                <span class="n">presolve</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">wind_lb</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> MILP failed with </span><span class="si">{</span><span class="n">wind_lb</span><span class="si">=}</span><span class="s2"> -&gt; trying again with </span><span class="si">{</span><span class="n">wind_lb</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">milp_scipy</span><span class="p">(</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span>
                <span class="n">Ab_eq</span><span class="o">=</span><span class="n">Ab_eq</span><span class="p">,</span>
                <span class="n">Ab_ub</span><span class="o">=</span><span class="n">Ab_ub</span><span class="p">,</span>
                <span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span>
                <span class="n">wind_lb</span><span class="o">=</span><span class="n">wind_lb</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                <span class="n">mip_rel_gap</span><span class="o">=</span><span class="n">mip_rel_gap</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                <span class="n">presolve</span><span class="o">=</span><span class="n">presolve</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">message</span></div>


<div class="viewcode-block" id="BA.make_cfl">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.make_cfl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_cfl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BAScenario</span><span class="p">:</span>
        <span class="n">cfl</span> <span class="o">=</span> <span class="n">BAScenario</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">BAScenario</span><span class="p">)</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">ba</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">cfl</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">is_max_scen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">to_replace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">patio_chunks</span> <span class="o">=</span> <span class="n">MTDF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">MTDF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># cfl.colo_dir = CACHE_PATH / datetime.now().strftime(&quot;%Y%m%d%H%M%S&quot;)</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ScenarioConfig</span><span class="p">(</span>
            <span class="n">re_energy</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">nuclear_scen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">storage_li_pct</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">storage_fe_pct</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">storage_h2_pct</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">ccs_scen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">re_cap</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">((</span><span class="s2">&quot;onshore_wind&quot;</span><span class="p">,</span> <span class="s2">&quot;solar&quot;</span><span class="p">,</span> <span class="s2">&quot;offshore_wind&quot;</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">capacity_mw</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;re_type == &#39;y&#39;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># if self.old_clean_adj_net_load:</span>
        <span class="n">re_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_spec_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">re_profs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">]</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">es_specs</span> <span class="o">=</span> <span class="n">cfl</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_specs</span><span class="p">(</span>
            <span class="n">capacity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">operating_date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
            <span class="n">category</span><span class="o">=</span><span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">re_specs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">re_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">555</span><span class="p">],</span>
                    <span class="s2">&quot;generator_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;solar&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Solar Photovoltaic&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;operating_date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()],</span>
                    <span class="s2">&quot;retirement_date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">],</span>
                    <span class="s2">&quot;ilr&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;proposed_clean&quot;</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="n">re_profs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">re_specs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">re_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>  <span class="c1"># noqa: C408</span>
            <span class="n">load_profile</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adj_load</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
            <span class="n">re_profiles</span><span class="o">=</span><span class="n">re_profs</span><span class="p">,</span>
            <span class="n">re_plant_specs</span><span class="o">=</span><span class="n">re_specs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     re_kwargs = dict(</span>
        <span class="c1">#         load_profile=self.load,</span>
        <span class="c1">#         re_profiles=pd.concat(</span>
        <span class="c1">#             [self.profiles[self.clean_list], self.old_re_profs], axis=1</span>
        <span class="c1">#         ),</span>
        <span class="c1">#         re_plant_specs=pd.concat(</span>
        <span class="c1">#             [</span>
        <span class="c1">#                 self.plant_data.loc[</span>
        <span class="c1">#                     self.clean_list,</span>
        <span class="c1">#                     [c for c in self.re_spec_cols if c in self.plant_data],</span>
        <span class="c1">#                 ],</span>
        <span class="c1">#                 self.old_re_specs,</span>
        <span class="c1">#             ]</span>
        <span class="c1">#         ),</span>
        <span class="c1">#     )</span>
        <span class="n">re_pids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">re_specs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">))</span>  <span class="c1"># noqa: F841</span>

        <span class="n">dm_kwargs</span> <span class="o">=</span> <span class="n">re_kwargs</span> <span class="o">|</span> <span class="nb">dict</span><span class="p">(</span>  <span class="c1"># noqa: C408</span>
            <span class="c1"># load_profile=self.load,</span>
            <span class="n">dispatchable_specs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fossil_list</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">no_limit</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">prime_mover</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fuel_group</span> <span class="o">==</span> <span class="s2">&quot;natural_gas&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">dispatchable_profiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fossil_list</span><span class="p">],</span>
            <span class="n">dispatchable_cost</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cost_data</span><span class="p">,</span>
            <span class="n">storage_specs</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">cfl</span><span class="o">.</span><span class="n">es_specs</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_list</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;plant_id_eia not in @re_pids&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">reserve</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="c1"># for storage with the same pid as RE, t</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_list</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;plant_id_eia in @re_pids&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">}</span>
                        <span class="o">|</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">reserve</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">),</span>
            <span class="n">config</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marginal_for_startup_rank&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
            <span class="c1"># re_profiles=pd.concat(</span>
            <span class="c1">#     [self.profiles[self.clean_list], self.old_re_profs], axis=1</span>
            <span class="c1"># ),</span>
            <span class="c1"># re_plant_specs=pd.concat(</span>
            <span class="c1">#     [self.plant_data.loc[self.clean_list, :], self.old_re_specs]</span>
            <span class="c1"># ),</span>
        <span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">DispatchModel</span><span class="p">(</span><span class="o">**</span><span class="n">dm_kwargs</span><span class="p">)()</span>
        <span class="n">max_defi</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">system_data</span><span class="o">.</span><span class="n">deficit</span> <span class="o">/</span> <span class="n">dm</span><span class="o">.</span><span class="n">load_profile</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">tot_deficit</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">system_data</span><span class="o">.</span><span class="n">deficit</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">dm</span><span class="o">.</span><span class="n">load_profile</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">max_defi</span> <span class="o">&gt;</span> <span class="mf">0.03</span> <span class="ow">or</span> <span class="n">tot_deficit</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;GT&quot;</span><span class="p">)</span>
            <span class="n">dm_kwargs</span><span class="p">[</span><span class="s2">&quot;dispatchable_specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm_kwargs</span><span class="p">[</span><span class="s2">&quot;dispatchable_specs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">no_limit</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">prime_mover</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fuel_group</span> <span class="o">==</span> <span class="s2">&quot;natural_gas&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">operational_status</span> <span class="o">==</span> <span class="s2">&quot;proposed&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dm</span> <span class="o">=</span> <span class="n">DispatchModel</span><span class="p">(</span><span class="o">**</span><span class="n">dm_kwargs</span><span class="p">)()</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dmax</span><span class="p">,</span> <span class="n">dcount</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">system_level_summary</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;deficit&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">set_metadata</span><span class="p">(</span><span class="s2">&quot;re_limits_dispatch&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_defi</span> <span class="o">:=</span> <span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">system_data</span><span class="o">.</span><span class="n">deficit</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">augmented_load</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mf">0.06</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span>
                <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;EPE&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;SC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;TEPC&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;WACM&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;LDWP&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;PSCO&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;APS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;177&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;colo_techs&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> counterfactual max deficit is </span><span class="si">%.1f</span><span class="s2"> percent &quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span>
                    <span class="n">max_defi</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ScenarioError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;counterfactual max deficit is </span><span class="si">{</span><span class="n">max_defi</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">, it was expected to &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;be less than 6%, this BA will not be in results&quot;</span>
                <span class="p">)</span>

        <span class="n">cfl</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="p">(</span><span class="n">dm</span><span class="p">,)</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">no_limit_prime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">_outputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">colo_hourly</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">()</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">colo_coef_ts</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">()</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">colo_coef_mw</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">()</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">colo_summary</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">colo_techs</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;colo_techs&quot;</span><span class="p">]:</span>
            <span class="n">cfl</span><span class="o">.</span><span class="n">setup_colo_data</span><span class="p">(</span><span class="n">colo_techs</span><span class="p">)</span>

        <span class="n">cfl</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cfl</span><span class="o">.</span><span class="n">good_scenario</span> <span class="o">=</span> <span class="n">dmax</span> <span class="o">&lt;=</span> <span class="mf">0.15</span> <span class="ow">and</span> <span class="n">dcount</span> <span class="o">&lt;=</span> <span class="mi">87</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;to_replace&quot;</span><span class="p">,</span> <span class="s2">&quot;mothball&quot;</span><span class="p">,</span> <span class="s2">&quot;exclude&quot;</span><span class="p">,</span> <span class="s2">&quot;ccs&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cfl</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="n">cfl</span></div>


    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="BA.fossil_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.fossil_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fossil_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category.str.contains(&#39;fossil&#39;)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="BA.clean_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.clean_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;category.str.contains(&#39;clean&#39;) &amp; technology_description not in @ES_TECHS&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="p">)</span></div>


    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="BA.storage_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.storage_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">storage_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;technology_description in @ES_TECHS&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="BA._dzsetstate_">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._dzsetstate_">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_dzsetstate_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">to_fix</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;baseload_replace&quot;</span><span class="p">,</span> <span class="s2">&quot;ccs_convert&quot;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_fix</span><span class="p">,</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">to_fix</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ScenarioConfig</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;scenario_configs&quot;</span><span class="p">)]</span>
        <span class="n">has_scens</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_metadata&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;has_scens&quot;</span><span class="p">)</span>
        <span class="c1"># counterfactual = state.pop(&quot;cfl&quot;)</span>
        <span class="n">scenarios_data</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;scenarios_data&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">attr</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;augmented_load&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">augmented_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span>

        <span class="c1"># The ones we use have lots of duplication that we want to avoid saving, so we</span>
        <span class="c1"># recreate the full version here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_profiles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_prof_ilr_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_re_profiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual</span><span class="p">:</span> <span class="n">BAScenario</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_cfl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">has_scens</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">scenarios_data</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rebuild scenarios </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">BAScenario</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">BAScenario</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_dzsetstate_</span><span class="p">({</span><span class="s2">&quot;ba&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span> <span class="o">|</span> <span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>


<div class="viewcode-block" id="BA._dzgetstate_">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._dzgetstate_">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_dzgetstate_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">df_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parquet_out</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">df_out</span> <span class="o">:=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df_name</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;prof&quot;</span> <span class="ow">in</span> <span class="n">df_name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df_out</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">df_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="n">df_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span>

        <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;_metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">,</span>
                    <span class="s2">&quot;has_scens&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">),</span>
                <span class="p">},</span>
                <span class="s2">&quot;baseload_replace&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseload_replace</span><span class="p">,</span>
                <span class="s2">&quot;ccs_convert&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs_convert</span><span class="p">,</span>
                <span class="s2">&quot;scenario_configs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">,</span>
                <span class="s2">&quot;include_figs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_figs</span><span class="p">,</span>
                <span class="c1"># &quot;cfl&quot;: self.counterfactual.__getstate__(),</span>
                <span class="s2">&quot;exclude&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude</span><span class="p">,</span>
                <span class="s2">&quot;exclude_or_mothball&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_or_mothball</span><span class="p">,</span>
                <span class="s2">&quot;max_re&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_re</span><span class="p">,</span>
                <span class="s2">&quot;no_limit_prime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_limit_prime</span><span class="p">,</span>
                <span class="s2">&quot;re_limits_dispatch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_limits_dispatch</span><span class="p">,</span>
                <span class="s2">&quot;max_energy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_energy</span><span class="p">,</span>
                <span class="c1"># &quot;old_clean_adj_net_load&quot;: self.old_clean_adj_net_load,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_full_output&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_output</span><span class="p">(),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_allocated_output&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocated_output</span><span class="p">(),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_system_output&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_output</span><span class="p">(),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">(),</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_monthly_fuel&quot;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">monthly_fuel</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;colo_summary&quot;</span><span class="p">,</span>
                <span class="s2">&quot;colo_hourly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;colo_coef_ts&quot;</span><span class="p">,</span>
                <span class="c1"># &quot;colo_coef_ts_iter&quot;,</span>
                <span class="s2">&quot;colo_coef_mw&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">state</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">attr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;diagonal_relaxed&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> output </span><span class="si">%s</span><span class="s2"> failed </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

            <span class="n">scens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Output scens </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">position</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">leave</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">scens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scen</span><span class="o">.</span><span class="n">_dzgetstate_</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;serializing </span><span class="si">%s</span><span class="s2"> failed </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">scen</span><span class="p">),</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;scenarios_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scens</span>
        <span class="k">return</span> <span class="n">state</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.scenarios">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.scenarios">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">BAScenario</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">scen</span> <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="k">if</span> <span class="n">scen</span><span class="o">.</span><span class="n">good_scenario</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.bad_scenarios">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.bad_scenarios">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bad_scenarios</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="n">ScenarioConfig</span><span class="p">,</span> <span class="n">BAScenario</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">scen</span><span class="o">.</span><span class="n">config</span><span class="p">:</span> <span class="n">scen</span> <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">scen</span><span class="o">.</span><span class="n">good_scenario</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{}</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.ba_code">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.ba_code">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ba_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">]</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.name">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="BA.messages">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.messages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">messages</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">ba_note</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
        <span class="p">)</span></div>

        <span class="c1"># return pd.DataFrame(</span>
        <span class="c1">#     {</span>
        <span class="c1">#         &quot;msg&quot;: [&quot;, &quot;.join(x.msg) for x in self],</span>
        <span class="c1">#         &quot;ba_code&quot;: [self.ba_code for _ in self],</span>
        <span class="c1">#         &quot;scenario&quot;: [</span>
        <span class="c1">#             (&quot;counterfactual&quot; if x.cfl else x.config.for_idx) for x in self</span>
        <span class="c1">#         ],</span>
        <span class="c1">#     }</span>
        <span class="c1"># ).set_index([&quot;ba_code&quot;, &quot;scenario&quot;])</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.ba_name">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.ba_name">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ba_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">)&quot;</span></div>


<div class="viewcode-block" id="BA.align_profiles">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.align_profiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">re_profiles</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sometimes CEMS and RE profiles have different begin/end dates or are missing hours</span>
<span class="sd">        this method selects the common interval for each profile and fills missing hours</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">re_profiles</span> <span class="o">=</span> <span class="n">re_profiles</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">begin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">re_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">)</span>
        <span class="n">all_dates</span> <span class="o">=</span> <span class="n">re_profiles</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upsample</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">every</span><span class="o">=</span><span class="s2">&quot;1h&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_dates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">re_len</span><span class="p">:</span>
            <span class="n">re_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re_profiles</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;__&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
            <span class="n">mo_hr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>  <span class="c1"># noqa: C408</span>
                <span class="n">month</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">(),</span> <span class="n">hour</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">({</span><span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">all_dates</span><span class="o">.</span><span class="n">to_series</span><span class="p">()})</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">not_</span><span class="p">())</span>
                <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="o">**</span><span class="n">mo_hr</span><span class="p">)</span>
                <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">re_profiles</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="o">**</span><span class="n">mo_hr</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="o">*</span><span class="n">re_cols</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Float32</span><span class="p">)),</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">re_cols</span><span class="p">)</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">re_profiles</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">re_profiles</span><span class="p">,</span> <span class="n">missing</span><span class="p">])</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">re_len</span><span class="p">:</span>
            <span class="c1"># this shouldn&#39;t really happen</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> RE data is not continuous, filling missing values with month/hour averages&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">profiles</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">re_profiles</span><span class="p">):</span>
            <span class="c1"># some of our processing can result in hours that have all nans in them being dropped</span>
            <span class="c1"># also, it&#39;s possible that issues with the underlying CEMS data means that hours are</span>
            <span class="c1"># missing, this is more likley to occur in BAs with few plants</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> CEMS is not continuous, filling missing values with 0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span>
            <span class="p">)</span>
            <span class="n">profiles</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">re_profiles</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profiles</span><span class="p">,</span> <span class="n">re_profiles</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BA.co2_profile">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.co2_profile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">co2_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">lyear</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_co2_profile</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lyear</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">lyear</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">big_adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_co2_profile</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_co2_profile</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;YS&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intensity</span> <span class="o">*</span> <span class="n">big_adj</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span></div>


<div class="viewcode-block" id="BA.run_all_scens">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.run_all_scens">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_all_scens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_config</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">24</span>
        <span class="n">max_re_config</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">re_energy</span><span class="p">,</span>
                <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">nuclear_scen</span><span class="p">,</span>
                <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">ccs_scen</span><span class="p">,</span>
                <span class="n">x</span><span class="o">.</span><span class="n">storage_li_pct</span><span class="p">,</span>
                <span class="n">x</span><span class="o">.</span><span class="n">storage_fe_pct</span><span class="p">,</span>
                <span class="n">x</span><span class="o">.</span><span class="n">storage_h2_pct</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">for_loop</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span>
                <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">max_re_config</span><span class="p">])</span> <span class="o">|</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">))</span>
            <span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Run scens </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_config</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">),</span>
            <span class="n">position</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">leave</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">_i</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">for_loop</span><span class="p">:</span>
            <span class="n">for_loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Run scens </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">:</span><span class="s2">12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_config</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">scen</span> <span class="o">=</span> <span class="n">BAScenario</span><span class="p">(</span><span class="n">ba</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
                    <span class="n">scen</span><span class="o">.</span><span class="n">is_max_scen</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                        <span class="n">scen</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;combi_id&quot;</span><span class="p">,</span> <span class="s2">&quot;capacity_mw&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;capacity_max_re_scen&quot;</span><span class="p">}</span>
                        <span class="p">),</span>
                        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;combi_id&quot;</span><span class="p">,</span>
                        <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Ab</span> <span class="o">=</span> <span class="n">make_core_lhs_rhs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scen</span> <span class="o">=</span> <span class="n">BAScenario</span><span class="p">(</span><span class="n">ba</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scen</span><span class="o">.</span><span class="n">is_duplicate_scen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">ScenarioError</span><span class="p">(</span><span class="s2">&quot;Scenario is a duplicate&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">ScenarioError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">for_idx</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scen</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">colo_techs</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;colo_techs&quot;</span><span class="p">]):</span>
                    <span class="n">scen</span><span class="o">.</span><span class="n">setup_colo_data</span><span class="p">(</span><span class="n">colo_techs</span><span class="p">)</span>

        <span class="c1"># the max scenarios chunks were originally calculated before its parent was</span>
        <span class="c1"># created, so we need to re-calculate them here at the end</span>
        <span class="n">no_rechunk</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">is_max_scen</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">rechunk_patio_clean</span><span class="p">()</span>
                <span class="n">no_rechunk</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">no_rechunk</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> no successful max_scen to rechunk, scens=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="p">,</span>
                <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">for_idx</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
        <span class="k">assert</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="BA.parent_re_scenario">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.parent_re_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parent_re_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scen</span><span class="p">:</span> <span class="n">BAScenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BAScenario</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>  <span class="c1"># noqa: SIM102</span>
            <span class="k">if</span> <span class="n">pars</span> <span class="o">:=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_re_child</span><span class="p">(</span><span class="n">scen</span><span class="o">.</span><span class="n">config</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">re_energy</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BA.parent_li_scenario">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.parent_li_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">parent_li_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scen</span><span class="p">:</span> <span class="n">BAScenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BAScenario</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>  <span class="c1"># noqa: SIM102</span>
            <span class="k">if</span> <span class="n">pars</span> <span class="o">:=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">is_li_child</span><span class="p">(</span><span class="n">scen</span><span class="o">.</span><span class="n">config</span><span class="p">)]:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">storage_li_pct</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">re_energy</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BA.same_energy_scenario">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.same_energy_scenario">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">same_energy_scenario</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scen</span><span class="p">:</span> <span class="n">BAScenario</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BAScenario</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p_scen</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="n">scen</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p_scen</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;re_energy&quot;</span><span class="p">,</span> <span class="s2">&quot;nuclear_scen&quot;</span><span class="p">,</span> <span class="s2">&quot;ccs_scen&quot;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span> <span class="n">p_scen</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BA.hourly_adjustment">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.hourly_adjustment">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hourly_adjustment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hourly adjustment to ~normalize plant roles across years&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">profile_check</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">plant_role</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">base</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">base</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                <span class="n">mid</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">mid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">mid</span><span class="p">,</span>
                <span class="n">peaker</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">peaker</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">peaker</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">})</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;ffill&quot;</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">plant_role</span><span class="p">]</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BA.profile_check">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.profile_check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">profile_check</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mapper</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">multiindex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate profiles using ``mapper_for_col_group`` and to annual frequency</span>

<span class="sd">        Args:</span>
<span class="sd">            df: profiles to check, if None, use self.profiles</span>
<span class="sd">            mapper: map (plant_id_eia, generator_id) -&gt; &quot;x&quot; | (&quot;x&quot;, &quot;y&quot;, ...)</span>
<span class="sd">            multiindex: if you want to groupby multiple levels, set to True and make sure</span>
<span class="sd">                (plant_id_eia, generator_id) map to equal length tuples</span>
<span class="sd">            norm: normalize the result</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: D414</span>
        <span class="k">if</span> <span class="n">mapper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">plant_role</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">mapper</span><span class="p">)]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="p">[</span><span class="n">mapper</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># prep for and do column renaming</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># noqa: PD011</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">mapper</span><span class="p">)</span>
        <span class="n">for_level</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># turn columns back into multiindex</span>
        <span class="k">if</span> <span class="n">multiindex</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">for_level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)))</span>
            <span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">for_level</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;YS&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">multiindex</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span> <span class="o">/</span> <span class="n">out</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BA.full_output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.full_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">full_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">full_output</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
        <span class="c1"># create historical data as a scenario with re_energy = -1.0</span>
        <span class="n">not_hist_cats</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># noqa: F841</span>
            <span class="s2">&quot;old_clean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;proposed_fossil&quot;</span><span class="p">,</span>
            <span class="s2">&quot;proposed_other&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual</span><span class="o">.</span><span class="n">full_output</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category not in @not_hist_cats&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">re_energy</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">scenario</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span>
                <span class="n">redispatch_curt_adj_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span> <span class="k">if</span> <span class="s2">&quot;redispatch&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">hist</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;historical&quot;</span><span class="p">,</span> <span class="s2">&quot;redispatch&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">hist</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1"># x = original.reset_index().query(</span>
        <span class="c1">#     &quot;category == &#39;patio_clean&#39; &quot;</span>
        <span class="c1">#     &quot;&amp; technology_description not in (&#39;Batteries&#39;, &#39;H2 Storage&#39;) &quot;</span>
        <span class="c1">#     &quot;&amp; datetime.dt.year == 2030&quot;</span>
        <span class="c1"># ).sort_values([&#39;plant_id_eia&#39;, &#39;scenario_add&#39;])</span>
        <span class="c1"># y = x.pivot(</span>
        <span class="c1">#     index=[&quot;plant_id_eia&quot;, &#39;scenario_add&#39;, &quot;generator_id&quot;],</span>
        <span class="c1">#     columns=&quot;scenario&quot;,</span>
        <span class="c1">#     values=&quot;capacity_mw&quot;,</span>
        <span class="c1"># )</span>
        <span class="n">icx_rn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;icx_id&quot;</span><span class="p">:</span> <span class="s2">&quot;associated_plant_id&quot;</span><span class="p">,</span> <span class="s2">&quot;icx_gen&quot;</span><span class="p">:</span> <span class="s2">&quot;associated_generator_id&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hist</span><span class="p">,</span> <span class="n">original</span><span class="p">])[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">original</span> <span class="k">if</span> <span class="s2">&quot;historical&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;redispatch_co2&quot;</span><span class="p">:</span> <span class="s2">&quot;redispatch_co2_tonne&quot;</span><span class="p">})</span>
            <span class="c1"># .drop(columns=[c for c in original if &quot;historical&quot; in c])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">ccs_eligible</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
                <span class="o">.</span><span class="n">droplevel</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccs_convert</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">historical_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="p">[</span><span class="s2">&quot;year_mapper&quot;</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">re_plant_specs</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;icx_id&quot;</span><span class="p">,</span> <span class="s2">&quot;icx_gen&quot;</span><span class="p">]],</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">icx_rn</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BA._is_ccs_ix">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA._is_ccs_ix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_is_ccs_ix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Is the index a row for a CCS plant in a CCS scenario&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ccs_scen</span> <span class="o">:=</span> <span class="n">ix</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">ix</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccs_convert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ccs_scen</span><span class="p">),</span> <span class="p">[]):</span>  <span class="c1"># noqa: SIM103</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="BA.system_output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.system_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">system_output</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">system_output</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counterfactual</span><span class="o">.</span><span class="n">system_output</span><span class="p">(</span><span class="n">variant</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">re_energy</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="s2">&quot;historical&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">original</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">r_base_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;patio&quot;</span><span class="p">,</span> <span class="s2">&quot;proposed&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">CLEAN_TD_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">OTHER_TD_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">full</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">suff</span> <span class="k">for</span> <span class="n">suff</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;_mwh&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">r_base_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="o">+</span> <span class="n">suff</span> <span class="ow">in</span> <span class="n">hist</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">hist</span><span class="p">[[</span><span class="o">*</span><span class="n">ScenarioConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="o">*</span><span class="n">full</span><span class="p">]],</span> <span class="n">original</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span>
            <span class="n">original</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span></div>


<div class="viewcode-block" id="BA.allocated_output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.allocated_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">allocated_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">allocated_output</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="BA.get_figs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.get_figs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">figdir</span> <span class="o">=</span> <span class="n">PATIO_DOC_PATH</span> <span class="o">/</span> <span class="s2">&quot;figs&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">figdir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">figdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">pypdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfWriter</span>

        <span class="k">with</span> <span class="p">(</span>
            <span class="n">logging_redirect_tqdm</span><span class="p">(),</span>
            <span class="n">PdfWriter</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">figdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_mwh_ms.pdf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">merger1</span><span class="p">,</span>
            <span class="n">PdfWriter</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">figdir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_daily.pdf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">merger2</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">for_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_code</span><span class="si">}</span><span class="s2"> Figs&quot;</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">scen</span> <span class="ow">in</span> <span class="n">for_tqdm</span><span class="p">:</span>
                <span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">f3</span><span class="p">,</span> <span class="n">f4</span> <span class="o">=</span> <span class="n">scen</span><span class="o">.</span><span class="n">get_figs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">f3</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                <span class="n">f1</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">temp1</span> <span class="o">:=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                <span class="n">f2</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">temp2</span> <span class="o">:=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                <span class="n">f3</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">f3</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot; re_limits_dispatch&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">temp3</span> <span class="o">:=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                <span class="n">f4</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">f4</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">+</span> <span class="s2">&quot; re_limits_dispatch&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">temp4</span> <span class="o">:=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                <span class="n">merger1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp1</span><span class="p">)</span>
                <span class="n">merger2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp2</span><span class="p">)</span>
                <span class="n">merger1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp3</span><span class="p">)</span>
                <span class="n">merger2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp4</span><span class="p">)</span></div>


<div class="viewcode-block" id="BA.__len__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.__len__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="BA.__iter__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.__iter__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">counterfactual</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">])</span></div>


<div class="viewcode-block" id="BA.__getitem__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BAScenario</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scenarios</span><span class="p">[</span><span class="n">item</span><span class="p">]</span></div>


<div class="viewcode-block" id="BA.__repr__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BA.make_dm_mini">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BA.make_dm_mini">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_dm_mini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">years</span><span class="o">=</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">2030</span><span class="p">)):</span>
        <span class="n">f_year</span><span class="p">,</span> <span class="n">l_year</span> <span class="o">=</span> <span class="n">years</span>
        <span class="n">d_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fossil_list</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;(operating_date &lt;= @l_year | operating_date.isna())&quot;</span>
            <span class="s2">&quot;&amp; (retirement_date &gt;= @f_year | retirement_date.isna())&quot;</span>
        <span class="p">)</span>
        <span class="n">d_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f_year</span><span class="p">)</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">l_year</span><span class="p">),</span> <span class="n">d_s</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">r_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">clean_list</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;(operating_date &lt;= @l_year | operating_date.isna())&quot;</span>
            <span class="s2">&quot;&amp; (retirement_date &gt;= @f_year | retirement_date.isna())&quot;</span>
        <span class="p">)</span>
        <span class="n">l_period</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l_year</span><span class="si">}</span><span class="s2">-12-31&quot;</span>  <span class="c1"># noqa: F841</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;load_profile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_p</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;dispatchable_specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_s</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;dispatchable_profiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d_p</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;dispatchable_cost&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_data</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">d_s</span><span class="o">.</span><span class="n">index</span><span class="p">],</span> <span class="p">:</span>
            <span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;datetime &gt;= @f_year &amp; datetime &lt;= @l_period&quot;</span><span class="p">)</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;storage_specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plant_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_list</span><span class="p">,</span> <span class="p">:]</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;(operating_date &lt;= @l_year | operating_date.isna())&quot;</span>
                    <span class="s2">&quot;&amp; (retirement_date &gt;= @f_year | retirement_date.isna())&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">roundtrip_eff</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                    <span class="n">duration_hrs</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">energy_storage_capacity_mwh</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;re_plant_specs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_s</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;re_profiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiles</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f_year</span><span class="p">)</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">l_year</span><span class="p">),</span> <span class="n">r_s</span><span class="o">.</span><span class="n">index</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="BAs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BAs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;scalene patio/model/ba_level.py --profile-only &#39;ba_level,model&#39; --profile-all&quot;&quot;&quot;</span>

<div class="viewcode-block" id="BAs.def_scen_configs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.def_scen_configs">[docs]</a>
    <span class="n">def_scen_configs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span>
            <span class="c1"># ScenarioConfig.from_sweeps(</span>
            <span class="c1">#     re=[0.6],</span>
            <span class="c1">#     # nuke=[0, 1],</span>
            <span class="c1">#     li=[0.25],</span>
            <span class="c1"># )</span>
            <span class="n">ScenarioConfig</span><span class="o">.</span><span class="n">from_sweeps</span><span class="p">(</span>
                <span class="n">re</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                <span class="c1"># nuke=[0, 1],</span>
                <span class="n">li</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">ScenarioConfig</span><span class="o">.</span><span class="n">from_sweeps</span><span class="p">(</span>
                <span class="n">re</span><span class="o">=</span><span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
                <span class="c1"># nuke=[0, 1],</span>
                <span class="n">li</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># + ScenarioConfig.from_sweeps(</span>
            <span class="c1">#     re=[0.25],</span>
            <span class="c1">#     nuke=[0, 1],</span>
            <span class="c1">#     li=[0.25],</span>
            <span class="c1"># )</span>
            <span class="c1"># + ScenarioConfig.from_sweeps(</span>
            <span class="c1">#     re=[0.25],</span>
            <span class="c1">#     li=[0.25],</span>
            <span class="c1">#     ccs=[0, 1],</span>
            <span class="c1"># ),</span>
        <span class="p">)</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="BAs.bad_bas">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.bad_bas">[docs]</a>
    <span class="n">bad_bas</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Alaska&quot;</span><span class="p">,</span> <span class="s2">&quot;HECO&quot;</span><span class="p">,</span> <span class="s2">&quot;NBSO&quot;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">bas</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">profile_data</span><span class="p">:</span> <span class="n">ProfileData</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scenario_configs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ScenarioConfig</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">regime</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;reference&quot;</span><span class="p">,</span> <span class="s2">&quot;limited&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reference&quot;</span><span class="p">,</span>
        <span class="n">solar_ilr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.34</span><span class="p">,</span>
        <span class="n">data_kwargs</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pudl_release</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">PATIO_PUDL_RELEASE</span><span class="p">,</span>
        <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">alt_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">econ_scen_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">econ_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;BAs_&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
<div class="viewcode-block" id="BAs.pudl_release">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.pudl_release">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span> <span class="o">=</span> <span class="n">pudl_release</span></div>

<div class="viewcode-block" id="BAs.datetime">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.datetime">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BAs.alt_path">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.alt_path">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_path</span> <span class="o">=</span> <span class="n">alt_path</span></div>

<div class="viewcode-block" id="BAs.econ_suffix">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_suffix">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">econ_suffix</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">econ_suffix</span><span class="o">.</span><span class="n">removeprefix</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">econ_suffix</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="BAs.econ_scen_dir">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_scen_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">econ_scen_dir</span> <span class="o">=</span> <span class="n">econ_scen_dir</span></div>

        <span class="k">if</span> <span class="n">profile_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prod</span> <span class="o">=</span> <span class="n">ProfileData</span><span class="p">(</span>
                <span class="n">AssetData</span><span class="p">(</span><span class="n">pudl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">),</span>
                <span class="n">regime</span><span class="o">=</span><span class="n">regime</span><span class="p">,</span>
                <span class="n">solar_ilr</span><span class="o">=</span><span class="n">solar_ilr</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prod</span> <span class="o">=</span> <span class="n">profile_data</span>
<div class="viewcode-block" id="BAs.data_source">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.data_source">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="o">=</span> <span class="n">data_source</span></div>

        <span class="k">if</span> <span class="n">scenario_configs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">def_scen_configs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="o">=</span> <span class="n">scenario_configs</span>

        <span class="k">if</span> <span class="n">bas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bas</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">all_modelable_generators</span><span class="p">()</span><span class="o">.</span><span class="n">final_ba_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_bas</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bas</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bas</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">all_modelable_generators</span><span class="p">()</span><span class="o">.</span><span class="n">final_ba_code</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No modelable BAs in </span><span class="si">{</span><span class="n">bas</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="BAs.errors">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.errors">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">TracebackException</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;setup&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;run&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;close_re&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">),</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="BAs._dfs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._dfs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span> <span class="o">=</span> <span class="p">{}</span></div>

        <span class="k">if</span> <span class="n">data_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span> <span class="o">=</span> <span class="n">data_kwargs</span>
<div class="viewcode-block" id="BAs.bad_scenarios">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.bad_scenarios">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_scenarios</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span></div>

<div class="viewcode-block" id="BAs.good_objs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.good_objs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span> <span class="o">=</span> <span class="p">[]</span></div>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">%H%M&quot;</span><span class="p">)</span>
        <span class="n">colo_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;patio_data/colo_data_</span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colo_techs&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">colo_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">colo_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">colo_dir</span> <span class="o">/</span> <span class="s2">&quot;colo.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">colo</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;plants&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="s2">&quot;pudl_release&quot;</span><span class="p">:</span> <span class="n">pudl_release</span><span class="p">,</span>
                        <span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
                        <span class="s2">&quot;data_commit&quot;</span><span class="p">:</span> <span class="n">_git_commit_info</span><span class="p">(),</span>
                    <span class="p">},</span>
                    <span class="n">colo</span><span class="p">,</span>
                    <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="p">)</span>
<div class="viewcode-block" id="BAs.colo_dir">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.colo_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">colo_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">colo_dir</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()))</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BAs.dir_path">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.dir_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">dir_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">PATIO_DOC_PATH</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dir_path</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BAs.path">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_path</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BAs.from_cloud">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.from_cloud">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_cloud</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">econ_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;az://patio-results/</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">c_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">AZURE_CACHE_PATH</span> <span class="o">/</span> <span class="n">cached_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;patio-results/</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.zip&quot;</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="n">c_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;solar_ilr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data_kwargs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bas&quot;</span><span class="p">,</span>
                <span class="s2">&quot;by_plant&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data_source&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regime&quot;</span><span class="p">,</span> <span class="s2">&quot;reference&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pudl_release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pudl_release&quot;</span><span class="p">,</span> <span class="n">PATIO_PUDL_RELEASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;data_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_source</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;BAs_</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">profile_data</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_prod&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">alt_path</span><span class="o">=</span><span class="n">c_path</span><span class="p">,</span>
                <span class="n">econ_suffix</span><span class="o">=</span><span class="n">econ_suffix</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;data_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;bas&quot;</span><span class="p">,</span> <span class="s2">&quot;bad_scenarios&quot;</span><span class="p">,</span> <span class="s2">&quot;good_objs&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BAs.from_file">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.from_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">econ_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">PATIO_DOC_PATH</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.zip&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;solar_ilr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data_kwargs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bas&quot;</span><span class="p">,</span>
                <span class="s2">&quot;by_plant&quot;</span><span class="p">,</span>
                <span class="s2">&quot;data_source&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;regime&quot;</span><span class="p">,</span> <span class="s2">&quot;reference&quot;</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pudl_release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pudl_release&quot;</span><span class="p">,</span> <span class="n">PATIO_PUDL_RELEASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;data_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_source</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;BAs_</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">profile_data</span><span class="o">=</span><span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_prod&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">econ_suffix</span><span class="o">=</span><span class="n">econ_suffix</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;data_kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;bas&quot;</span><span class="p">,</span> <span class="s2">&quot;bad_scenarios&quot;</span><span class="p">,</span> <span class="s2">&quot;good_objs&quot;</span><span class="p">,</span> <span class="s2">&quot;errors&quot;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BAs.pd">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.pd">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prod</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BAs.ad">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.ad">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">ad</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prod</span><span class="o">.</span><span class="n">ad</span></div>


<div class="viewcode-block" id="BAs._attrs_to_z">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._attrs_to_z">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_attrs_to_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">DataZip</span><span class="p">):</span>
        <span class="n">z</span><span class="p">[</span><span class="s2">&quot;solar_ilr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">solar_ilr</span>
        <span class="n">z</span><span class="p">[</span><span class="s2">&quot;regime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">regime</span>
        <span class="c1"># z[&quot;setup_errors&quot;] = {</span>
        <span class="c1">#     k: &quot;&quot;.join(v[0].format()) for k, v in self.errors[&quot;setup&quot;].items()</span>
        <span class="c1"># }</span>
        <span class="c1"># z[&quot;run_errors&quot;] = {</span>
        <span class="c1">#     k: &quot;&quot;.join(v[0].format()) for k, v in self.errors[&quot;run&quot;].items()</span>
        <span class="c1"># }</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;data_kwargs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bas&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bad_scenarios&quot;</span><span class="p">,</span>
            <span class="s2">&quot;good_objs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;by_plant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_prod&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pudl_release&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">z</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unable to add </span><span class="si">%s</span><span class="s2"> to DataZip, </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.prep_all_data">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.prep_all_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">logging_redirect_tqdm</span><span class="p">():</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span> <span class="o">+</span> <span class="mi">24</span>
            <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                <span class="n">for_loop</span><span class="p">:</span> <span class="n">Any</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Prep data </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_loop</span><span class="p">:</span>
                    <span class="n">for_loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Prep data </span><span class="si">{</span><span class="n">ba_code</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                        <span class="n">z</span><span class="p">[</span><span class="n">ba_code</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">get_ba_data</span><span class="p">(</span><span class="n">ba_code</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">PatioData</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: G201</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_error_counts</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.run_all">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.run_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span> <span class="o">+</span> <span class="mi">24</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="n">for_loop</span><span class="p">:</span> <span class="n">Any</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Setup+Run </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_loop</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ba_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">with</span> <span class="n">logging_redirect_tqdm</span><span class="p">():</span>
                    <span class="n">for_loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Setup+Run </span><span class="si">{</span><span class="n">ba_code</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span> <span class="ow">and</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">BAD_COLO_BAS</span><span class="p">:</span>
                            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ba_code=</span><span class="si">%s</span><span class="s2"> skipped for colo analysis&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">get_ba_data</span><span class="p">(</span>
                                <span class="n">ba_code</span><span class="p">,</span>
                                <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span><span class="p">,</span>
                                <span class="n">colo_only</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_source</span><span class="p">)</span> <span class="k">as</span> <span class="n">zs</span><span class="p">:</span>
                                <span class="n">data</span> <span class="o">=</span> <span class="n">zs</span><span class="p">[</span><span class="n">ba_code</span><span class="p">]</span>
                    <span class="k">except</span> <span class="n">PatioData</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: G201</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_and_run_helper</span><span class="p">(</span><span class="n">ba_code</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_attrs_to_z</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log_error_counts</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.get_fossils_specs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.get_fossils_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fossils_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">logging_redirect_tqdm</span><span class="p">():</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">)</span>
            <span class="n">for_loop</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Get specs </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_loop</span><span class="p">:</span>
                <span class="n">for_loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Get specs </span><span class="si">{</span><span class="n">ba_code</span><span class="si">:</span><span class="s2">5</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pad</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">get_ba_data</span><span class="p">(</span><span class="n">ba_code</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span><span class="p">)[</span><span class="s2">&quot;plant_data&quot;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">user_documents_path</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;fossil_specs.parquet&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs._setup_and_run_helper">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._setup_and_run_helper">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_and_run_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dz</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">dz</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will be unable to save </span><span class="si">%s</span><span class="s2"> because it was already run&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ba_obj</span> <span class="o">=</span> <span class="n">BA</span><span class="p">(</span>
                <span class="o">**</span><span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_kwargs</span><span class="p">),</span>
                <span class="n">scenario_configs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">,</span>
                <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                <span class="n">colo_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colo_dir</span><span class="p">,</span>
                <span class="n">pudl_release</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ba_code</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">:</span>
                <span class="n">ba_obj</span><span class="o">.</span><span class="n">run_all_scens</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scenario_configs</span><span class="p">:</span>
                <span class="n">dz</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dz</span><span class="p">[</span><span class="n">ba_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">ba_obj</span>
                    <span class="k">for</span> <span class="n">bad_scen</span> <span class="ow">in</span> <span class="n">ba_obj</span><span class="o">.</span><span class="n">bad_scenarios</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bad_scenarios</span><span class="p">[</span><span class="n">bad_scen</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ba_code</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> storing results failed </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;run&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
                <span class="c1"># ba_obj.cleanup()</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="BAs.log_error_counts">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.log_error_counts">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">log_error_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">types</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">etype</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">_errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_errors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">_errors</span><span class="p">:</span>
                <span class="n">error_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">exc_type</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_errors</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
                <span class="n">count_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;(</span><span class="si">{</span>
<span class="w">                    </span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">error_count</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
<span class="w">                </span><span class="si">}</span><span class="s2">)&quot;&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">count_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; ~completed=</span><span class="si">%s</span><span class="s2">, errors=</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">etype</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_errors</span><span class="p">),</span>
                <span class="n">count_str</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.make_profile_figs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.make_profile_figs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_profile_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">bas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extend_cems</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="n">path</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">pypdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfWriter</span>

        <span class="k">with</span> <span class="n">PdfWriter</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">merger</span><span class="p">:</span>  <span class="c1"># noqa: SIM117</span>
            <span class="k">with</span> <span class="n">logging_redirect_tqdm</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">bas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">for_loop</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;All profiles&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">for_loop</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;All profiles&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_loop</span><span class="p">:</span>
                    <span class="n">for_loop</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="s2">&quot;All profiles &quot;</span> <span class="o">+</span> <span class="n">ba_code</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">get_ba_data</span><span class="p">(</span>
                            <span class="n">ba_code</span><span class="p">,</span> <span class="n">re_by_plant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extend_cems</span><span class="o">=</span><span class="n">extend_cems</span>
                        <span class="p">)</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">l</span><span class="p">[</span><span class="s2">&quot;profiles&quot;</span><span class="p">]</span>  <span class="c1"># noqa: PD013</span>
                            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)])</span>
                            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                            <span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                            <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;mwh&quot;</span><span class="p">})</span>
                            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                                <span class="n">l</span><span class="p">[</span><span class="s2">&quot;plant_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                                <span class="n">resource</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">PLOT_MAP</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;resource&quot;</span><span class="p">])</span>
                            <span class="o">.</span><span class="n">mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                                <span class="n">day</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span>
                                <span class="n">month</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="n">z</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%B&quot;</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">dispatch_key</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ba_code</span><span class="p">)</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;plant_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_ba_code</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;plant_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">respondent_name</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>  <span class="c1"># noqa: PD009</span>
                                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;plant_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">balancing_authority_code_eia</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ba_code</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;plant_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">respondent_name</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="si">}</span><span class="s2">)&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;plant_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">balancing_authority_code_eia</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                                <span class="n">q</span><span class="p">,</span>
                                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;day&quot;</span><span class="p">,</span>
                                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;mwh&quot;</span><span class="p">,</span>
                                <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;month&quot;</span><span class="p">,</span>
                                <span class="n">facet_row</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span>
                                <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span><span class="p">,</span>
                                <span class="n">height</span><span class="o">=</span><span class="mi">1750</span><span class="p">,</span>
                                <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span>
                                <span class="n">width</span><span class="o">=</span><span class="mi">1750</span><span class="p">,</span>
                                <span class="n">title</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                                <span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.002</span><span class="p">,</span>
                                <span class="n">facet_col_spacing</span><span class="o">=</span><span class="mf">0.006</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span>
                                <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">update_traces</span><span class="p">(</span>
                                <span class="n">marker_line_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">tempd</span> <span class="o">:=</span> <span class="n">BytesIO</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                        <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempd</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.__getitem__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.__getitem__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BA</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">)[</span><span class="n">item</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">z0</span><span class="p">[</span><span class="n">item</span><span class="p">]</span></div>


<div class="viewcode-block" id="BAs.__repr__">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.__repr__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, working_BAs=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">)</span><span class="si">}</span><span class="s2">, errors=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;output only available after `run_all`&quot;</span><span class="p">)</span>
            <span class="n">df_process</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;BA_full_output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_output_cols</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;allocated_output&quot;</span><span class="p">,</span> <span class="s2">&quot;BA_allocated_output&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_cols</span><span class="p">),</span>
                <span class="p">(</span>
                    <span class="s2">&quot;sys_output&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;BA_system_output&quot;</span><span class="p">,</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;^(?!storage_).*&quot;</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;msg_output&quot;</span><span class="p">,</span> <span class="s2">&quot;BA_messages&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;re_specs_out&quot;</span><span class="p">,</span> <span class="s2">&quot;re_plant_specs_pre_downselect&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;colo_summary&quot;</span><span class="p">,</span> <span class="s2">&quot;BA_colo_summary&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">dfs_</span> <span class="o">=</span> <span class="p">{</span><span class="n">df_</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">df_</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="ow">in</span> <span class="n">df_process</span><span class="p">}</span>
            <span class="n">re_path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;patio_data/re_data_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pd</span><span class="o">.</span><span class="n">regime</span><span class="si">}</span><span class="s2">.zip&quot;</span>
            <span class="k">with</span> <span class="p">(</span>
                <span class="n">logging_redirect_tqdm</span><span class="p">(),</span>
                <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">,</span>
                <span class="n">DataZip</span><span class="p">(</span><span class="n">re_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">re_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="n">nullcontext</span><span class="p">()</span> <span class="k">as</span> <span class="n">z1</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">for_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;FullOutput&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ba_</span> <span class="ow">in</span> <span class="n">for_tqdm</span><span class="p">:</span>
                    <span class="n">for_tqdm</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;FullOutput &quot;</span> <span class="o">+</span> <span class="n">ba_</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">df_</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">df_process</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dfs_</span><span class="p">[</span><span class="n">df_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">ba_</span><span class="p">,</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;BA&quot;</span><span class="p">,</span> <span class="n">ba_</span><span class="p">)])</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">df_</span> <span class="o">==</span> <span class="s2">&quot;re_specs_out&quot;</span> <span class="ow">and</span> <span class="n">z1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">dfs_</span><span class="p">[</span><span class="n">df_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z1</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ba_</span><span class="si">}</span><span class="s2">_meta&quot;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs_</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Loading RE from </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">re_path</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">df_</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="n">ba_</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                                <span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">df_process</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="s2">&quot;colo_summary&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dfs_</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs_</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;diagonal_relaxed&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs_</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unable to concatenate </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="c1"># bad_bas = (</span>
            <span class="c1">#         self.summary((</span>
            <span class="c1">#     self._dfs[&quot;output&quot;],</span>
            <span class="c1">#     self._dfs[&quot;allocated_output&quot;],</span>
            <span class="c1">#     self._dfs[&quot;sys_output&quot;],</span>
            <span class="c1"># ))</span>
            <span class="c1">#         .query(</span>
            <span class="c1">#             &quot;scenario == &#39;counterfactual&#39; &amp; deficit_max_pct_net_load &gt;= 0.06&quot;</span>
            <span class="c1">#         )</span>
            <span class="c1">#         .ba_code</span>
            <span class="c1"># )</span>
            <span class="c1"># for n, *_ in df_process:</span>
            <span class="c1">#     if n not in self._dfs:</span>
            <span class="c1">#         continue</span>
            <span class="c1">#     if n == &quot;colo_summary&quot;:</span>
            <span class="c1">#         self._dfs[n] = self._dfs[n].with_columns(ba_high_cfl_deficit=pl.col(&#39;ba_code&#39;).is_in(bad_bas))</span>
            <span class="c1">#</span>
            <span class="c1">#     elif &quot;ba_code&quot; in self._dfs[n].index.names:</span>
            <span class="c1">#         self._dfs[n] = self._dfs[n].assign(</span>
            <span class="c1">#             ba_high_cfl_deficit=lambda x: x.index.get_level_values(</span>
            <span class="c1">#                 &quot;ba_code&quot;</span>
            <span class="c1">#             ).isin(bad_bas)</span>
            <span class="c1">#         )</span>
            <span class="c1">#     elif &quot;ba_code&quot; in self._dfs[n].columns:</span>
            <span class="c1">#         self._dfs[n] = self._dfs[n].assign(</span>
            <span class="c1">#             ba_high_cfl_deficit=lambda x: x.ba_code.isin(bad_bas)</span>
            <span class="c1">#         )</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;allocated_output&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;sys_output&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.fuel_curve_comparison">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.fuel_curve_comparison">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fuel_curve_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;fuel_output&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">:</span>
            <span class="n">fuel_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">logging_redirect_tqdm</span><span class="p">(),</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">:</span>
                <span class="n">for_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;FuelOutput&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_tqdm</span><span class="p">:</span>
                    <span class="n">for_tqdm</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;FuelOutput &quot;</span> <span class="o">+</span> <span class="n">ba_code</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fuel_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">ba_code</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">_monthly_fuel&quot;</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;fuel_output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">fuel_out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">fuel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;fuel_output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">series_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;curve_fuel_price&quot;</span><span class="p">:</span> <span class="s2">&quot;linear_area&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;curve_fuel_price_exp&quot;: &quot;exponential&quot;,</span>
            <span class="c1"># &quot;curve_fuel_price_lin&quot;: &quot;linear&quot;,</span>
            <span class="s2">&quot;fuel_per_mmbtu&quot;</span><span class="p">:</span> <span class="s2">&quot;original&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">curve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">curve</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">fuel</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">expanded_curve</span> <span class="o">=</span> <span class="p">[</span><span class="n">curve</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fuel</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="s2">&quot;scenario&quot;</span><span class="p">)]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">fuel</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">series_map</span><span class="p">)</span>
                <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
                    <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;re_limits_dispatch&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;mthly_mmbtu&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;cumsum_mmbtu&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;pct_of_curve_mmbtu_max&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;heat_rate&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">value_vars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">series_map</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                    <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;series&quot;</span><span class="p">,</span>
                    <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;final_fuel_cost_per_mmbtu&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="o">*</span><span class="n">expanded_curve</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="s2">&quot;final_fuel_cost_per_mmbtu&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BAs._add_missing_cols">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._add_missing_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_missing_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;redispatch_mmbtu&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_co2&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_fuel&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_vom&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_startup&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">missing</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">})</span></div>


<div class="viewcode-block" id="BAs._add_missing_output_cols">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._add_missing_output_cols">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_add_missing_output_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">capex</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="o">*</span><span class="n">cols</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])[</span>
                    <span class="p">[</span><span class="s2">&quot;capex_per_kw&quot;</span><span class="p">,</span> <span class="s2">&quot;real_maint_capex_per_kw&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">last</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">]],</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">technology_description</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">technology_description_r</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;technology_description_r&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="BAs.update_trace">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.update_trace">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_trace</span><span class="p">(</span><span class="n">trc</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;selected&quot;</span> <span class="ow">in</span> <span class="n">trc</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;Selected sites&quot;</span><span class="p">,</span>
                <span class="n">legendgrouptitle_text</span><span class="o">=</span><span class="s2">&quot;Selected sites&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">trc</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; selected&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;Fossil&quot;</span> <span class="ow">in</span> <span class="n">trc</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;Fossil&quot;</span><span class="p">,</span>
                <span class="n">legendgrouptitle_text</span><span class="o">=</span><span class="s2">&quot;Existing&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">legendgroup</span><span class="o">=</span><span class="s2">&quot;Potential sites&quot;</span><span class="p">,</span>
                <span class="n">legendgrouptitle_text</span><span class="o">=</span><span class="s2">&quot;Potential sites&quot;</span><span class="p">,</span>
                <span class="c1"># opacity=0.5</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.make_all_maps">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.make_all_maps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_all_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">econ_select</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">re_energy</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">storage_li_pct</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2035</span><span class="p">):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pypdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfWriter</span>

        <span class="k">with</span> <span class="p">(</span>
            <span class="n">logging_redirect_tqdm</span><span class="p">(),</span>
            <span class="n">PdfWriter</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">PATIO_DOC_PATH</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;figs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_maps.pdf&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">merger</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">for_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Maps&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_tqdm</span><span class="p">:</span>
                <span class="n">for_tqdm</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Maps &quot;</span> <span class="o">+</span> <span class="n">ba_code</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_potential_selected_maps</span><span class="p">(</span>
                        <span class="n">ba</span><span class="o">=</span><span class="n">ba_code</span><span class="p">,</span>
                        <span class="n">econ_select</span><span class="o">=</span><span class="n">econ_select</span><span class="p">,</span>
                        <span class="n">re_energy</span><span class="o">=</span><span class="n">re_energy</span><span class="p">,</span>
                        <span class="n">storage_li_pct</span><span class="o">=</span><span class="n">storage_li_pct</span><span class="p">,</span>
                        <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.make_potential_selected_maps">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.make_potential_selected_maps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_potential_selected_maps</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ba</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">owners</span><span class="p">:</span> <span class="n">Sequence</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2031</span><span class="p">,</span>
        <span class="n">selected</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># noqa: FBT001</span>
        <span class="n">potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># noqa: FBT001</span>
        <span class="n">fossil</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># noqa: FBT001</span>
        <span class="n">sensitivity</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">size_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">subunitwidth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
<span class="sd">            ba: a patio BA code, a sequence of BA codes, or None to get all BAs</span>
<span class="sd">            owners: generation owners, if provided, ba is ignored</span>
<span class="sd">            year: year of econ selected to show</span>
<span class="sd">            selected: include selected sites</span>
<span class="sd">            potential: include all potential sites</span>
<span class="sd">            fossil: include fossil sites</span>
<span class="sd">            sensitivity: one or more sensitivities to display, by default all are displayed</span>
<span class="sd">            size_max: (default=6) max marker size, adjust for visual consistency</span>
<span class="sd">            subunitwidth: (default=1) control the width of state boundaries, can need</span>
<span class="sd">                to be increased to ~4 if vector versions will be resized</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: D414</span>
        <span class="n">fos</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">ba</span>

        <span class="n">re</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">econ_selected_allocated</span><span class="p">()</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;datetime.dt.year == @year &amp; technology_description != &#39;Batteries&#39;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">re_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Solar Photovoltaic&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Offshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Offshore Wind&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Onshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Onshore Wind&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sensitivity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sensitivity</span> <span class="o">=</span> <span class="p">[</span><span class="n">sensitivity</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sensitivity</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;sensitivity in @sensitivity&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">owners</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;utility_id_eia in @owners | parent_name in @owners | parent_ticker in @owners&quot;</span>
            <span class="p">)</span>
            <span class="n">ba</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">own</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;owner_utility_id_eia in @owners | parent_name in @owners | parent_ticker in @owners&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">final_ba_code</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">owners</span><span class="p">))</span>

        <span class="n">re_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;re_specs_out&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ba_code in @ba&quot;</span><span class="p">)</span>
            <span class="n">re_meta</span> <span class="o">=</span> <span class="n">re_meta</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ba_code in @ba&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">owners</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">re_meta</span> <span class="o">=</span> <span class="n">re_meta</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">own</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="s2">&quot;owner_utility_id_eia in @owners | parent_name in @owners | parent_ticker in @owners&quot;</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">:</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">}),</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">],</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ba</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ba</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;All&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ba_code == @ba&quot;</span><span class="p">)</span>
            <span class="n">re_meta</span> <span class="o">=</span> <span class="n">re_meta</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;ba_code == @ba&quot;</span><span class="p">)</span>

        <span class="n">re_meta</span> <span class="o">=</span> <span class="n">re_meta</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
            <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;fos_id&quot;</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">join</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>  <span class="c1"># noqa: E731</span>
        <span class="n">re_potential</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">re_meta</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;latitude_nrel_site&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude_nrel_site&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;capacity_mw_nrel_site&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">:</span> <span class="n">join</span><span class="p">})</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_nrel_site&quot;</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">capacity_mw_nrel_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">re_type</span> <span class="o">==</span> <span class="s2">&quot;Fossil&quot;</span><span class="p">,</span>
                    <span class="mf">0.1</span><span class="p">,</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span>
                    <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;re_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">re_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;capacity_mw_nrel_site&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">selected_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude_nrel_site&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude_nrel_site&quot;</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">:</span> <span class="n">join</span><span class="p">})</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">_nrel_site&quot;</span><span class="p">:</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">)})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">re_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">re_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; selected&quot;</span><span class="p">,</span>
                <span class="n">capacity_mw_nrel_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fossil_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">re_meta</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;fos_id&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
                <span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">re_type</span><span class="o">=</span><span class="s2">&quot;Fossil&quot;</span><span class="p">,</span> <span class="n">capacity_mw_nrel_site</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">re</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="o">*</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">re_potential</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">sensitivity</span><span class="o">=</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">potential</span>
                    <span class="k">else</span> <span class="p">[</span><span class="n">MTDF</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                <span class="p">),</span>
                <span class="n">selected_</span> <span class="k">if</span> <span class="n">selected</span> <span class="k">else</span> <span class="n">MTDF</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="o">*</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">fossil_</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                            <span class="n">sensitivity</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                            <span class="n">re_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">.</span><span class="n">fos_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">re</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">fos_id</span><span class="p">),</span>  <span class="c1"># noqa: B023</span>
                                <span class="s2">&quot;Repowered Fossil&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;Fossil&quot;</span><span class="p">,</span>
                            <span class="p">),</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;re_type&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="n">fossil</span>
                    <span class="k">else</span> <span class="p">[</span><span class="n">MTDF</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">capacity_mw_nrel_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">re_type</span> <span class="o">==</span> <span class="s2">&quot;Repowered Fossil&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">re_type</span> <span class="o">==</span> <span class="s2">&quot;Fossil&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_mw_nrel_site</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">scatter_geo</span><span class="p">(</span>
                <span class="n">re</span><span class="p">,</span>
                <span class="n">lat</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="n">lon</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;re_type&quot;</span><span class="p">,</span>
                <span class="n">hover_name</span><span class="o">=</span><span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
                <span class="n">locationmode</span><span class="o">=</span><span class="s2">&quot;USA-states&quot;</span><span class="p">,</span>
                <span class="n">color_discrete_map</span><span class="o">=</span><span class="p">{</span><span class="n">k</span> <span class="o">+</span> <span class="s2">&quot; selected&quot;</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">COLOR_MAP</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="o">|</span> <span class="p">{</span>
                    <span class="s2">&quot;Onshore Wind selected&quot;</span><span class="p">:</span> <span class="s2">&quot;#529cba&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Offshore Wind selected&quot;</span><span class="p">:</span> <span class="s2">&quot;#86984c&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Repowered Fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;#e4e4e4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Solar&quot;</span><span class="p">:</span> <span class="s2">&quot;#fff8d5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Offshore Wind&quot;</span><span class="p">:</span> <span class="s2">&quot;#f2f3d7&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Onshore Wind&quot;</span><span class="p">:</span> <span class="s2">&quot;#ebf5f9&quot;</span><span class="p">,</span>
                <span class="p">},</span>
                <span class="n">size</span><span class="o">=</span><span class="s2">&quot;capacity_mw_nrel_site&quot;</span><span class="p">,</span>
                <span class="n">size_max</span><span class="o">=</span><span class="n">size_max</span><span class="p">,</span>  <span class="c1"># projection=</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">300</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
                <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_geos</span><span class="p">(</span>
                <span class="n">fitbounds</span><span class="o">=</span><span class="s2">&quot;locations&quot;</span><span class="p">,</span>
                <span class="n">landcolor</span><span class="o">=</span><span class="s2">&quot;rgb(230,232,234)&quot;</span><span class="p">,</span>
                <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;usa&quot;</span><span class="p">,</span>
                <span class="n">subunitwidth</span><span class="o">=</span><span class="n">subunitwidth</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">line_width</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>  <span class="c1"># noqa: C408</span>
            <span class="o">.</span><span class="n">for_each_trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_trace</span><span class="p">)</span>
            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;sensitivity=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                <span class="n">legend_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">legend_orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">legend_yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span>
                <span class="n">legend_xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">legend_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.compile_figs">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.compile_figs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compile_figs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startswith</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;output only available after `run_all`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">startswith</span><span class="si">}</span><span class="s2">.pdf&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">ROOT_PATH</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">path</span><span class="p">)</span><span class="si">}</span><span class="s2"> exists&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pypdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PdfWriter</span>

        <span class="k">with</span> <span class="p">(</span>
            <span class="n">logging_redirect_tqdm</span><span class="p">(),</span>
            <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">,</span>
            <span class="n">PdfWriter</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">merger</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">for_tqdm</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Figs&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="n">for_tqdm</span><span class="p">:</span>
                <span class="n">for_tqdm</span><span class="o">.</span><span class="n">set_description</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Figs &quot;</span> <span class="o">+</span> <span class="n">ba_code</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">z0</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s2">&quot;pdf&quot;</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">startswith</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">ba_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                            <span class="n">merger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">z0</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ba_code</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="n">ba_code</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">TracebackException</span><span class="o">.</span><span class="n">from_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                    <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.upload_output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.upload_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upload_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rmi_cloud_put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span><span class="p">,</span> <span class="s2">&quot;patio-results/&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.write_output">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.write_output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">renamer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operating_year&quot;</span><span class="p">:</span> <span class="s2">&quot;operational_year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;operating_month&quot;</span><span class="p">:</span> <span class="s2">&quot;operational_month&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">fos</span><span class="p">,</span> <span class="n">re</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_path</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_results&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;pudl_release&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span>
            <span class="c1"># Adapt final outputs for easier compatibility with the patio economic model</span>
            <span class="n">z</span><span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">fos</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renamer</span><span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                    <span class="n">operating_date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">operating_date</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>
                    <span class="p">),</span>
                    <span class="n">operational_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">operating_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                    <span class="n">operational_month</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">operating_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                    <span class="n">retirement_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                    <span class="n">retirement_month</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="s2">&quot;allocated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renamer</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                        <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                        <span class="n">operating_date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">operating_date</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span>
                            <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">ccs_eligible</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span> <span class="o">==</span> <span class="s2">&quot;Conventional Steam Coal&quot;</span><span class="p">,</span>
                            <span class="kc">True</span><span class="p">,</span>
                            <span class="kc">False</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sys_out</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="s2">&quot;system&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">sys_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">renamer</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                        <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                        <span class="c1"># dispatch_curtailment_pct=lambda x: x.curtailment_mwh</span>
                        <span class="c1"># / x.dispatch_load_mwh,</span>
                        <span class="c1"># dispatch_re_curtailment_pct=lambda x: x.re_curtailment_mwh</span>
                        <span class="c1"># / x.dispatch_re_mwh,</span>
                        <span class="c1"># dispatch_non_re_curtailment_pct_of_non_re_gen=lambda x: (</span>
                        <span class="c1">#     x.curtailment_mwh - x.re_curtailment_mwh</span>
                        <span class="c1"># )</span>
                        <span class="c1"># / (x.dispatch_load_mwh - x.dispatch_re_mwh),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;msg_output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;msg_output&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;colo_summary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="s2">&quot;colo_summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;colo_summary&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">suma</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">reset_ids</span><span class="p">()</span>
                <span class="n">z</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">suma</span>
            <span class="n">log_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">,</span> <span class="s2">&quot;.jsonl&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="n">PATIO_DOC_PATH</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;logs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">log_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;unable to write log&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">log_count</span><span class="p">:</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;unable to write log&quot;</span><span class="p">)</span></div>


    <span class="c1"># def gross_up(self):</span>
    <span class="c1">#     f, _, s, *_ = self.output()</span>
    <span class="c1">#     if &quot;old_clean&quot; in f.category:</span>
    <span class="c1">#         return None</span>
    <span class="c1">#</span>
    <span class="c1">#     all_old_re = []</span>
    <span class="c1">#</span>
    <span class="c1">#     for ba_code in tqdm(</span>
    <span class="c1">#         f.index.get_level_values(&quot;ba_code&quot;).unique(), desc=&quot;gross_up&quot;</span>
    <span class="c1">#     ):</span>
    <span class="c1">#         if self.data_source is None:</span>
    <span class="c1">#             d = self.pd.get_ba_data(ba_code, **self.data_kwargs)</span>
    <span class="c1">#             old_re_specs = d[&quot;old_re_specs&quot;]</span>
    <span class="c1">#             old_re_profs = d[&quot;old_re_profs&quot;]</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             with DataZip(Path.home() / self.data_source) as zs:</span>
    <span class="c1">#                 old_re_specs = zs[ba_code, &quot;old_re_specs&quot;]</span>
    <span class="c1">#                 old_re_profs = zs[ba_code, &quot;old_re_profs&quot;]</span>
    <span class="c1">#         old_re = (</span>
    <span class="c1">#             old_re_specs.reset_index()</span>
    <span class="c1">#             .assign()</span>
    <span class="c1">#             .merge(</span>
    <span class="c1">#                 (old_re_profs * old_re_specs.capacity_mw)</span>
    <span class="c1">#                 .groupby(pd.Grouper(freq=&quot;YS&quot;))</span>
    <span class="c1">#                 .sum()</span>
    <span class="c1">#                 .stack([0, 1])</span>
    <span class="c1">#                 .reset_index(name=&quot;redispatch_mwh&quot;),</span>
    <span class="c1">#                 on=[&quot;plant_id_eia&quot;, &quot;generator_id&quot;],</span>
    <span class="c1">#                 validate=&quot;1:m&quot;,</span>
    <span class="c1">#             )</span>
    <span class="c1">#         )</span>
    <span class="c1">#         all_old_re.append(</span>
    <span class="c1">#             pd.concat(</span>
    <span class="c1">#                 old_re.assign(scenario=scen)</span>
    <span class="c1">#                 for scen in f.index.get_level_values(&quot;scenario&quot;).unique()</span>
    <span class="c1">#             )</span>
    <span class="c1">#             .assign(ba_code=ba_code)</span>
    <span class="c1">#             .set_index(f.index.names)</span>
    <span class="c1">#         )</span>
    <span class="c1">#</span>
    <span class="c1">#     f = pd.concat([f, *all_old_re]).sort_index()</span>
    <span class="c1">#</span>
    <span class="c1">#     self._dfs[&quot;output&quot;] = f</span>
    <span class="c1">#     self._dfs[&quot;sys_output&quot;] = s</span>
    <span class="c1">#</span>
    <span class="c1">#     pass</span>

<div class="viewcode-block" id="BAs.deficits">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.deficits">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">deficits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sys_out</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">sys_out</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;re_energy&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nuclear_scen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;storage_li_pct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;storage_fe_pct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;storage_h2_pct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ccs_scen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;excl_or_moth&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;no_limit_prime&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;deficit_mwh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dirty_charge_mwh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;curtailment_mwh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;deficit_max_pct_net_load&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;deficit_gt_2pct_count&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.pivot_column">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.pivot_column">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pivot_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.summary">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">frs</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">co2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;existing_fossil&quot;</span><span class="p">,</span> <span class="s2">&quot;proposed_fossil&quot;</span><span class="p">])]</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
                <span class="p">[</span><span class="s2">&quot;redispatch_co2_tonne&quot;</span><span class="p">,</span> <span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">co2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">co2</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">co2</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;scenario == &#39;historical&#39;&quot;</span><span class="p">)[</span>
                    <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;redispatch_co2_tonne&quot;</span><span class="p">,</span> <span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_hist&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;redispatch_co2_tonne&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;scenario == &#39;historical&#39;&quot;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_full&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">avoided_co2_tonne</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_co2_tonne_hist</span>
                <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_co2_tonne</span><span class="p">,</span>
                <span class="n">avoided_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh_hist</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span><span class="p">,</span>
                <span class="n">avoided_co2_pct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">avoided_co2_tonne</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_co2_tonne_hist</span><span class="p">,</span>
                <span class="n">avoided_co2_pct_incl_xpatio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">avoided_co2_tonne</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_co2_tonne_full</span><span class="p">,</span>
            <span class="p">)[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;avoided_mwh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;avoided_co2_tonne&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;avoided_co2_pct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;avoided_co2_pct_incl_xpatio&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">r_base_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pre</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">pre</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;patio&quot;</span><span class="p">,</span> <span class="s2">&quot;proposed&quot;</span><span class="p">,</span> <span class="s2">&quot;old&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">CLEAN_TD_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">OTHER_TD_MAP</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">full</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">r_base_cols</span><span class="p">}</span> <span class="o">|</span> <span class="p">{</span>
            <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">r_base_cols</span>
        <span class="p">}</span>

        <span class="n">aggs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;re_curtailment_pct&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;curtailment_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;re_curtailment_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_pct&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_max_pct_net_load&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_gt_2pct_count&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fossil_retirements_cum_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">suma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">s</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aggs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span><span class="p">}</span>
                <span class="o">|</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">full</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">s</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                    <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)[[</span><span class="s2">&quot;implied_need_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;implied_need_mwh&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">])[[</span><span class="s2">&quot;implied_need_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;implied_need_mwh&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">co2</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">f</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;scenario == &#39;historical&#39;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;system_mw&quot;</span><span class="p">}),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">ba_avg_reduction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">avoided_co2_tonne</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="s2">&quot;mean&quot;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">suma</span></div>


<div class="viewcode-block" id="BAs.for_toy">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.for_toy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">for_toy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="n">re_first_cols</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;solar_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;onshore_wind_mw&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;solar_share&quot;,</span>
            <span class="c1"># &quot;wind_share&quot;,</span>
            <span class="s2">&quot;storage_li_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_fe_mw&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">re_max_cols</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;dirty_charge_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;curtailment_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_max_pct_net_load&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deficit_gt_2pct_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_li_max_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_fe_max_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_li_mw_utilization&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_fe_mw_utilization&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">scen_fields</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">ScenarioConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;re_limits_dispatch&quot;</span><span class="p">]</span>
        <span class="n">system</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">s</span>
            <span class="c1"># .assign(</span>
            <span class="c1">#     solar_share=lambda x: x.solar_mw</span>
            <span class="c1">#     / x[[&quot;solar_mw&quot;, &quot;onshore_wind_mw&quot;]].sum(axis=1),</span>
            <span class="c1">#     wind_share=lambda x: 1 - x.solar_share,</span>
            <span class="c1"># )</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">scen_fields</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">re_first_cols</span><span class="p">,</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">re_max_cols</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">re</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">,</span> <span class="s2">&quot;re_type&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])[</span>
                <span class="p">[</span><span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cf</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="n">hrs_per_year</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;re_type&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="s2">&quot;cf&quot;</span><span class="p">,</span>
                <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;onshore_wind&quot;</span><span class="p">:</span> <span class="s2">&quot;wind_cf&quot;</span><span class="p">,</span> <span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;solar_cf&quot;</span><span class="p">})</span>
            <span class="c1"># .drop(columns=[&quot;Nuclear&quot;])</span>
        <span class="p">)</span>
        <span class="c1"># fos = (</span>
        <span class="c1">#     f[[&quot;historical_mwh&quot;, &quot;redispatch_mwh&quot;, &quot;capacity_mw&quot;]]</span>
        <span class="c1">#     .reset_index()</span>
        <span class="c1">#     .groupby(</span>
        <span class="c1">#         [&quot;ba_code&quot;, *ScenarioConfig._fields, &quot;plant_id_eia&quot;, &quot;generator_id&quot;]</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .agg(</span>
        <span class="c1">#         {</span>
        <span class="c1">#             &quot;historical_mwh&quot;: &quot;mean&quot;,</span>
        <span class="c1">#             &quot;redispatch_mwh&quot;: &quot;mean&quot;,</span>
        <span class="c1">#             &quot;capacity_mw&quot;: &quot;first&quot;,</span>
        <span class="c1">#         }</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .query(&quot;plant_id_eia in (703, 2103)&quot;)</span>
        <span class="c1">#     .groupby([&quot;ba_code&quot;, *ScenarioConfig._fields, &quot;plant_id_eia&quot;])</span>
        <span class="c1">#     .sum()</span>
        <span class="c1">#     .assign(</span>
        <span class="c1">#         historical_cf=lambda x: x.historical_mwh / (x.capacity_mw * 8760),</span>
        <span class="c1">#         redispatch_cf=lambda x: x.redispatch_mwh / (x.capacity_mw * 8760),</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .reset_index()</span>
        <span class="c1"># )</span>
        <span class="n">hist_f</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">:</span> <span class="n">FOSSIL_PRIME_MOVER_MAP</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prime_mover_code&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;prime_mover_code&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">],</span>
                <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">hist_f</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">hist_f</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">re_mwh</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">r</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                    <span class="o">*</span><span class="n">scen_fields</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;re_plant_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;re_type&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">,</span>
                <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">re_mwh</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;_mwh&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">re_mwh</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">system</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">re</span><span class="p">,</span>
                <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">re_mwh</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">],</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">hist_f</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">scen_fields</span><span class="p">],</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">[</span>
            <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">])</span>
            <span class="o">|</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ScenarioConfig</span><span class="o">.</span><span class="n">_fields</span><span class="p">])</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;re_limits_dispatch&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="BAs.profile_check">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.profile_check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">profile_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span>  <span class="c1"># noqa: A002</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ba_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">:</span>
                <span class="n">ba</span> <span class="o">=</span> <span class="n">z0</span><span class="p">[</span><span class="n">ba_code</span><span class="p">]</span>
                <span class="n">out</span><span class="p">[</span><span class="n">ba_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">ba</span><span class="o">.</span><span class="n">profile_check</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out</span> <span class="k">if</span> <span class="s2">&quot;total&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]]</span>
        <span class="n">norm_</span> <span class="o">=</span> <span class="n">out</span> <span class="o">/</span> <span class="n">out</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">norm_</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="n">bad_bas</span> <span class="o">=</span> <span class="n">norm_</span><span class="p">[</span><span class="n">norm_</span><span class="o">.</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">norm_</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_bas</span><span class="p">,</span> <span class="s2">&quot;total&quot;</span><span class="p">],</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad_bas</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.top_parents_fig">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.top_parents_fig">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">top_parents_fig</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_proposed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">df_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`by` must be a str, received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">by</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_re_for_fig</span><span class="p">(</span>
            <span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">include_proposed</span><span class="o">=</span><span class="n">include_proposed</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">df_only</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">utils</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">_cap</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_gw</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">_sort</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">])</span><span class="o">.</span><span class="n">_cap</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;_sort&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">_grp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">capacity_gw</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;ngroup&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;_grp &lt; @n&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;_grp&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># util_order = utils[[&quot;_grp&quot;, by]].drop_duplicates()[ by].to_list()</span>

        <span class="k">if</span> <span class="n">df_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="c1"># columns=[&quot;category&quot;, &quot;technology_description&quot;],</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;capacity_gw&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">_s</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;_s&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_s&quot;</span><span class="p">])</span>
                <span class="c1"># .loc[reversed(util_order), :]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">utils</span>
                <span class="c1"># .sort_values([&quot;_grp&quot;], ascending=[False])</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">PLOT_MAP</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Wind&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">}),</span>
                    <span class="n">capacity_gw</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">capacity_gw</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_gw</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">y</span><span class="o">=</span><span class="n">by</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;capacity_gw&quot;</span><span class="p">,</span>
                <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
                <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">pattern_shape</span><span class="o">=</span><span class="s2">&quot;category&quot;</span> <span class="k">if</span> <span class="n">include_proposed</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">pattern_shape_map</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;proposed_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">},</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="c1"># category_orders={by: util_order},</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Wind&quot;</span><span class="p">:</span> <span class="n">COLOR_MAP</span><span class="p">[</span><span class="s2">&quot;Onshore Wind&quot;</span><span class="p">]},</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;sensitivity=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;GW&quot;</span><span class="p">,</span>
                <span class="n">yaxis_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">legend_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">legend_orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">legend_yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span>
                <span class="n">legend_xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">legend_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.fig_summary">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.fig_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fig_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ba</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">df_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="c1"># sensitivity=&quot;max_earnings, refi_trigger=1.0, Debt_Repl_EIR=0.1, Equity_Repl_EIR=0.1&quot;,</span>
    <span class="p">):</span>
        <span class="n">value_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Opex&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;Costs_Disc&quot;,</span>
            <span class="c1"># &quot;Capex_Costs_Disc&quot;,</span>
            <span class="c1"># &quot;Opex_Disc&quot;,</span>
            <span class="c1"># &quot;MWh_Disc&quot;,</span>
            <span class="c1"># &quot;Earnings_Disc&quot;,</span>
        <span class="p">]</span>
        <span class="n">id_vars</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
            <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;status&quot;,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;is_irp_year &quot;</span>
            <span class="c1"># &quot;&amp; sensitivity == @sensitivity &quot;</span>
            <span class="s2">&quot;&amp; ~historical_actuals&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">region</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ba</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">ba_code</span> <span class="o">==</span> <span class="n">ba</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">parent_name</span> <span class="o">==</span> <span class="n">parent</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">parent_ticker</span> <span class="o">==</span> <span class="n">parent</span><span class="p">)]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">technology_description</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">PLOT_MAP</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="s2">&quot;other&quot;</span>
                <span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;patio_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;patio&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;old_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;old&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;proposed_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;proposed&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;system&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;existing_fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;existing&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;existing_xpatio&quot;</span><span class="p">:</span> <span class="s2">&quot;xpatio&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;proposed_fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;proposed&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;other&quot;</span><span class="p">),</span>
                <span class="n">datetime</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">operating_year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-01-01&quot;</span><span class="p">),</span>
                <span class="n">portfolio</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">selected</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">id_vars</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="n">value_vars</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">id_vars</span><span class="p">,</span> <span class="n">value_vars</span><span class="o">=</span><span class="n">value_vars</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">df_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">match_axis</span><span class="p">(</span><span class="n">axis</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">anchor</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">))</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">axis</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;y</span><span class="si">{</span><span class="n">num</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">axis</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">df</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="c1"># pattern_shape=&quot;status&quot;,</span>
                <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span><span class="p">,</span>
                <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="n">facet_row</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">.</span><span class="n">for_each_yaxis</span><span class="p">(</span><span class="n">match_axis</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.econ_results">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_results">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">econ_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;econ_results&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="s2">&quot;patio/package_data/ba_rules.csv&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

            <span class="n">fs</span> <span class="o">=</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span>

            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FILLING MISSING STATES WITH STATE IN BA WITH GREATEST CAPACITY&quot;</span><span class="p">)</span>
            <span class="n">ix_cols</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">)</span>
            <span class="n">scfl_map</span> <span class="o">=</span> <span class="p">{</span><span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;cfl&quot;</span><span class="p">}</span>
            <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;az://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_dir_path</span><span class="si">}</span><span class="s2">/final_outputs.parquet&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;historical_actuals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">ix_cols</span><span class="p">,</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual_baseline&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace_strict</span><span class="p">(</span>
                            <span class="n">scfl_map</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">ix_cols</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;counterfactual_baseline&quot;</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cfl&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="o">*</span><span class="n">ix_cols</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
                <span class="n">weird</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;The final year of some resources does not match between the selected and counterfactual scenario:</span><span class="se">\n</span><span class="s2">    </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">weird</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">c_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                <span class="n">AZURE_CACHE_PATH</span> <span class="o">/</span> <span class="n">cached_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_dir_path</span><span class="si">}</span><span class="s2">/final_outputs.parquet&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># good_bas = (</span>
            <span class="c1">#     self.output()[2]</span>
            <span class="c1">#     # .query(&quot;~ba_high_cfl_deficit&quot;)</span>
            <span class="c1">#     .reset_index()</span>
            <span class="c1">#     .ba_code.unique()</span>
            <span class="c1"># )</span>
            <span class="n">na_subset</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;build_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Costs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Opex&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Earnings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Emissions_Reduced&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Disc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Disc_E&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Capex_Costs_Disc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Opex_Disc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MWh_Disc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Earnings_Disc&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">eresults</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">scan_parquet</span><span class="p">(</span><span class="n">c_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span>
                    <span class="n">eresults</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;refi_trigger&quot;</span><span class="p">,</span> <span class="s2">&quot;Debt_Repl_EIR&quot;</span><span class="p">,</span> <span class="s2">&quot;Equity_Repl_EIR&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Need code here to deal with multiple EIR settings&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;econ_results&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">eresults</span>
                <span class="c1"># .filter(</span>
                <span class="c1">#     pl.col(&quot;ba_code&quot;).is_in(list(good_bas))</span>
                <span class="c1">#     # &amp; (</span>
                <span class="c1">#     #     pl.col(&quot;counterfactual_baseline&quot;)</span>
                <span class="c1">#     #     | (</span>
                <span class="c1">#     #         pl.col(&quot;counterfactual_baseline&quot;).is_not()</span>
                <span class="c1">#     #         &amp; ~pl.col(&quot;historical_actuals&quot;)</span>
                <span class="c1">#     #     )</span>
                <span class="c1">#     # )</span>
                <span class="c1">#     # &amp; pl.col(&quot;least_cost&quot;).is_not()</span>
                <span class="c1">#     # &amp; (pl.col(&quot;refi_trigger&quot;) == 1.5)</span>
                <span class="c1">#     # &amp; (pl.col(&quot;Debt_Repl_EIR&quot;) == 0.3)</span>
                <span class="c1">#     # &amp; (pl.col(&quot;Equity_Repl_EIR&quot;) == 0.2)</span>
                <span class="c1"># )</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;Utility_ID_Econ&quot;</span><span class="p">:</span> <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
                <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
                <span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
                    <span class="n">subset</span><span class="o">=</span><span class="n">na_subset</span><span class="p">,</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="s2">&quot;build_year&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="s2">&quot;operating_year&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;Utility-Scale Battery Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;LandbasedWind&quot;</span><span class="p">:</span> <span class="s2">&quot;Onshore Wind Turbine&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;UtilityPV&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar Photovoltaic&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;OffShoreWind&quot;</span><span class="p">:</span> <span class="s2">&quot;Offshore Wind Turbine&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Pumped Storage Hydropower&quot;</span><span class="p">:</span> <span class="s2">&quot;Hydroelectric Pumped Storage&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">own</span><span class="p">[</span>
                        <span class="p">[</span>
                            <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;parent_ticker&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">),</span>
                    <span class="n">on</span><span class="o">=</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">],</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">}</span>
                    <span class="p">)[</span>
                        <span class="p">[</span>
                            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">],</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">state</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">ba_code</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;final_ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">])</span>
                            <span class="o">.</span><span class="n">capacity_mw</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                                <span class="p">[</span><span class="s2">&quot;final_ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;capacity_mw&quot;</span><span class="p">],</span>
                                <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                            <span class="p">)</span>
                            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;final_ba_code&quot;</span><span class="p">)</span>
                            <span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                            <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">region</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ba_code</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">REGION_MAP</span><span class="p">),</span>
                    <span class="n">selected</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">~</span><span class="n">x</span><span class="o">.</span><span class="n">counterfactual_baseline</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">x</span><span class="o">.</span><span class="n">historical_actuals</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">operating_year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-01-01&quot;</span><span class="p">),</span>
                    <span class="n">incumbent_technology</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">incumbent_technology</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_sensitivity_col</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;econ_results&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="BAs.add_sensitivity_col">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.add_sensitivity_col">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_sensitivity_col</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">sensitivity</span><span class="o">=</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">y</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;least_cost&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;refi_trigger&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;savings_tol&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;earnings_thresh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Debt_Repl_EIR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Equity_Repl_EIR&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;least_cost&quot;</span><span class="p">:</span> <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;least_cost&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;max_earnings&quot;</span><span class="p">}})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">refi_trigger</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">refi_trigger</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;refi_trigger=&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">refi_trigger</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">savings_tol</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">savings_tol</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;savings_tol=&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">savings_tol</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">earnings_thresh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">earnings_thresh</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;earnings_thresh=&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">earnings_thresh</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">Debt_Repl_EIR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">Debt_Repl_EIR</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;Debt_Repl_EIR=&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">Debt_Repl_EIR</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">Equity_Repl_EIR</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">Equity_Repl_EIR</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;Equity_Repl_EIR=&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">Equity_Repl_EIR</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;, ,&quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.econ_comparison">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_comparison">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">econ_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~historical_actuals&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">scenario</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">selected</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">by</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`by` must be a list, tuple, or str; received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">by</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">column</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span></div>


    <span class="c1"># def selected_reduction(self, by):</span>
    <span class="c1">#     &quot;&quot;&quot;Use final_econ to calculate emission and cost reductions</span>
    <span class="c1">#</span>
    <span class="c1">#     Args:</span>
    <span class="c1">#         by:</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns:</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     warnings.warn(&quot;WRONG DO NOT USE&quot;, DeprecationWarning)</span>
    <span class="c1">#</span>
    <span class="c1">#     econ_results_path = (</span>
    <span class="c1">#         ROOT_PATH</span>
    <span class="c1">#         / f&quot;econ_results/{self.name}_resultsIRA_TRUE/final_econ-{self.name}_resultsIRA_TRUE.csv&quot;</span>
    <span class="c1">#     )</span>
    <span class="c1">#     id_cols = [&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;scenario&quot;]</span>
    <span class="c1">#     cols = [</span>
    <span class="c1">#         &quot;Costs_Disc_Sum&quot;,</span>
    <span class="c1">#         &quot;Capex_Costs_Disc_Sum&quot;,</span>
    <span class="c1">#         &quot;Opex_Disc_Sum&quot;,</span>
    <span class="c1">#         &quot;MWh_Disc_Sum&quot;,</span>
    <span class="c1">#         &quot;Earnings_Disc_Sum&quot;,</span>
    <span class="c1">#         &quot;Emissions_Sum&quot;,</span>
    <span class="c1">#         &quot;Emissions_Reduced_Sum&quot;,</span>
    <span class="c1">#         &quot;Forward_Earnings_irp_year&quot;,</span>
    <span class="c1">#         &quot;Costs_irp_year&quot;,</span>
    <span class="c1">#         &quot;Capex_Costs_irp_year&quot;,</span>
    <span class="c1">#         &quot;Opex_irp_year&quot;,</span>
    <span class="c1">#         &quot;Emissions_fin_build_year&quot;,</span>
    <span class="c1">#         &quot;Emissions_Reduced_fin_build_year&quot;,</span>
    <span class="c1">#         &quot;MW&quot;,</span>
    <span class="c1">#     ]</span>
    <span class="c1">#</span>
    <span class="c1">#     econ_results = (</span>
    <span class="c1">#         pd.read_csv(econ_results_path)</span>
    <span class="c1">#         .rename(columns={&quot;Utility_ID_Econ&quot;: &quot;utility_id_eia&quot;})</span>
    <span class="c1">#         .query(&quot;~counterfactual_baseline&quot;)[[*id_cols, *cols, &quot;Cost_Reduction&quot;]]</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             self.ad.own[</span>
    <span class="c1">#                 [</span>
    <span class="c1">#                     &quot;owner_utility_id_eia&quot;,</span>
    <span class="c1">#                     &quot;parent_name&quot;,</span>
    <span class="c1">#                     &quot;parent_ticker&quot;,</span>
    <span class="c1">#                     &quot;owner_utility_name_eia&quot;,</span>
    <span class="c1">#                 ]</span>
    <span class="c1">#             ].drop_duplicates(),</span>
    <span class="c1">#             left_on=&quot;utility_id_eia&quot;,</span>
    <span class="c1">#             right_on=&quot;owner_utility_id_eia&quot;,</span>
    <span class="c1">#             how=&quot;left&quot;,</span>
    <span class="c1">#             validate=&quot;m:1&quot;,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .assign(</span>
    <span class="c1">#             cost_reduction_usd=lambda x: x.Cost_Reduction * x.MWh_Disc_Sum,</span>
    <span class="c1">#             scenario=lambda x: x.scenario.fillna(&quot;&quot;),</span>
    <span class="c1">#         )</span>
    <span class="c1">#     )</span>
    <span class="c1">#     return (</span>
    <span class="c1">#         econ_results.groupby(by)</span>
    <span class="c1">#         .agg(</span>
    <span class="c1">#             {&quot;scenario&quot;: lambda x: sorted(set(x))}</span>
    <span class="c1">#             | {k: &quot;sum&quot; for k in [*cols, &quot;cost_reduction_usd&quot;]}</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .assign(</span>
    <span class="c1">#             Levelized_Costs=lambda x: x.Costs_Disc_Sum / x.MWh_Disc_Sum,</span>
    <span class="c1">#             Cost_Reduction=lambda x: x.cost_reduction_usd / x.MWh_Disc_Sum,</span>
    <span class="c1">#         )</span>
    <span class="c1">#     )</span>

    <span class="c1"># def emission_cost_reduction(self, by: str | list = &quot;ba_code&quot;):</span>
    <span class="c1">#     warnings.warn(&quot;MIGHT NOT WORK RIGHT (WIP)&quot;, UserWarning)</span>
    <span class="c1">#     if isinstance(by, tuple):</span>
    <span class="c1">#         by = list(by)</span>
    <span class="c1">#     econ_results_by_tech = (</span>
    <span class="c1">#         pd.read_parquet(</span>
    <span class="c1">#             ROOT_PATH</span>
    <span class="c1">#             / f&quot;econ_results/{self.name}_resultsIRA_TRUE/final_econ_by_tech-{self.name}_resultsIRA_TRUE.parquet&quot;</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .astype({&quot;scenario&quot;: str, &quot;ba_code&quot;: str, &quot;Utility_ID_Econ&quot;: int})</span>
    <span class="c1">#         .rename(columns={&quot;Utility_ID_Econ&quot;: &quot;utility_id_eia&quot;})</span>
    <span class="c1">#         .assign(</span>
    <span class="c1">#             region=lambda x: x.ba_code.map(REGION_MAP),</span>
    <span class="c1">#             is_selected=lambda x: x.is_selected.replace({None: False}).astype(bool),</span>
    <span class="c1">#             counterfactual_baseline=lambda x: x.counterfactual_baseline.replace(</span>
    <span class="c1">#                 {None: False}</span>
    <span class="c1">#             ).astype(bool),</span>
    <span class="c1">#             year=lambda x: x.operating_year.astype(int),</span>
    <span class="c1">#             day=1,</span>
    <span class="c1">#             month=1,</span>
    <span class="c1">#             datetime=lambda x: pd.to_datetime(x[[&quot;year&quot;, &quot;month&quot;, &quot;day&quot;]]),</span>
    <span class="c1">#             usd_per_mwh=lambda x: x.Costs_Disc / x.MWh_Disc,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .drop(columns=[&quot;year&quot;, &quot;month&quot;, &quot;day&quot;])</span>
    <span class="c1">#         .query(&quot;(counterfactual_baseline &amp; ~is_selected) | is_selected&quot;)</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             self.ad.own[</span>
    <span class="c1">#                 [&quot;owner_utility_id_eia&quot;, &quot;parent_name&quot;, &quot;parent_ticker&quot;]</span>
    <span class="c1">#             ].drop_duplicates(),</span>
    <span class="c1">#             left_on=&quot;utility_id_eia&quot;,</span>
    <span class="c1">#             right_on=&quot;owner_utility_id_eia&quot;,</span>
    <span class="c1">#             how=&quot;left&quot;,</span>
    <span class="c1">#             validate=&quot;m:1&quot;,</span>
    <span class="c1">#         )</span>
    <span class="c1">#     )</span>
    <span class="c1">#</span>
    <span class="c1">#     # f, r, s = self.output()</span>
    <span class="c1">#     # s = generate_projection_from_historical(</span>
    <span class="c1">#     #     s.reset_index(),</span>
    <span class="c1">#     #     year_mapper={k: k for k in range(2025, 2040)}</span>
    <span class="c1">#     #     | dict(zip(range(2040, 2056), list(range(2036, 2040)) * 4)),</span>
    <span class="c1">#     # )</span>
    <span class="c1">#     #</span>
    <span class="c1">#     # econ_results_by_tech = econ_results_by_tech.merge(</span>
    <span class="c1">#     #     s[[&quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;, &quot;re_curtailment_pct&quot;]],</span>
    <span class="c1">#     #     on=[&quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#     #     how=&quot;left&quot;,</span>
    <span class="c1">#     #     validate=&quot;m:1&quot;,</span>
    <span class="c1">#     # ).assign(</span>
    <span class="c1">#     #     mwh_cur_adj=lambda x: x.MWh_Disc.mask(</span>
    <span class="c1">#     #         x.Technology_FERC == &quot;renewables&quot;,</span>
    <span class="c1">#     #         x.MWh_Disc * (1 - x.re_curtailment_pct),</span>
    <span class="c1">#     #     )</span>
    <span class="c1">#     # )</span>
    <span class="c1">#</span>
    <span class="c1">#     keep_region = {} if &quot;region&quot; in by else {&quot;region&quot;: &quot;first&quot;}</span>
    <span class="c1">#     keep_parent = {} if &quot;parent_name&quot; in by else {&quot;parent_name&quot;: &quot;first&quot;}</span>
    <span class="c1">#</span>
    <span class="c1">#     selected = (</span>
    <span class="c1">#         econ_results_by_tech.query(&quot;is_selected &amp; ~counterfactual_baseline&quot;)</span>
    <span class="c1">#         .groupby(by, dropna=False)</span>
    <span class="c1">#         .agg(</span>
    <span class="c1">#             keep_parent</span>
    <span class="c1">#             | keep_region</span>
    <span class="c1">#             | {</span>
    <span class="c1">#                 &quot;scenario&quot;: &quot;last&quot;,</span>
    <span class="c1">#                 &quot;parent_ticker&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;Emissions&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;Emissions_Reduced&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;Costs_Disc&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;MWh_Disc&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;MWh&quot;: &quot;sum&quot;,</span>
    <span class="c1">#             }</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .rename(</span>
    <span class="c1">#             columns={</span>
    <span class="c1">#                 &quot;Emissions&quot;: &quot;Emissions_selected&quot;,</span>
    <span class="c1">#                 # &quot;Emissions_Reduced&quot;: &quot;Emissions_Reduced_reduced&quot;,</span>
    <span class="c1">#                 &quot;Costs_Disc&quot;: &quot;Costs_Disc_selected&quot;,</span>
    <span class="c1">#                 &quot;MWh_Disc&quot;: &quot;MWh_Disc_selected&quot;,</span>
    <span class="c1">#                 &quot;MWh&quot;: &quot;MWh_selected&quot;,</span>
    <span class="c1">#             }</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .reset_index()</span>
    <span class="c1">#     )</span>
    <span class="c1">#     cfl = (</span>
    <span class="c1">#         econ_results_by_tech.query(&quot;counterfactual_baseline &amp; ~is_selected&quot;)</span>
    <span class="c1">#         .groupby(by, dropna=False)[</span>
    <span class="c1">#             [&quot;Emissions&quot;, &quot;Emissions_Reduced&quot;, &quot;Costs_Disc&quot;, &quot;MWh_Disc&quot;, &quot;MWh&quot;]</span>
    <span class="c1">#         ]</span>
    <span class="c1">#         .sum()</span>
    <span class="c1">#         .rename(</span>
    <span class="c1">#             columns={</span>
    <span class="c1">#                 &quot;Emissions&quot;: &quot;Emissions_counterfactual&quot;,</span>
    <span class="c1">#                 &quot;Emissions_Reduced&quot;: &quot;Emissions_Reduced_counterfactual&quot;,</span>
    <span class="c1">#                 &quot;Costs_Disc&quot;: &quot;Costs_Disc_counterfactual&quot;,</span>
    <span class="c1">#                 &quot;MWh_Disc&quot;: &quot;MWh_Disc_counterfactual&quot;,</span>
    <span class="c1">#                 &quot;MWh&quot;: &quot;MWh_counterfactual&quot;,</span>
    <span class="c1">#             }</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .reset_index()</span>
    <span class="c1">#     )</span>
    <span class="c1">#     full = selected.merge(cfl, on=by, validate=&quot;1:1&quot;).assign(</span>
    <span class="c1">#         mwh_diff=lambda x: x.MWh_Disc_selected / x.MWh_Disc_counterfactual - 1,</span>
    <span class="c1">#         unit_cost_selected=lambda x: (</span>
    <span class="c1">#             x.Costs_Disc_selected / x.MWh_Disc_selected</span>
    <span class="c1">#         ).replace({np.inf: np.nan}),</span>
    <span class="c1">#         unit_cost_counterfactual=lambda x: (</span>
    <span class="c1">#             x.Costs_Disc_counterfactual / x.MWh_Disc_counterfactual</span>
    <span class="c1">#         ).replace({np.inf: np.nan}),</span>
    <span class="c1">#         unit_cost_savings_pct=lambda x: -(</span>
    <span class="c1">#             x.unit_cost_selected / x.unit_cost_counterfactual - 1</span>
    <span class="c1">#         ).replace({np.inf: np.nan}),</span>
    <span class="c1">#         savingsish=lambda x: (x.unit_cost_counterfactual - x.unit_cost_selected)</span>
    <span class="c1">#         * x.MWh_Disc_counterfactual,</span>
    <span class="c1">#         savings_pct=lambda x: x.savingsish / x.Costs_Disc_counterfactual,</span>
    <span class="c1">#         unit_emissions_selected=lambda x: x.Emissions_selected</span>
    <span class="c1">#         / x.MWh_Disc_selected,</span>
    <span class="c1">#         unit_emissions_counterfactual=lambda x: x.Emissions_counterfactual</span>
    <span class="c1">#         / x.MWh_Disc_counterfactual,</span>
    <span class="c1">#         emissions_original=lambda x: x.Emissions_selected + x.Emissions_Reduced,</span>
    <span class="c1">#         emissions_savings_pct=lambda x: x.Emissions_Reduced / x.emissions_original,</span>
    <span class="c1">#         # costs_reduced=lambda x: x.costs_counterfactual - x.costs_selected,</span>
    <span class="c1">#         # savings_pct=lambda x: x.costs_reduced / x.costs_counterfactual,</span>
    <span class="c1">#         # em_r=lambda x: x.Emissions - x.Emissions_counterfactual,</span>
    <span class="c1">#         # emission_reduction_pct=lambda x: (x.Emissions - x.Emissions_counterfactual)</span>
    <span class="c1">#         # / x.Emissions_counterfactual,</span>
    <span class="c1">#     )</span>
    <span class="c1">#     return full</span>

<div class="viewcode-block" id="BAs.selected_re_for_fig">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.selected_re_for_fig">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">selected_re_for_fig</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">by</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">include_proposed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pivot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">combine_wind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">df_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">by</span> <span class="o">=</span> <span class="p">[</span><span class="n">by</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~historical_actuals&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;retirement_date&quot;</span><span class="p">]],</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">combine_wind</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;OffShoreWind&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;LandbasedWind&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Offshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Onshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;category in (&#39;patio_clean&#39;, &#39;proposed_clean&#39;) &quot;</span>
                    <span class="s2">&quot;&amp; is_irp_year&quot;</span>
                    <span class="s2">&quot;&amp; operating_year == 2032 &amp; selected &quot;</span>
                    <span class="s2">&quot;&amp; technology_description not in (&#39;Pumped Storage Hydropower&#39;, &#39;Nuclear&#39;, &#39;Geothermal&#39;, &#39;Hydroelectric Pumped Storage&#39;)&quot;</span><span class="p">,</span>
                    <span class="c1"># &quot;&amp; (surplus | (replacement &amp; retirement_date.notna()))&quot;,</span>
                    <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">by</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">MW</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;MW&quot;</span><span class="p">:</span> <span class="s2">&quot;capacity_gw&quot;</span><span class="p">})</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">include_proposed</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category  == &#39;patio_clean&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pivot</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">by</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">values</span><span class="o">=</span><span class="s2">&quot;capacity_gw&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">t</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;_p&quot;</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">trace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># print(df[by])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">by</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;when plotting, &quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">PLOT_MAP</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Wind&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">})</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">category</span> <span class="o">==</span> <span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;_p&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">x</span><span class="o">=</span><span class="n">by</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;capacity_gw&quot;</span><span class="p">,</span>
                <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
                <span class="n">facet_col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
                <span class="c1"># category_orders={</span>
                <span class="c1">#     by[0]: sorted(df[by].squeeze().unique()),</span>
                <span class="c1">#     &quot;r&quot;: [&quot;Storage_p&quot;, &quot;Wind_p&quot;, &quot;Solar_p&quot;, &quot;Storage&quot;, &quot;Wind&quot;, &quot;Solar&quot;],</span>
                <span class="c1"># },</span>
                <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span>
                <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Wind&quot;</span><span class="p">:</span> <span class="n">COLOR_MAP</span><span class="p">[</span><span class="s2">&quot;Onshore Wind&quot;</span><span class="p">]}</span>
                <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Wind_p&quot;</span><span class="p">:</span> <span class="s2">&quot;#529cba&quot;</span><span class="p">,</span> <span class="s2">&quot;Storage_p&quot;</span><span class="p">:</span> <span class="s2">&quot;#c7c4e2&quot;</span><span class="p">,</span> <span class="s2">&quot;Solar_p&quot;</span><span class="p">:</span> <span class="s2">&quot;#ffeda9&quot;</span><span class="p">},</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">200</span> <span class="o">+</span> <span class="mi">200</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">facet_row_spacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;GW&quot;</span><span class="p">,</span>
                <span class="n">xaxis_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">legend_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">legend_orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">legend_yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.01</span><span class="p">,</span>
                <span class="n">legend_xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
                <span class="n">legend_x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;sensitivity=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">.</span><span class="n">for_each_trace</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.energy_comparison_fig">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.energy_comparison_fig">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">energy_comparison_fig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="mi">2035</span><span class="p">,</span> <span class="n">df_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;MIGHT NOT WORK RIGHT (WIP)&quot;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>  <span class="c1"># noqa: B028</span>

        <span class="n">ORDERING</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nuclear&quot;</span><span class="p">:</span> <span class="s2">&quot;000&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coal&quot;</span><span class="p">:</span> <span class="s2">&quot;001&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coal ccs&quot;</span><span class="p">:</span> <span class="s2">&quot;0015&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gas cc&quot;</span><span class="p">:</span> <span class="s2">&quot;002&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gas ct&quot;</span><span class="p">:</span> <span class="s2">&quot;004&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gas rice&quot;</span><span class="p">:</span> <span class="s2">&quot;005&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gas st&quot;</span><span class="p">:</span> <span class="s2">&quot;003&quot;</span><span class="p">,</span>
            <span class="s2">&quot;other fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;006&quot;</span><span class="p">,</span>
            <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;006&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hydro&quot;</span><span class="p">:</span> <span class="s2">&quot;007&quot;</span><span class="p">,</span>
            <span class="s2">&quot;biomass&quot;</span><span class="p">:</span> <span class="s2">&quot;008&quot;</span><span class="p">,</span>
            <span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;011&quot;</span><span class="p">,</span>
            <span class="s2">&quot;onshore wind&quot;</span><span class="p">:</span> <span class="s2">&quot;009&quot;</span><span class="p">,</span>
            <span class="s2">&quot;offshore wind&quot;</span><span class="p">:</span> <span class="s2">&quot;010&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage&quot;</span><span class="p">:</span> <span class="s2">&quot;012&quot;</span><span class="p">,</span>
            <span class="s2">&quot;curtailment&quot;</span><span class="p">:</span> <span class="s2">&quot;013&quot;</span><span class="p">,</span>
            <span class="s2">&quot;january&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span><span class="p">,</span>
            <span class="s2">&quot;february&quot;</span><span class="p">:</span> <span class="s2">&quot;102&quot;</span><span class="p">,</span>
            <span class="s2">&quot;march&quot;</span><span class="p">:</span> <span class="s2">&quot;103&quot;</span><span class="p">,</span>
            <span class="s2">&quot;april&quot;</span><span class="p">:</span> <span class="s2">&quot;104&quot;</span><span class="p">,</span>
            <span class="s2">&quot;may&quot;</span><span class="p">:</span> <span class="s2">&quot;105&quot;</span><span class="p">,</span>
            <span class="s2">&quot;june&quot;</span><span class="p">:</span> <span class="s2">&quot;106&quot;</span><span class="p">,</span>
            <span class="s2">&quot;july&quot;</span><span class="p">:</span> <span class="s2">&quot;107&quot;</span><span class="p">,</span>
            <span class="s2">&quot;august&quot;</span><span class="p">:</span> <span class="s2">&quot;108&quot;</span><span class="p">,</span>
            <span class="s2">&quot;september&quot;</span><span class="p">:</span> <span class="s2">&quot;109&quot;</span><span class="p">,</span>
            <span class="s2">&quot;october&quot;</span><span class="p">:</span> <span class="s2">&quot;110&quot;</span><span class="p">,</span>
            <span class="s2">&quot;november&quot;</span><span class="p">:</span> <span class="s2">&quot;111&quot;</span><span class="p">,</span>
            <span class="s2">&quot;december&quot;</span><span class="p">:</span> <span class="s2">&quot;112&quot;</span><span class="p">,</span>
            <span class="s2">&quot;historical&quot;</span><span class="p">:</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch&quot;</span><span class="p">:</span> <span class="s2">&quot;201&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cr&quot;</span><span class="p">:</span> <span class="s2">&quot;204&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean repowering&quot;</span><span class="p">:</span> <span class="s2">&quot;204&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean&lt;br&gt;repowering&quot;</span><span class="p">:</span> <span class="s2">&quot;204&quot;</span><span class="p">,</span>
            <span class="s2">&quot;planned&quot;</span><span class="p">:</span> <span class="s2">&quot;203&quot;</span><span class="p">,</span>
            <span class="s2">&quot;current&quot;</span><span class="p">:</span> <span class="s2">&quot;202&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">patio_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">casefold</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ORDERING</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">([</span><span class="n">ORDERING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">ORDERING</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">casefold</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

        <span class="n">to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_en_comp</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">by</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">)</span>
        <span class="n">to_plot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">to_plot</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;technology_description not in (&#39;curtailment&#39;, &#39;deficit&#39;) &quot;</span>
                <span class="c1"># &quot;&amp; scenario !=&#39;counterfactual&#39;&quot;</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">redispatch_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span> <span class="o">==</span> <span class="s2">&quot;curtailment&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh</span>
                <span class="p">)</span>
                <span class="o">/</span> <span class="mf">1e6</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="n">PLOT_MAP</span>
                    <span class="o">|</span> <span class="p">{</span>
                        <span class="s2">&quot;Natural Gas Internal Combustion Engine&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Natural Gas Steam Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;Hydroelectric Pumped Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Hydro&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Other Fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Solar Thermal with Energy Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Solar Thermal without Energy Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Natural Gas with Compressed Air Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Other Natural Gas&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Biomass&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Geothermal&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Flywheels&quot;</span><span class="p">:</span> <span class="s2">&quot;Other&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;2021&quot;</span><span class="p">:</span> <span class="s2">&quot;Current&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;counterfactual&quot;</span><span class="p">:</span> <span class="s2">&quot;Planned&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="s2">&quot;Clean&lt;br&gt;Repowering&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">redispatch_mwh</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">patio_key</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">df_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_plot</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">to_plot</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="n">facet_col</span><span class="o">=</span><span class="n">by</span><span class="p">,</span>
                <span class="c1"># facet_col_wrap=3,</span>
                <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="c1"># width=1100,</span>
                <span class="n">facet_col_spacing</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
                <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Other&quot;</span><span class="p">:</span> <span class="n">COLOR_MAP</span><span class="p">[</span><span class="s2">&quot;Other Fossil&quot;</span><span class="p">]},</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">tickangle</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
                <span class="n">gridcolor</span><span class="o">=</span><span class="s2">&quot;#58595B&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">font_family</span><span class="o">=</span><span class="s2">&quot;Tw Cen MT Std&quot;</span><span class="p">,</span>
                <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span>
                <span class="c1"># paper_bgcolor=&#39;#FFFFFF&#39;,</span>
                <span class="n">font_color</span><span class="o">=</span><span class="s2">&quot;#58595B&quot;</span><span class="p">,</span>
                <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;TWh&quot;</span><span class="p">,</span>
                <span class="n">legend_orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">legend_yanchor</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="n">legend_y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">,</span>
                <span class="n">legend_xanchor</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">legend_x</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">,</span>
                <span class="n">legend_title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


    <span class="c1"># def for_en_comp(self, by=&quot;region&quot;, year=2035):</span>
    <span class="c1">#     warnings.warn(&quot;MIGHT NOT WORK RIGHT (WIP)&quot;, UserWarning)</span>
    <span class="c1">#</span>
    <span class="c1">#     if &quot;for_en_comp&quot; + by not in self._dfs:</span>
    <span class="c1">#         f, *_ = self.output()</span>
    <span class="c1">#         f = self.by_owner(f)</span>
    <span class="c1">#         selected = (</span>
    <span class="c1">#             self.econ_selected_full()</span>
    <span class="c1">#             .query(&quot;datetime.dt.year == @year&quot;)</span>
    <span class="c1">#             .groupby([by, &quot;technology_description&quot;])</span>
    <span class="c1">#             .redispatch_mwh.sum()</span>
    <span class="c1">#             .reset_index()</span>
    <span class="c1">#             .assign(scenario=&quot;selected&quot;)</span>
    <span class="c1">#         )</span>
    <span class="c1">#         cfl = (</span>
    <span class="c1">#             f.reset_index()</span>
    <span class="c1">#             .query(&quot;datetime.dt.year == @year&quot;)</span>
    <span class="c1">#             .assign(region=lambda x: x.ba_code.map(REGION_MAP))</span>
    <span class="c1">#             .query(&quot;scenario == &#39;counterfactual&#39;&quot;)</span>
    <span class="c1">#             .groupby([by, &quot;technology_description&quot;, &quot;scenario&quot;])</span>
    <span class="c1">#             .redispatch_mwh.sum()</span>
    <span class="c1">#             .reset_index()</span>
    <span class="c1">#             .assign(scenario=&quot;counterfactual&quot;)</span>
    <span class="c1">#         )</span>
    <span class="c1">#         base = (</span>
    <span class="c1">#             f.reset_index()</span>
    <span class="c1">#             .query(&quot;datetime.dt.year == 2021&quot;)</span>
    <span class="c1">#             .assign(region=lambda x: x.ba_code.map(REGION_MAP))</span>
    <span class="c1">#             .query(&quot;scenario == &#39;counterfactual&#39;&quot;)</span>
    <span class="c1">#             .groupby([by, &quot;technology_description&quot;, &quot;scenario&quot;])</span>
    <span class="c1">#             .redispatch_mwh.sum()</span>
    <span class="c1">#             .reset_index()</span>
    <span class="c1">#             .assign(scenario=&quot;2021&quot;)</span>
    <span class="c1">#         )</span>
    <span class="c1">#         self._dfs[&quot;for_en_comp&quot; + by] = pd.concat([selected, cfl, base])</span>
    <span class="c1">#     return self._dfs[&quot;for_en_comp&quot; + by]</span>

    <span class="nd">@lru_cache</span>  <span class="c1"># noqa: B019</span>
<div class="viewcode-block" id="BAs._econ_selected_all_old">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._econ_selected_all_old">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_econ_selected_all_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;az://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_dir_path</span><span class="si">}</span><span class="s2">/scenario_selected.parquet&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>  <span class="c1"># noqa: PD013</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Utility_ID_Econ&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Utility_ID_Econ&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">region</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ba_code</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">REGION_MAP</span><span class="p">),</span>
                    <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">build_year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                    <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">]]),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;is_selected&quot;</span><span class="p">)[[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">]]</span>
                <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">],</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
                <span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
                <span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
            <span class="p">)</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="BAs.econ_dir_path">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_dir_path">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">econ_dir_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prefix</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;patio-results/</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_scen_dir</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_scen_dir</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span></div>


    <span class="nd">@lru_cache</span>  <span class="c1"># noqa: B019</span>
<div class="viewcode-block" id="BAs._econ_selected_all">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs._econ_selected_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_econ_selected_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;az://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_dir_path</span><span class="si">}</span><span class="s2">/scenario_selected.parquet&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># noqa: F811</span>
            <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_sensitivity_col</span><span class="p">)</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;scenario&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Utility_ID_Econ&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Utility_ID_Econ&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">region</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">ba_code</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">REGION_MAP</span><span class="p">),</span>
                    <span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">build_year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
                    <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">month</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">datetime</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="s2">&quot;day&quot;</span><span class="p">]]),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;is_selected&quot;</span><span class="p">)[</span>
                    <span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">sensitivities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sensi</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">sensitivity</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">sensitivities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;sensitivity == @sensi&quot;</span><span class="p">)</span>  <span class="c1"># noqa: PD013</span>
                <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">],</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
                <span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
                <span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
                <span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;scenario&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">sensitivity</span><span class="o">=</span><span class="n">sensi</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sensitivities</span><span class="p">)</span></div>


<div class="viewcode-block" id="BAs.by_owner">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.by_owner">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">by_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">c_to_allocate</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_mmbtu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_co2_tonne&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_fuel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_vom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_startup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;redispatch_cost_fom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;implied_need_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;implied_need_mwh&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">patio_by_owner</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">own</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;fraction_owned&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;parent_ticker&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_r&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">utility_id_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">owner_utility_id_eia</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;balancing_authority_code_eia_r&quot;</span> <span class="ow">in</span> <span class="n">patio_by_owner</span><span class="p">:</span>
            <span class="n">patio_by_owner</span> <span class="o">=</span> <span class="n">patio_by_owner</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">balancing_authority_code_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">balancing_authority_code_eia</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">balancing_authority_code_eia_r</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia_r&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c_to_allocate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">patio_by_owner</span><span class="p">:</span>
                <span class="n">patio_by_owner</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">patio_by_owner</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">patio_by_owner</span><span class="o">.</span><span class="n">fraction_owned</span>
        <span class="k">return</span> <span class="n">patio_by_owner</span></div>


    <span class="c1"># def econ_selected_full(self):</span>
    <span class="c1">#     f, r, s, *_ = self.output()</span>
    <span class="c1">#</span>
    <span class="c1">#     curtailment = generate_projection_from_historical(</span>
    <span class="c1">#         s.reset_index(),</span>
    <span class="c1">#         year_mapper={k: k for k in range(2025, 2040)}</span>
    <span class="c1">#         | dict(zip(range(2040, 2056), list(range(2036, 2040)) * 4)),</span>
    <span class="c1">#     )[[&quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;, &quot;re_curtailment_pct&quot;]]</span>
    <span class="c1">#     f = self.by_owner(f)</span>
    <span class="c1">#     esa = self._econ_selected_all()</span>
    <span class="c1">#</span>
    <span class="c1">#     full = (</span>
    <span class="c1">#         f.query(&quot;category != &#39;patio_clean&#39;&quot;)</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             esa,</span>
    <span class="c1">#             on=[&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#             how=&quot;inner&quot;,</span>
    <span class="c1">#             suffixes=(None, &quot;_econ&quot;),</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             curtailment,</span>
    <span class="c1">#             on=[&quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#             how=&quot;inner&quot;,</span>
    <span class="c1">#             validate=&quot;m:1&quot;,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .assign(plant_id_prof_site=0)</span>
    <span class="c1">#     )</span>
    <span class="c1">#     LOGGER.warning(&quot;WE ARE LOSING IRP PLANTS THAT DO NOT HAVE UTILITY_IDS&quot;)</span>
    <span class="c1">#     missing_from_econ = (</span>
    <span class="c1">#         f.merge(</span>
    <span class="c1">#             esa.groupby([&quot;ba_code&quot;, &quot;datetime&quot;])</span>
    <span class="c1">#             .agg({&quot;scenario&quot;: lambda x: sorted(set(x))[0]})</span>
    <span class="c1">#             .reset_index(),</span>
    <span class="c1">#             on=[&quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#             how=&quot;inner&quot;,</span>
    <span class="c1">#             validate=&quot;m:1&quot;,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             full[[&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;datetime&quot;]].drop_duplicates(),</span>
    <span class="c1">#             on=[&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#             how=&quot;outer&quot;,</span>
    <span class="c1">#             indicator=True,</span>
    <span class="c1">#             validate=&quot;m:1&quot;,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .query(</span>
    <span class="c1">#             &quot;category not in (&#39;patio_clean&#39;, &#39;system&#39;, &#39;old_clean&#39;) &amp; _merge == &#39;left_only&#39; &amp; utility_id_eia.notna()&quot;</span>
    <span class="c1">#         )</span>
    <span class="c1">#     )</span>
    <span class="c1">#</span>
    <span class="c1">#     full = pd.concat([full, missing_from_econ])</span>
    <span class="c1">#</span>
    <span class="c1">#     techs = list(RE_TECH) + [&quot;Geothermal&quot;, &quot;Nuclear&quot;]</span>
    <span class="c1">#     full = pd.concat(</span>
    <span class="c1">#         [</span>
    <span class="c1">#             full,</span>
    <span class="c1">#             full.query(</span>
    <span class="c1">#                 &quot;technology_description in @techs &amp; category != &#39;existing_xpatio&#39;&quot;</span>
    <span class="c1">#             )</span>
    <span class="c1">#             .assign(</span>
    <span class="c1">#                 redispatch_mwh=lambda x: x.redispatch_mwh * x.re_curtailment_pct,</span>
    <span class="c1">#                 technology_description=&quot;curtailment&quot;,</span>
    <span class="c1">#                 category=&quot;system&quot;,</span>
    <span class="c1">#             )</span>
    <span class="c1">#             .groupby(</span>
    <span class="c1">#                 [</span>
    <span class="c1">#                     &quot;utility_id_eia&quot;,</span>
    <span class="c1">#                     &quot;ba_code&quot;,</span>
    <span class="c1">#                     &quot;scenario&quot;,</span>
    <span class="c1">#                     &quot;datetime&quot;,</span>
    <span class="c1">#                     &quot;technology_description&quot;,</span>
    <span class="c1">#                 ]</span>
    <span class="c1">#             )</span>
    <span class="c1">#             .agg(</span>
    <span class="c1">#                 {</span>
    <span class="c1">#                     &quot;redispatch_mwh&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                     &quot;parent_name&quot;: &quot;first&quot;,</span>
    <span class="c1">#                     &quot;parent_ticker&quot;: &quot;first&quot;,</span>
    <span class="c1">#                     &quot;owner_utility_name_eia&quot;: &quot;first&quot;,</span>
    <span class="c1">#                     &quot;balancing_authority_code_eia&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             )</span>
    <span class="c1">#             .reset_index(),</span>
    <span class="c1">#         ]</span>
    <span class="c1">#     )</span>
    <span class="c1">#</span>
    <span class="c1">#     full = full[</span>
    <span class="c1">#         list(</span>
    <span class="c1">#             dict.fromkeys([&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;])</span>
    <span class="c1">#             | dict.fromkeys(full)</span>
    <span class="c1">#         )</span>
    <span class="c1">#     ]</span>
    <span class="c1">#     allocated = (</span>
    <span class="c1">#         self.by_owner(r)</span>
    <span class="c1">#         .merge(</span>
    <span class="c1">#             esa,</span>
    <span class="c1">#             on=[&quot;utility_id_eia&quot;, &quot;ba_code&quot;, &quot;scenario&quot;, &quot;datetime&quot;],</span>
    <span class="c1">#             how=&quot;inner&quot;,</span>
    <span class="c1">#             suffixes=(None, &quot;_econ&quot;),</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .assign(</span>
    <span class="c1">#             plant_id_eia=lambda x: x.re_plant_id,</span>
    <span class="c1">#             generator_id=lambda x: x.re_generator_id,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .groupby(</span>
    <span class="c1">#             [</span>
    <span class="c1">#                 &quot;utility_id_eia&quot;,</span>
    <span class="c1">#                 &quot;ba_code&quot;,</span>
    <span class="c1">#                 &quot;plant_id_eia&quot;,</span>
    <span class="c1">#                 &quot;generator_id&quot;,</span>
    <span class="c1">#                 &quot;datetime&quot;,</span>
    <span class="c1">#             ]</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .agg(</span>
    <span class="c1">#             {</span>
    <span class="c1">#                 &quot;scenario&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;re_energy&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;storage_li_pct&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;storage_fe_pct&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;storage_h2_pct&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;nuclear_scen&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;ccs_scen&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;excl_or_moth&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;no_limit_prime&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;re_limits_dispatch&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;capacity_mw&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_mwh&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_cost_fom&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 # &#39;implied_need_mw&#39;: &#39;first&#39;,</span>
    <span class="c1">#                 # &#39;implied_need_mwh&#39;: &#39;first&#39;,</span>
    <span class="c1">#                 &quot;category&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;technology_description&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;operating_date&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;ilr&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;duration_hrs&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;roundtrip_eff&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;reserve&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;energy_community&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 # &#39;fos_id&#39;: &#39;first&#39;,</span>
    <span class="c1">#                 # &#39;fos_gen&#39;: &#39;first&#39;,</span>
    <span class="c1">#                 &quot;class_atb&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;plant_id_prof_site&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 # &#39;distance&#39;: &#39;first&#39;,</span>
    <span class="c1">#                 &quot;latitude_nrel_site&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;longitude_nrel_site&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;re_site_id&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;operating_year&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;retirement_year&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;redispatch_mmbtu&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_co2&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_cost_fuel&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_cost_vom&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;redispatch_cost_startup&quot;: &quot;sum&quot;,</span>
    <span class="c1">#                 &quot;owner_utility_name_eia&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;balancing_authority_code_eia&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;parent_name&quot;: &quot;first&quot;,</span>
    <span class="c1">#                 &quot;parent_ticker&quot;: &quot;first&quot;,</span>
    <span class="c1">#             }</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .rename(</span>
    <span class="c1">#             columns={</span>
    <span class="c1">#                 &quot;latitude_nrel_site&quot;: &quot;latitude&quot;,</span>
    <span class="c1">#                 &quot;longitude_nrel_site&quot;: &quot;longitude&quot;,</span>
    <span class="c1">#             }</span>
    <span class="c1">#         )</span>
    <span class="c1">#         .reset_index()</span>
    <span class="c1">#     )</span>
    <span class="c1">#</span>
    <span class="c1">#     return (</span>
    <span class="c1">#         pd.concat([full, allocated])</span>
    <span class="c1">#         .astype({&quot;utility_id_eia&quot;: int})</span>
    <span class="c1">#         .assign(region=lambda x: x.ba_code.map(REGION_MAP))</span>
    <span class="c1">#         .sort_values(</span>
    <span class="c1">#             [</span>
    <span class="c1">#                 &quot;ba_code&quot;,</span>
    <span class="c1">#                 &quot;utility_id_eia&quot;,</span>
    <span class="c1">#                 &quot;plant_id_eia&quot;,</span>
    <span class="c1">#                 &quot;generator_id&quot;,</span>
    <span class="c1">#                 &quot;datetime&quot;,</span>
    <span class="c1">#             ]</span>
    <span class="c1">#         )</span>
    <span class="c1">#     )</span>

<div class="viewcode-block" id="BAs.econ_selected_allocated">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.econ_selected_allocated">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">econ_selected_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="n">patio_by_owner</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">by_owner</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;retirement_date&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="s2">&quot;patio/package_data/ba_rules.csv&quot;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">rule</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">notnull</span><span class="p">(),</span> <span class="s2">&quot;replacement&quot;</span><span class="p">,</span> <span class="s2">&quot;surplus&quot;</span><span class="p">),</span>  <span class="c1"># noqa: PD004</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">patio_by_owner</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_econ_selected_all</span><span class="p">(),</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;scenario&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;_econ&quot;</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.compare_hist_cfl">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.compare_hist_cfl">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_hist_cfl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">f</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;scenario in (&#39;historical&#39;, &#39;counterfactual&#39;) &quot;</span>
                <span class="s2">&quot;&amp; datetime.dt.year in (2021, 2022) &quot;</span>
                <span class="s2">&quot;&amp; category == &#39;existing_fossil&#39;&quot;</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">redispatch_cost_fuel_original</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_cost_fuel_original</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">redispatch_cost_fuel</span>
                <span class="p">),</span>
                <span class="n">total_cost_original</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;redispatch_cost_fuel_original&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_vom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_startup&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_fom&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">total_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;redispatch_cost_fuel&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_vom&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_startup&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redispatch_cost_fom&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s2">&quot;plant_name_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;UNK&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;scenario&quot;</span><span class="p">],</span>
                <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># .query(&quot;historical &gt; 0&quot;)</span>
            <span class="c1"># .assign(pct_diff=lambda x: x.counterfactual / x.historical - 1)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.mcoe_compare">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.mcoe_compare">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">mcoe_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="n">ch1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare_hist_cfl</span><span class="p">(</span>
            <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;redispatch_mwh&quot;</span><span class="p">,</span> <span class="s2">&quot;total_cost_original&quot;</span><span class="p">,</span> <span class="s2">&quot;total_cost&quot;</span><span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">ch1</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">ch1</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ch1</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">cfl_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_cost_counterfactual</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh_counterfactual</span><span class="p">,</span>
                <span class="n">cfl_og_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_cost_original_counterfactual</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh_counterfactual</span><span class="p">,</span>
                <span class="n">hist_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">total_cost_historical</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_mwh_historical</span><span class="p">,</span>
                <span class="n">cfl_total_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_cost_counterfactual</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">redispatch_mwh_counterfactual</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="s2">&quot;sum&quot;</span>
                <span class="p">),</span>
                <span class="n">cfl_og_total_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_cost_original_counterfactual</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">redispatch_mwh_counterfactual</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="s2">&quot;sum&quot;</span>
                <span class="p">),</span>
                <span class="n">hist_total_mcoe</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_cost_historical</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;datetime&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">redispatch_mwh_historical</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                    <span class="s2">&quot;sum&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">ch1</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;cfl_mcoe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cfl_og_mcoe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;hist_mcoe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cfl_total_mcoe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cfl_og_total_mcoe&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;hist_total_mcoe&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="o">+</span> <span class="n">suffix</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BAs.sales861">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.sales861">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sales861</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ba_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Use cast_2022_ba_relationships to get backcasted BAs&quot;</span><span class="p">,</span>
            <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sales</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia861__yearly_sales&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;report_date&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&quot;2007-01-01&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">((</span><span class="s2">&quot;HI&quot;</span><span class="p">,</span> <span class="s2">&quot;AK&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;report_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;historical_year&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;sales_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Attempt at re-allocating sales, but it doesn&#39;t work</span>
        <span class="c1"># ba_allocations = sales.filter(</span>
        <span class="c1">#     pl.col(&quot;historical_year&quot;) == pl.col(&quot;historical_year&quot;).max()</span>
        <span class="c1"># ).select(</span>
        <span class="c1">#     &quot;utility_id_eia&quot;,</span>
        <span class="c1">#     &quot;state&quot;,</span>
        <span class="c1">#     pl.col(&quot;balancing_authority_code_eia&quot;).alias(&quot;ba_from_allocation&quot;),</span>
        <span class="c1">#     pct=(</span>
        <span class="c1">#         pl.col(&quot;retail_sales_mwh&quot;)</span>
        <span class="c1">#         / pl.col(&quot;retail_sales_mwh&quot;)</span>
        <span class="c1">#         .sum()</span>
        <span class="c1">#         .over(</span>
        <span class="c1">#             &quot;utility_id_eia&quot;,</span>
        <span class="c1">#             &quot;state&quot;,</span>
        <span class="c1">#         )</span>
        <span class="c1">#     ).fill_nan(1.0),</span>
        <span class="c1"># )</span>
        <span class="c1">#</span>
        <span class="c1"># allocated_sales = (</span>
        <span class="c1">#     sales.with_columns(</span>
        <span class="c1">#         util_state_sales=pl.col(&quot;retail_sales_mwh&quot;)</span>
        <span class="c1">#         .sum()</span>
        <span class="c1">#         .over(&quot;utility_id_eia&quot;, &quot;state&quot;, &quot;historical_year&quot;)</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .join(ba_allocations, on=[&quot;utility_id_eia&quot;, &quot;state&quot;], how=&quot;outer&quot;)</span>
        <span class="c1">#     .select(</span>
        <span class="c1">#         &quot;historical_year&quot;,</span>
        <span class="c1">#         &quot;utility_id_eia&quot;,</span>
        <span class="c1">#         &quot;utility_name_eia&quot;,</span>
        <span class="c1">#         &quot;state&quot;,</span>
        <span class="c1">#         &quot;ba_from_allocation&quot;,</span>
        <span class="c1">#         &quot;balancing_authority_code_eia&quot;,</span>
        <span class="c1">#         &quot;retail_sales_mwh&quot;,</span>
        <span class="c1">#         allocated_sales=pl.col(&quot;util_state_sales&quot;) * pl.col(&quot;pct&quot;),</span>
        <span class="c1">#         n_bas=pl.col(&quot;ba_from_allocation&quot;)</span>
        <span class="c1">#         .n_unique()</span>
        <span class="c1">#         .over(&quot;utility_id_eia&quot;, &quot;state&quot;, &quot;historical_year&quot;),</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .sort(</span>
        <span class="c1">#         &quot;historical_year&quot;,</span>
        <span class="c1">#         &quot;utility_id_eia&quot;,</span>
        <span class="c1">#         &quot;state&quot;,</span>
        <span class="c1">#         &quot;ba_from_allocation&quot;,</span>
        <span class="c1">#         &quot;balancing_authority_code_eia&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .group_by(</span>
        <span class="c1">#         &quot;historical_year&quot;,</span>
        <span class="c1">#         &quot;utility_id_eia&quot;,</span>
        <span class="c1">#         &quot;state&quot;,</span>
        <span class="c1">#         &quot;ba_from_allocation&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .agg(pl.col(&quot;utility_name_eia&quot;, &quot;allocated_sales&quot;).first())</span>
        <span class="c1"># )</span>

        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span>
            <span class="n">sales</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="n">add_ba_code</span><span class="p">,</span>
                <span class="n">new_ba_col</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">apply_purchaser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">drop_interim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ba_rollup_only</span><span class="o">=</span><span class="n">ba_only</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.cast_2022_ba_relationships">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.cast_2022_ba_relationships">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cast_2022_ba_relationships</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># step 1) clean up and aggregate 861</span>
        <span class="n">coop_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">ROOT_PATH</span> <span class="o">/</span> <span class="s2">&quot;r_data/coop_ba_code_remap.parquet&quot;</span><span class="p">)</span>
        <span class="n">transformed_sales</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia861__yearly_sales&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;report_date&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">((</span><span class="s2">&quot;HI&quot;</span><span class="p">,</span> <span class="s2">&quot;AK&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">coop_map</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;dist_utility_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ba_code&quot;</span><span class="p">:</span> <span class="s2">&quot;ba_code_coop_map&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)[[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code_coop_map&quot;</span><span class="p">]],</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">balancing_authority_code_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ba_code_coop_map&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">(),</span>
                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ba_code_coop_map&quot;</span><span class="p">],</span>
                    <span class="n">x</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;report_date &gt; &quot;2007-01-01&quot; &amp; state != &quot;HI&quot; &amp; state != &quot;AK&quot;&#39;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">report_date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">historical_year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;report_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;sales_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;sales_mwh&quot;</span><span class="p">:</span> <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># step 2) get unique reported bas at utility state level</span>
        <span class="c1"># for the last year in which that utility reported to 861</span>
        <span class="c1"># max n bas is 8</span>

        <span class="c1"># step A: split up all unique bas for each utility/state/year combination</span>

        <span class="n">split_bas</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">transformed_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">])[</span>
                <span class="s2">&quot;balancing_authority_code_eia&quot;</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">clean_ba</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">)[</span><span class="s2">&quot;clean_ba&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># step B: get utility, state, year index for concat</span>
        <span class="n">unique_bas</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">transformed_sales</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">])[</span>
                <span class="s2">&quot;balancing_authority_code_eia&quot;</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># bas_last_report_year = (</span>
        <span class="c1">#     pd.concat([unique_bas, split_bas], axis=1)</span>
        <span class="c1">#     .rename(</span>
        <span class="c1">#         columns={</span>
        <span class="c1">#             0: &quot;ba_code_1&quot;,</span>
        <span class="c1">#             1: &quot;ba_code_2&quot;,</span>
        <span class="c1">#             2: &quot;ba_code_3&quot;,</span>
        <span class="c1">#             3: &quot;ba_code_4&quot;,</span>
        <span class="c1">#             4: &quot;ba_code_5&quot;,</span>
        <span class="c1">#             5: &quot;ba_code_6&quot;,</span>
        <span class="c1">#             6: &quot;ba_code_7&quot;,</span>
        <span class="c1">#             7: &quot;ba_code_8&quot;,</span>
        <span class="c1">#         }</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .melt(</span>
        <span class="c1">#         id_vars=[&quot;utility_id_eia&quot;, &quot;state&quot;, &quot;historical_year&quot;],</span>
        <span class="c1">#         value_vars=[</span>
        <span class="c1">#             &quot;ba_code_1&quot;,</span>
        <span class="c1">#             &quot;ba_code_2&quot;,</span>
        <span class="c1">#             &quot;ba_code_3&quot;,</span>
        <span class="c1">#             &quot;ba_code_4&quot;,</span>
        <span class="c1">#             &quot;ba_code_5&quot;,</span>
        <span class="c1">#             &quot;ba_code_6&quot;,</span>
        <span class="c1">#             &quot;ba_code_7&quot;,</span>
        <span class="c1">#             &quot;ba_code_8&quot;,</span>
        <span class="c1">#         ],</span>
        <span class="c1">#         value_name=&quot;balancing_authority_code_eia&quot;,</span>
        <span class="c1">#         var_name=&quot;n_ba_code&quot;,</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .query(&quot;balancing_authority_code_eia.notnull()&quot;)</span>
        <span class="c1">#     .drop(columns=[&quot;n_ba_code&quot;])</span>
        <span class="c1"># )</span>

        <span class="c1"># step C: concat to get pivoted out like columns, then melt for merge</span>
        <span class="n">bas_last_report_year</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">unique_bas</span><span class="p">,</span> <span class="n">split_bas</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;ba_code_1&quot;</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;ba_code_2&quot;</span><span class="p">,</span>
                    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;ba_code_3&quot;</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;ba_code_4&quot;</span><span class="p">,</span>
                    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;ba_code_5&quot;</span><span class="p">,</span>
                    <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;ba_code_6&quot;</span><span class="p">,</span>
                    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;ba_code_7&quot;</span><span class="p">,</span>
                    <span class="mi">7</span><span class="p">:</span> <span class="s2">&quot;ba_code_8&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
                <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">],</span>
                <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;ba_code_1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_6&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_7&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code_8&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">value_name</span><span class="o">=</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;n_ba_code&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;balancing_authority_code_eia.notnull()&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;n_ba_code&quot;</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="c1"># calculate ba share of each utility/state combo&#39;s total sales</span>
        <span class="n">ba_sales_share_2022</span> <span class="o">=</span> <span class="n">transformed_sales</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">balancing_authority_code_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">x</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;UNK&quot;</span><span class="p">,</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">,</span>
                <span class="n">x</span><span class="p">[</span><span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">ba_share_of_latest_state_sales</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)[</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">])[</span>
                <span class="s2">&quot;retail_sales_mwh&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;sum&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">bas_last_report_year</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)[</span>
            <span class="c1"># leave sales_mwh column out since we only care about latest ba&#39;s and share</span>
            <span class="p">[</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ba_share_of_latest_state_sales&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">ba_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bas</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">transformed_sales</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;utility_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ba_sales_share_2022</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">retail_sales_mwh</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;ba_share_of_latest_state_sales&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)[</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="n">add_ba_code</span><span class="p">,</span>
                <span class="n">new_ba_col</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">apply_purchaser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">drop_interim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">ba_rollup_only</span><span class="o">=</span><span class="n">ba_only</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.compare_rmodel_to_sales">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.compare_rmodel_to_sales">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_rmodel_to_sales</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">full</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="c1"># making way to convert sales in historical years to sales in future operating years</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span>
            <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">),</span>
            <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">sales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sales861</span><span class="p">()</span>
        <span class="n">sales_suma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sales</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;historical_year&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">res_out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;scenario&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">operating_year</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">))</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;redispatch_curt_adj_mwh&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">res_out</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sales_suma</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">coalesce</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace_strict</span><span class="p">(</span><span class="n">INTERCON_MAP</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;interconnect&quot;</span><span class="p">),</span>
                <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;redispatch_curt_adj_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;redispatch_curt_adj_mwh&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span>
                    <span class="s2">&quot;pct_diff&quot;</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.backup_utility_name_entity">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.backup_utility_name_entity">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">backup_utility_name_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia861__yearly_sales&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;data_maturity&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&quot;final&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_type&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">())</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace_strict</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Municipal&quot;</span><span class="p">:</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Behind the Meter&quot;</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Retail Power Marketer&quot;</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Wholesale Power Marketer&quot;</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Unregulated&quot;</span><span class="p">:</span> <span class="s2">&quot;Unregulated&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Facility&quot;</span><span class="p">:</span> <span class="s2">&quot;Facility&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Political Subdivision&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Federal&quot;</span><span class="p">:</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Community Choice Aggregator&quot;</span><span class="p">:</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Power Marketer&quot;</span><span class="p">:</span> <span class="s2">&quot;Q&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Investor Owned&quot;</span><span class="p">:</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;State&quot;</span><span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Cooperative&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># .collect()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.get_util_ids">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.get_util_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_util_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of utility_id_eia based on name_pattern.</span>

<span class="sd">        Args:</span>
<span class="sd">            name_pattern: pattern to match against utility_name_eia</span>
<span class="sd">                in core_eia861__yearly_sales</span>

<span class="sd">        Returns: tuple of utility_id_eia</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># noqa: A001</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia861__yearly_sales&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">))</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="o">.</span><span class="n">is_empty</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find any utilities matching </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">all</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="BAs.by_lse">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.by_lse">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">by_lse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">least_cost</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get results by LSE.</span>

<span class="sd">        Get results by LSE by calculating transactions based on EIA 861</span>

<span class="sd">        Args:</span>
<span class="sd">            least_cost: if True get results for least cost scenario,</span>
<span class="sd">                otherwise max earnings</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: D414</span>
        <span class="n">disc_col</span> <span class="o">=</span> <span class="s2">&quot;Disc&quot;</span>
        <span class="n">full</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>

        <span class="c1"># add patio BA codes to sales, this might be the first step down a</span>
        <span class="c1"># bad path...</span>
        <span class="c1"># sales = self.sales861()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Now include purchase/sales but still work needed to fully get results by LSE.&quot;</span><span class="p">,</span>
            <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sales</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cast_2022_ba_relationships</span><span class="p">())</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;NBSO&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;NYIS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">):</span>
            <span class="n">sales</span> <span class="o">=</span> <span class="n">sales</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;NYIS&quot;</span><span class="p">)</span>

        <span class="n">econ_results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">())</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">least_cost</span> <span class="k">else</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">not_</span><span class="p">())</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;historical_actuals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">ba_code</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                <span class="n">portfolio</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="c1"># Test that MWh match between econ and resource results in counterfactual</span>
        <span class="n">econ_suma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">econ_results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;econ_mwh&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">res_suma</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;scenario == &#39;counterfactual&#39;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s2">&quot;redispatch_curt_adj_mwh&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">econ_suma</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">res_suma</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">compare</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">econ_mwh</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_curt_adj_mwh</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">),</span>
            <span class="n">compare2</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">econ_mwh</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">redispatch_curt_adj_mwh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">comp</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">econ_mwh</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">redispatch_curt_adj_mwh</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="n">bad</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;BA MWh do not match for counterfactual scenarios between econ and resource results&quot;</span>
        <span class="p">)</span>

        <span class="c1"># extend historical / operating year map beyond 2039</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span>
            <span class="n">full</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">),</span>
            <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">addl_years</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="mi">2040</span><span class="p">,</span> <span class="n">econ_results</span><span class="p">[</span><span class="s2">&quot;operating_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="mi">9</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2036</span><span class="p">)[</span><span class="s2">&quot;historical_year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
            <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">hist_year_map</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">addl_years</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>

        <span class="c1"># checking BA changes</span>

        <span class="c1"># sales_ = sales.group_by(&quot;utility_id_eia&quot;, &quot;ba_code&quot;)</span>

        <span class="n">sales_</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sales</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="c1"># roll up sales to BA/util level</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;historical_year&quot;</span><span class="p">)</span>
            <span class="c1"># map on future operating year based on assigned historical year, inner</span>
            <span class="c1"># join downselects for us</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hist_year_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;historical_year&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">econ_results</span><span class="p">[</span><span class="s2">&quot;operating_year&quot;</span><span class="p">]))</span>
            <span class="c1"># regroup by operating year and add utility_type</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="n">maintain_order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">utility_type</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;LSE&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">util_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_type</span><span class="p">()</span>

        <span class="n">merged</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c1"># aggregate econ results to uitlity / year level and calculate LCOE</span>
            <span class="n">econ_results</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;MWh_Disc&quot;</span><span class="p">,</span> <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span> <span class="s2">&quot;Emissions&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="n">disc_col</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">lcoe</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh_Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh_Disc&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span>
                <span class="n">emission_intensity</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh_Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Emissions&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh_Disc&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="c1"># # add on historical year</span>
            <span class="c1"># .join(</span>
            <span class="c1">#     hist_year_map.select(&quot;operating_year&quot;, &quot;historical_year&quot;),</span>
            <span class="c1">#     on=&quot;operating_year&quot;,</span>
            <span class="c1">#     how=&quot;left&quot;,</span>
            <span class="c1"># )</span>
            <span class="c1"># join on 861 retail sales</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">sales_</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
                <span class="n">coalesce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;GEN&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># bring util types and names</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">util_info</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;lcoe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;emission_intensity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="c1"># &quot;sales_revenue&quot;,</span>
                <span class="c1"># &quot;historical_year&quot;,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">disc_col</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">disc_col</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_type&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">disc_col</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># for LSE only utilities need to create identical selected and counterfactual versions</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()),</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                        <span class="n">portfolio</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">merged</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">())</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                        <span class="n">portfolio</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">ba_sfr_total_mwh</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">),</span>
                <span class="n">ba_purchase_total_mwh</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">ba_weighted_price</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;lcoe&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_sfr_total_mwh&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">ba_weighted_intensity</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;emission_intensity&quot;</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span>
                    <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_sfr_total_mwh&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">ba_level</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;ba_weighted_price&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;ba_weighted_intensity&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace_strict</span><span class="p">(</span><span class="n">INTERCON_MAP</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;ERCO&quot;</span><span class="p">:</span> <span class="s2">&quot;western&quot;</span><span class="p">},</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;interconnect&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">inter_sfr_total_mwh</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">),</span>
                <span class="c1"># inter_purchase_total_mwh=pl.col(&quot;purchase_mwh&quot;)</span>
                <span class="c1"># .sum()</span>
                <span class="c1"># .over(&quot;portfolio&quot;, &quot;interconnect&quot;, &quot;operating_year&quot;),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">inter_weighted_price</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_weighted_price&quot;</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span>
                    <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;inter_sfr_total_mwh&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
                <span class="n">inter_weighted_intensity</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_weighted_intensity&quot;</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span>
                    <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;inter_sfr_total_mwh&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_nan</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">issues</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ba_level</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pct_diff</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;retail_sales_mwh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pct_diff&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;interconnect&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="s2">&quot;pct_diff&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">],</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;interconnect&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_string</span><span class="p">()</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Interconnect mismatches </span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">issues</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">ba_level</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;inter_weighted_price&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;inter_weighted_intensity&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span> <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pct_purchased_from_ba</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_sfr_total_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_purchase_total_mwh&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_sfr_total_mwh&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_purchase_total_mwh&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Utility_ID&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;selected&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;counterfactual_baseline&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;historical_actuals&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">econ_results</span><span class="p">[</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;scenario&quot;</span><span class="p">),</span>
                <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pct_purchased_from_ba&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_weighted_price&quot;</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pct_purchased_from_ba&quot;</span><span class="p">))</span>
                        <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;inter_weighted_price&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="o">-</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;lcoe&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Costs&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pct_purchased_from_ba&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_weighted_intensity&quot;</span><span class="p">)</span>
                        <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;pct_purchased_from_ba&quot;</span><span class="p">))</span>
                        <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;inter_weighted_intensity&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="o">-</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;emission_intensity&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Emissions&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;purchase_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Purchases&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sfr_mwh&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Sales for Resale&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;drop&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">),</span>
                <span class="n">disc_col</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">Costs_Disc</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Costs&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">disc_col</span><span class="p">),</span>
                <span class="n">MWh_Disc</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">disc_col</span><span class="p">),</span>
                <span class="n">category</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;transaction&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;drop&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">econ_results</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">),</span>
                    <span class="s2">&quot;refi_trigger&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;savings_tol&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;earnings_thresh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;least_cost&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Debt_Repl_EIR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Equity_Repl_EIR&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">econ_results</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;Utility_ID&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parent_ticker&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;entity_type&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">econ_results</span><span class="o">.</span><span class="n">lazy</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># load-only LSEs don&#39;t have entity_types from econ_results</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">util_info</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_type&quot;</span><span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_type_right&quot;</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;entity_type_right&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># sellers = (</span>
        <span class="c1">#     merged.filter(pl.col(&quot;net_purchases&quot;) &lt; 0.0)</span>
        <span class="c1">#     .with_columns(</span>
        <span class="c1">#         ba_sales=pl.col(&quot;net_purchases&quot;)</span>
        <span class="c1">#         .sum()</span>
        <span class="c1">#         .over(&quot;portfolio&quot;, &quot;ba_code&quot;, &quot;operating_year&quot;),</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .with_columns(</span>
        <span class="c1">#         weighted_cost_contribution=pl.col(&quot;lcoe&quot;)</span>
        <span class="c1">#         * pl.col(&quot;net_purchases&quot;)</span>
        <span class="c1">#         / pl.col(&quot;ba_sales&quot;)</span>
        <span class="c1">#     )</span>
        <span class="c1">#     .with_columns(</span>
        <span class="c1">#         weighted_cost=pl.col(&quot;weighted_cost_contribution&quot;)</span>
        <span class="c1">#         .sum()</span>
        <span class="c1">#         .over(&quot;portfolio&quot;, &quot;ba_code&quot;, &quot;operating_year&quot;)</span>
        <span class="c1">#     )</span>
        <span class="c1"># )</span>
        <span class="c1">#</span>
        <span class="c1"># buyers = merged.filter(pl.col(&quot;net_purchases&quot;) &gt;= 0.0)</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;not all columns fully implemented in purchase/sales block&quot;</span><span class="p">,</span>
            <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">econ_results</span><span class="o">.</span><span class="n">lazy</span><span class="p">(),</span> <span class="n">out</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;diagonal_relaxed&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">sales</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">]))</span>
                <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;LSE&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;GEN&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;utility_type&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># , sellers</span></div>


<div class="viewcode-block" id="BAs.utility_type">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.utility_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">utility_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">util_info</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;out_eia__yearly_utilities&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;data_maturity&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">,</span> <span class="s2">&quot;entity_type&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;report_date&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">backup_utility_name_entity</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
                <span class="n">coalesce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">())</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_name_eia_right&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_type_right&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;entity_type&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">util_info</span></div>


<div class="viewcode-block" id="BAs.by_lse_fig">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.by_lse_fig">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">by_lse_fig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">util_ids</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bar chart showing MW, MWh, and discounted cost for selected and BAU</span>
<span class="sd">        portfolios for selected utilities</span>

<span class="sd">        Args:</span>
<span class="sd">            util_ids: can be a single utility_id_eia, a sequence of utility_id_eia,</span>
<span class="sd">                a pattern matched on utility_name_eia from core_eia861__yearly_sales,</span>
<span class="sd">                the default is None and results in a figure that aggregates all</span>
<span class="sd">                utilities together, including gen-only ones</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">util_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">util_ids</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">util_ids</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">util_ids</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_util_ids</span><span class="p">(</span><span class="n">util_ids</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">util_ids</span><span class="p">))</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">blse</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">category</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;old_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;existing_xpatio&quot;</span><span class="p">}),</span>
                <span class="n">technology_description</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">PLOT_MAP</span>
                    <span class="o">|</span> <span class="p">{</span>
                        <span class="s2">&quot;NaturalGas_FE&quot;</span><span class="p">:</span> <span class="s2">&quot;Other Fossil&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Hydroelectric Pumped Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Hydro&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Solar Thermal with Energy Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Solar Thermal without Energy Storage&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Other Natural Gas&quot;</span><span class="p">:</span> <span class="s2">&quot;Other Fossil&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Flywheels&quot;</span><span class="p">:</span> <span class="s2">&quot;Storage&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="n">portfolio</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">:</span> <span class="s2">&quot;bau&quot;</span><span class="p">}),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="s2">&quot;MW&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="c1"># &quot;generator_id&quot;,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;MW&quot;</span><span class="p">),</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
                <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="c1"># &quot;operating_year&quot;</span>
                <span class="p">],</span>
                <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;MW&quot;</span><span class="p">,</span> <span class="s2">&quot;MWh&quot;</span><span class="p">,</span> <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;Transmission&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;variable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;MW&quot;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">not_</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">),</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="n">facet_col</span><span class="o">=</span><span class="s2">&quot;variable&quot;</span><span class="p">,</span>
            <span class="n">facet_col_spacing</span><span class="o">=</span><span class="mf">0.075</span><span class="p">,</span>
            <span class="n">color_discrete_map</span><span class="o">=</span><span class="n">COLOR_MAP</span>
            <span class="o">|</span> <span class="p">{</span>
                <span class="s2">&quot;Purchases&quot;</span><span class="p">:</span> <span class="s2">&quot;#a7a9ac&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Sales for Resale&quot;</span><span class="p">:</span> <span class="s2">&quot;#a7a9ac&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Transmission&quot;</span><span class="p">:</span> <span class="s2">&quot;#58585b&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">showticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.cr_site_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.cr_site_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cr_site_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">least_cost</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">er</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">least_cost</span>
            <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~least_cost&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">by</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ba_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;re_plant_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;re_generator_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">er</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">er</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category == &#39;patio_clean&#39; &amp; is_irp_year&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;re_plant_id&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="o">*</span><span class="n">by</span><span class="p">,</span> <span class="s2">&quot;operating_year&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;parent_ticker&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;balancing_authority_code_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;scenario&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sensitivity&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;last&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">|</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="s2">&quot;Capex&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Costs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;No_Policy_Capex_Costs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Fuel_Costs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;FOM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;VOM&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Startup_Costs&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Opex&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh_no_curt&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Earnings&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions_Reduced&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Disc_E&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Capex_Costs_Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;No_Policy_Capex_Costs_Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Opex_Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh_Disc&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Earnings_Disc&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">DataZip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ba</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_objs</span><span class="p">:</span>
                <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z0</span><span class="p">[</span><span class="n">ba</span><span class="p">,</span> <span class="s2">&quot;re_plant_specs&quot;</span><span class="p">])</span>
        <span class="n">re_specs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">specs</span><span class="p">)[</span>
            <span class="p">[</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_gen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude_nrel_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude_nrel_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_cap&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_var_mwh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sc_gid&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capacity_factor&quot;</span><span class="p">,</span>
                <span class="s2">&quot;global_horizontal_irradiance&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capacity_mw_nrel_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;area_sq_km&quot;</span><span class="p">,</span>
                <span class="s2">&quot;distance_to_transmission_km&quot;</span><span class="p">,</span>
                <span class="s2">&quot;class_atb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capex_atb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cf_atb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fom_atb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plant_id_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;latitude_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;longitude_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cf_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cf_ilr_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;distance_prof_site&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wind_speed_120meters&quot;</span><span class="p">,</span>
                <span class="s2">&quot;wind_speed_150meters&quot;</span><span class="p">,</span>
                <span class="s2">&quot;landfall_distance_to_transmission_km&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bathymetry_meters&quot;</span><span class="p">,</span>
                <span class="s2">&quot;distance_to_coast_km&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re_site_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;energy_community&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lcoe&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ilr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;area_per_mw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;total_norm_match&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re_site_gen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re_cost&quot;</span><span class="p">,</span>
                <span class="s2">&quot;avoided_cost&quot;</span><span class="p">,</span>
                <span class="s2">&quot;re_max_obj_coef&quot;</span><span class="p">,</span>
                <span class="s2">&quot;energy_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cap_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;savings_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;capacity_max_re_scen&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">:</span> <span class="s2">&quot;re_plant_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_id&quot;</span><span class="p">:</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_gen&quot;</span><span class="p">:</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">er</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">re_specs</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;re_plant_id&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.gen_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.gen_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">gen_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_tx</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a list of plant-techs and the CR opportunity at them.</span>

<span class="sd">        Args:</span>
<span class="sd">            cr_only: defualt is True, if False include all plants, not just the ones with CR</span>
<span class="sd">            sort_cols: clean up the column names and order, only tested with cr_only=False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fix_ids</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;6452&quot;</span><span class="p">,</span> <span class="s2">&quot;7801&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;10005&quot;</span><span class="p">,</span> <span class="s2">&quot;22500&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;10171&quot;</span><span class="p">,</span> <span class="s2">&quot;11249&quot;</span><span class="p">)]:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">owner_utility_id_eia</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;next_irp_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="s2">&quot;next_irp_date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">]}</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">owner_utility_id_eia</span> <span class="o">!=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">to_add</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>

        <span class="n">coals</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ANT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIT&quot;</span><span class="p">,</span> <span class="s2">&quot;LIG&quot;</span><span class="p">,</span> <span class="s2">&quot;SGC&quot;</span><span class="p">,</span> <span class="s2">&quot;SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;WC&quot;</span><span class="p">,</span> <span class="s2">&quot;RC&quot;</span><span class="p">,</span> <span class="s2">&quot;SC&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia860__scd_generators&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operational_status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;proposed&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Coal&quot;</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">suf</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;, Inc.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Inc.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LLC.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LLC.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, L.L.C.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; L.L.C.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LLC&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LLC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Corp.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Corp.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Corp&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Corp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LP.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LP.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, L.P.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; L.P.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LP&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Membershipration&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">er_sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">er_sensitivity</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">objective</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">least_cost</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;least_cost&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;max_earnings&quot;</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># repowered = base.query(&quot;category == &#39;patio_clean&#39;&quot;).plant_id_eia.unique()</span>
        <span class="n">all_techs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">clean_repowering_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">replacement</span>
                    <span class="o">&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">cr_eligible</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2100</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2035</span><span class="p">),</span>
                    <span class="s2">&quot;replacement&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">surplus</span>
                        <span class="o">&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">cr_eligible</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2035</span><span class="p">),</span>
                        <span class="s2">&quot;surplus&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;no_cr&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;clean_repowering_type&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;no_cr&quot;</span><span class="p">))</span>  <span class="c1"># noqa: C401</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category == &#39;existing_fossil&#39;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">MW</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;MW&quot;</span><span class="p">],</span>
                <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)[[</span><span class="s2">&quot;parent_name&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">]]</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">parent_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">parent_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suf</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;Generation &amp; Transmission Association&quot;</span><span class="p">,</span> <span class="s2">&quot;G&amp;T&quot;</span>
                <span class="p">),</span>
                <span class="n">owner_utility_name_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">owner_utility_name_eia</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suf</span><span class="p">),</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Generation &amp; Transmission Association&quot;</span><span class="p">,</span> <span class="s2">&quot;G&amp;T&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="n">cr_agg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">re_rename</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Onshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Offshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar Photovoltaic&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">base_with_tech</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s2">&quot;category in (&#39;patio_clean&#39;, &#39;existing_fossil&#39;, &#39;refinancing&#39;, &#39;transmission_lines&#39;)&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">all_techs</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_o&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">clean_rep</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base_with_tech</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">cr_agg</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">cr_agg</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># join on costs by category (fossil incumbent vs CR)</span>
                <span class="n">base_with_tech</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;existing_fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;refinancing&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;patio_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;transmission_lines&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># bring in CR capactiy</span>
                <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category in (&#39;patio_clean&#39;,)&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">clean_tech</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">re_rename</span><span class="p">))</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">all_techs</span><span class="p">,</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_o&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;clean_tech&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">MW</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;clean_tech&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span>
                    <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span> <span class="k">if</span> <span class="n">cr_only</span> <span class="k">else</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">total_clean</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span>
                    <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Solar&quot;</span><span class="p">,</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">clean_rep</span> <span class="o">=</span> <span class="n">clean_rep</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span>
            <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                <span class="n">c</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Disc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Batteries&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;total_clean&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clean_rep</span>
            <span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># clean_rep.columns=list(map(&quot;_&quot;.join, clean_rep.columns))</span>
        <span class="c1"># clean_rep = clean_rep.set_axis(list(map(&quot;_&quot;.join, clean_rep.columns)), axis=1).reset_index(level=&quot;Disc&quot;)</span>
        <span class="k">with</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="s2">&quot;az://patio-data/20241031/Copy of IRP Service 37_EQ Research_RMI_8.31.23.xlsx&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">irp_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">,</span>
                    <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;IRP Data&quot;</span><span class="p">,</span>
                    <span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;np.nan&quot;</span><span class="p">],</span>
                    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EIA ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Anticipated Date for Next IRP&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;EIA ID&quot;</span><span class="p">:</span> <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Anticipated Date for Next IRP&quot;</span><span class="p">:</span> <span class="s2">&quot;next_irp_date&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fix_ids</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">clean_rep</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">clean_rep</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Disc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc_max_earnings</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Disc_least_cost</span><span class="p">))</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Disc_max_earnings&quot;</span><span class="p">,</span> <span class="s2">&quot;Disc_least_cost&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">er_sensitivity</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;least_cost &amp; counterfactual_baseline &amp; ~selected &amp; category in (&#39;existing_fossil&#39;,)&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span> <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">rank_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_clean_max_earnings</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;total_clean_least_cost&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">rank_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_clean_least_cost</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">capacity</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="n">PLOT_MAP</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">clean_repowering_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">clean_repowering_type</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">total_clean_max_earnings</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">total_clean_least_cost</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">),</span>
                <span class="n">annualized_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_least_cost</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_fossil_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_Fossil_least_cost</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_cr_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_CR_least_cost</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_max_earnings</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_fossil_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_Fossil_max_earnings</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_cr_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_CR_max_earnings</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_npv_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_cfl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">utilization_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_least_cost</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">utilization_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_max_earnings</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">utilization_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_cfl</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">annual_emissions_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_least_cost</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">annual_emissions_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_max_earnings</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">annual_emissions_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_cfl</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">irp_data</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">coal_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">plant_id_eia</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">c2</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">cr</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;annualized_fossil_npv_max_earnings&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;annualized_cr_npv_max_earnings&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_max_earnings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_max_earnings</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Max Earnings NPVs don&#39;t add up&quot;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">cr</span><span class="p">[[</span><span class="s2">&quot;annualized_fossil_npv_least_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;annualized_cr_npv_least_cost&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">),</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_least_cost</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_least_cost</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Least Cost NPVs don&#39;t add up&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_cols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cr</span>
        <span class="n">prm</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">,</span>
            <span class="s2">&quot;region&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean_repowering_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_clean_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Batteries_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Batteries_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wind_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wind_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_CR_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_CR_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_Fossil_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_Fossil_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_fossil_npv_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_cr_npv_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_fossil_npv_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_cr_npv_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_npv_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;next_irp_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coal_site&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">cr</span><span class="p">[</span><span class="n">prm</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_cfl&quot;</span><span class="p">,</span> <span class="s2">&quot;_bau&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prm</span><span class="p">})</span></div>


<div class="viewcode-block" id="BAs.plant_list">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.plant_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plant_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cr_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sort_cols</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_tx</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>  <span class="c1"># noqa: D417</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a list of plant-techs and the CR opportunity at them.</span>

<span class="sd">        Args:</span>
<span class="sd">            cr_only: defualt is True, if False include all plants, not just the ones with CR</span>
<span class="sd">            sort_cols: clean up the column names and order, only tested with cr_only=False</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fix_ids</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="n">to_add</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;6452&quot;</span><span class="p">,</span> <span class="s2">&quot;7801&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;10005&quot;</span><span class="p">,</span> <span class="s2">&quot;22500&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;10171&quot;</span><span class="p">,</span> <span class="s2">&quot;11249&quot;</span><span class="p">)]:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">owner_utility_id_eia</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;next_irp_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">],</span> <span class="s2">&quot;next_irp_date&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">]}</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">owner_utility_id_eia</span> <span class="o">!=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="n">to_add</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>

        <span class="n">coals</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ANT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIT&quot;</span><span class="p">,</span> <span class="s2">&quot;LIG&quot;</span><span class="p">,</span> <span class="s2">&quot;SGC&quot;</span><span class="p">,</span> <span class="s2">&quot;SUB&quot;</span><span class="p">,</span> <span class="s2">&quot;WC&quot;</span><span class="p">,</span> <span class="s2">&quot;RC&quot;</span><span class="p">,</span> <span class="s2">&quot;SC&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia860__scd_generators&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operational_status&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;proposed&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Coal&quot;</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_2&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                    <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;energy_source_code_6&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">coals</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">suf</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;, Inc.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Inc.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Inc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LLC.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LLC.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, L.L.C.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; L.L.C.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LLC&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LLC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Corp.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Corp.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, Corp&quot;</span><span class="p">,</span>
            <span class="s2">&quot; Corp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LP.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LP.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, L.P.&quot;</span><span class="p">,</span>
            <span class="s2">&quot; L.P.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;, LP&quot;</span><span class="p">,</span>
            <span class="s2">&quot; LP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Membershipration&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">er_sensitivity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;is_irp_year&quot;</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">er_sensitivity</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">objective</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">least_cost</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s2">&quot;least_cost&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span> <span class="s2">&quot;max_earnings&quot;</span><span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># repowered = base.query(&quot;category == &#39;patio_clean&#39;&quot;).plant_id_eia.unique()</span>
        <span class="n">all_techs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">[[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">]]</span>
        <span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">clean_repowering_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">replacement</span>
                    <span class="o">&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">cr_eligible</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2100</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2035</span><span class="p">),</span>
                    <span class="s2">&quot;replacement&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">surplus</span>
                        <span class="o">&amp;</span> <span class="n">x</span><span class="o">.</span><span class="n">cr_eligible</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">retirement_date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">2100</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2035</span><span class="p">),</span>
                        <span class="s2">&quot;surplus&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;no_cr&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;capacity_mw&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;clean_repowering_type&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s2">&quot;no_cr&quot;</span><span class="p">))</span>  <span class="c1"># noqa: C401</span>
                    <span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category == &#39;existing_fossil&#39;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">MW</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;MW&quot;</span><span class="p">],</span>
                <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
                <span class="p">[</span><span class="s2">&quot;parent_name&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">parent_name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">parent_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suf</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;Generation &amp; Transmission Association&quot;</span><span class="p">,</span> <span class="s2">&quot;G&amp;T&quot;</span>
                <span class="p">),</span>
                <span class="n">owner_utility_name_eia</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">owner_utility_name_eia</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">suf</span><span class="p">),</span> <span class="s2">&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Generation &amp; Transmission Association&quot;</span><span class="p">,</span> <span class="s2">&quot;G&amp;T&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">})</span>
        <span class="p">)</span>

        <span class="n">cr_agg</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">re_rename</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Onshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Offshore Wind Turbine&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar Photovoltaic&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">include_tx</span><span class="p">:</span>
            <span class="n">base_</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="s2">&quot;category in (&#39;patio_clean&#39;, &#39;existing_fossil&#39;, &#39;refinancing&#39;, &#39;transmission_lines&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category in (&#39;patio_clean&#39;, &#39;existing_fossil&#39;, &#39;refinancing&#39;)&quot;</span><span class="p">)</span>

        <span class="n">base_with_tech</span> <span class="o">=</span> <span class="n">base_</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">all_techs</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_o&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">clean_rep</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">base_with_tech</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">cr_agg</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;mean&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">cr_agg</span> <span class="o">|</span> <span class="p">{</span><span class="s2">&quot;Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># join on costs by category (fossil incumbent vs CR)</span>
                <span class="n">base_with_tech</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;existing_fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;refinancing&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;patio_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;transmission_lines&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># join on mwh by category (fossil incumbent vs CR)</span>
                <span class="n">base_with_tech</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;existing_fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;refinancing&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_Fossil&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;patio_clean&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_CR&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;transmission_lines&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_CR&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>  <span class="c1"># bring in CR capactiy</span>
                <span class="n">base</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;category in (&#39;patio_clean&#39;,)&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">clean_tech</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">technology_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">re_rename</span><span class="p">))</span>
                <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                    <span class="n">all_techs</span><span class="p">,</span>
                    <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                    <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
                    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_o&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;clean_tech&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;operating_year&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">MW</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;region&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                    <span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;clean_tech&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;MW&quot;</span><span class="p">,</span>
                    <span class="n">aggfunc</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;right&quot;</span> <span class="k">if</span> <span class="n">cr_only</span> <span class="k">else</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">total_clean</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[[</span><span class="s2">&quot;Solar&quot;</span><span class="p">,</span> <span class="s2">&quot;Wind&quot;</span><span class="p">,</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;objective&quot;</span><span class="p">,</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span>
                    <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Costs_Disc_CR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Costs_Disc_Fossil&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MWh_Fossil&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;MWh_CR&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Disc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Batteries&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Solar&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Wind&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;total_clean&quot;</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># clean_rep.columns=list(map(&quot;_&quot;.join, clean_rep.columns))</span>
        <span class="c1"># clean_rep = clean_rep.set_axis(list(map(&quot;_&quot;.join, clean_rep.columns)), axis=1).reset_index(level=&quot;Disc&quot;)</span>

        <span class="k">with</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="s2">&quot;az://patio-data/20241031/Copy of IRP Service 37_EQ Research_RMI_8.31.23.xlsx&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">irp_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
                    <span class="n">f</span><span class="p">,</span>
                    <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;IRP Data&quot;</span><span class="p">,</span>
                    <span class="n">header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;np.nan&quot;</span><span class="p">],</span>
                    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;EIA ID&quot;</span><span class="p">,</span> <span class="s2">&quot;Anticipated Date for Next IRP&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;EIA ID&quot;</span><span class="p">:</span> <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Anticipated Date for Next IRP&quot;</span><span class="p">:</span> <span class="s2">&quot;next_irp_date&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">fix_ids</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">clean_rep</span><span class="o">.</span><span class="n">set_axis</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">,</span> <span class="n">clean_rep</span><span class="o">.</span><span class="n">columns</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">Disc</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc_max_earnings</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">Disc_least_cost</span><span class="p">))</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Disc_max_earnings&quot;</span><span class="p">,</span> <span class="s2">&quot;Disc_least_cost&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">er_sensitivity</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;least_cost &amp; counterfactual_baseline &amp; ~selected &amp; category in (&#39;existing_fossil&#39;,)&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;Costs_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span> <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh&quot;</span><span class="p">:</span> <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">rank_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_clean_max_earnings</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;total_clean_least_cost&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">rank_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">total_clean_least_cost</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;1:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">capacity</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">())</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="o">.</span><span class="n">plant_name_eia</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;technology_description&quot;</span><span class="p">:</span> <span class="n">PLOT_MAP</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">clean_repowering_type</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">clean_repowering_type</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">total_clean_max_earnings</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">total_clean_least_cost</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">),</span>
                <span class="n">annualized_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_least_cost</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_fossil_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_Fossil_least_cost</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_cr_npv_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_CR_least_cost</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_max_earnings</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_fossil_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_Fossil_max_earnings</span>
                <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_cr_npv_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_CR_max_earnings</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">annualized_npv_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Costs_Disc_cfl</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">Disc</span><span class="p">,</span>
                <span class="n">utilization_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_least_cost</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">utilization_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_max_earnings</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">utilization_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">MWh_cfl</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">capacity_mw</span> <span class="o">*</span> <span class="mi">8766</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
                <span class="n">annual_emissions_least_cost</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_least_cost</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">annual_emissions_max_earnings</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_max_earnings</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                <span class="n">annual_emissions_cfl</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">Emissions_cfl</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">irp_data</span><span class="p">,</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">coal_site</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">plant_id_eia</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">c2</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">cr</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;annualized_fossil_npv_max_earnings&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;annualized_cr_npv_max_earnings&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_max_earnings</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_max_earnings</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Max Earnings NPVs don&#39;t add up&quot;</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span>
                <span class="n">cr</span><span class="p">[[</span><span class="s2">&quot;annualized_fossil_npv_least_cost&quot;</span><span class="p">,</span> <span class="s2">&quot;annualized_cr_npv_least_cost&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">),</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_least_cost</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">|</span> <span class="n">cr</span><span class="o">.</span><span class="n">annualized_npv_least_cost</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;Least Cost NPVs don&#39;t add up&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort_cols</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cr</span>
        <span class="n">prm</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
            <span class="s2">&quot;capacity_mw&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;state&quot;</span><span class="p">,</span>
            <span class="s2">&quot;region&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean_repowering_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_clean_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;total_clean_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Batteries_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Batteries_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Solar_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wind_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Wind_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_CR_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_CR_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_Fossil_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MWh_Fossil_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_CR_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_CR_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_Fossil_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Costs_Disc_Fossil_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Emissions_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_fossil_npv_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_cr_npv_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_fossil_npv_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_cr_npv_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annualized_npv_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;utilization_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_least_cost&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_max_earnings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annual_emissions_cfl&quot;</span><span class="p">,</span>
            <span class="s2">&quot;next_irp_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;coal_site&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">cr</span><span class="p">[</span><span class="n">prm</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_cfl&quot;</span><span class="p">,</span> <span class="s2">&quot;_bau&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">prm</span><span class="p">})</span></div>


<div class="viewcode-block" id="BAs.cost_waterfall">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.cost_waterfall">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cost_waterfall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">source_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">least_cost</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">&quot;region&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Args:</span>
<span class="sd">            source_data: econ_results or by_lse</span>
<span class="sd">            least_cost: only required for econ_results</span>
<span class="sd">            by: column to group by e.g. region, utility_id_eia</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>  <span class="c1"># noqa: D414</span>
        <span class="n">cost_cat_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;existing_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;existing_fossil&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;existing_other&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;existing_xpatio&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;old_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_fossil&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_transmission_upgrades&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Clean repowering Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;refinancing&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;EIR&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;transmission_lines&quot;</span><span class="p">,</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Capex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;existing_fossil&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Fossil Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_fossil&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Fossil Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;proposed_transmission_upgrades&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;patio_clean&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Clean repowering Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;transmission_lines&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Opex&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;existing_other&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex&quot;</span><span class="p">,</span> <span class="s2">&quot;Other Opex&quot;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;cost_cat&quot;</span><span class="p">,</span> <span class="s2">&quot;new_cat&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="n">source_data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source_data</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">source_data</span> <span class="o">=</span> <span class="n">source_data</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
        <span class="n">source_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">source_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">least_cost</span> <span class="k">else</span> <span class="n">source_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~least_cost&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">for_wtfl</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">source_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                    <span class="s2">&quot;is_irp_year &amp; category in (&#39;patio_clean&#39;, &#39;refinancing&#39;, &#39;proposed_fossil&#39;, &#39;existing_fossil&#39;)&quot;</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                    <span class="n">selected_</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">selected</span><span class="p">,</span> <span class="s2">&quot;selected&quot;</span><span class="p">,</span> <span class="s2">&quot;cfl&quot;</span><span class="p">),</span>
                    <span class="c1">#                               _cat=lambda: x.category.map(</span>
                    <span class="c1">#    {&#39;patio_clean&#39;: &#39;patio_clean&#39;,</span>
                    <span class="c1"># &#39;transmission_lines&#39;: &#39;transmission_lines&#39;,</span>
                    <span class="c1"># &#39;proposed_fossil&#39;: &#39;proposed_fossil&#39;,</span>
                    <span class="c1"># &#39;proposed_clean&#39;: &#39;proposed_clean&#39;,</span>
                    <span class="c1"># &#39;proposed_transmission_upgrades&#39;: &#39;proposed_transmission_upgrades&#39;,</span>
                    <span class="c1"># &#39;existing_fossil&#39;: &#39;existing_fossil&#39;,</span>
                    <span class="c1"># &#39;existing_xpatio&#39;: &#39;existing_xpatio&#39;,</span>
                    <span class="c1"># &#39;old_clean&#39;: &#39;old_clean&#39;,</span>
                    <span class="c1"># &#39;existing_other&#39;: &#39;existing_other&#39;,</span>
                    <span class="c1"># &#39;existing_clean&#39;: &#39;existing_clean&#39;,</span>
                    <span class="c1"># &#39;refinancing&#39;: &#39;EIR&#39;}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">by</span><span class="p">,</span> <span class="s2">&quot;selected_&quot;</span><span class="p">,</span> <span class="s2">&quot;category&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span>
                    <span class="p">[</span><span class="s2">&quot;Capex_Costs_Disc&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex_Disc&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">melt</span><span class="p">(</span>
                <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">by</span><span class="p">,</span>
                    <span class="s2">&quot;selected_&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;category&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Capex_Costs_Disc&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex_Disc&quot;</span><span class="p">],</span>
                <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;cost_cat&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;cost_cat&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Capex_Costs_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;Capex_Costs&quot;</span><span class="p">,</span> <span class="s2">&quot;Opex_Disc&quot;</span><span class="p">:</span> <span class="s2">&quot;Opex&quot;</span><span class="p">}})</span>
            <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cost_cat_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="s2">&quot;cost_cat&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">by</span><span class="p">,</span> <span class="s2">&quot;selected_&quot;</span><span class="p">,</span> <span class="s2">&quot;new_cat&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;cost_cat&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">for_wtfl</span></div>


<div class="viewcode-block" id="BAs.transactions_drive_cr_cost_increase">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.transactions_drive_cr_cost_increase">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">transactions_drive_cr_cost_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Cases where the change in transaction revenue &gt; clean repowering cost increase.&quot;&quot;&quot;</span>
        <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">blse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span>
                    <span class="n">blse</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                        <span class="n">on</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                        <span class="n">values</span><span class="o">=</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">,</span>
                        <span class="n">aggregate_function</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">))</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">))</span>
                        <span class="o">.</span><span class="n">is_between</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">not_</span><span class="p">()</span>
                    <span class="p">)[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;LSE&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">col</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">concat_str</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;portfolio&quot;</span><span class="p">),</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;transaction&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;transaction&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;owned&quot;</span><span class="p">)),</span>
                    <span class="n">separator</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">],</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_type&quot;</span><span class="p">],</span>
                <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Costs_Disc&quot;</span><span class="p">],</span>
                <span class="n">aggregate_function</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">counterfactual</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual_owned&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual_transaction&quot;</span><span class="p">),</span>
                <span class="n">selected</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_owned&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_transaction&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">blse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_name_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">())</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">validate</span><span class="o">=</span><span class="s2">&quot;m:1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">))</span>
                <span class="o">&lt;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_transaction&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual_transaction&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;utility_name_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;counterfactual_transaction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;selected_transaction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;counterfactual&quot;</span><span class="p">,</span>
                <span class="s2">&quot;selected&quot;</span><span class="p">,</span>
                <span class="s2">&quot;counterfactual_owned&quot;</span><span class="p">,</span>
                <span class="s2">&quot;selected_owned&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">pl_scan_pudl</span><span class="p">(</span><span class="s2">&quot;core_eia861__yearly_operational_data_misc&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pudl_release</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;data_maturity&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;final&quot;</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;report_date&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;2022-01-01&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sales_for_resale_mwh&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;total_disposition_mwh&quot;</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;hist_resale_share&quot;</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">collect</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">,</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.brownfields">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.brownfields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">brownfields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">LazyFrame</span><span class="p">:</span>
        <span class="c1"># import geopandas as gpd</span>

        <span class="c1"># acres = (</span>
        <span class="c1">#     gpd.read_file(path, layer=&quot;ACRES&quot;)[</span>
        <span class="c1">#         [</span>
        <span class="c1">#             &quot;REGISTRY_ID&quot;,</span>
        <span class="c1">#             &quot;PRIMARY_NAME&quot;,</span>
        <span class="c1">#             &quot;LOCATION_ADDRESS&quot;,</span>
        <span class="c1">#             &quot;CITY_NAME&quot;,</span>
        <span class="c1">#             &quot;COUNTY_NAME&quot;,</span>
        <span class="c1">#             &quot;FIPS_CODE&quot;,</span>
        <span class="c1">#             &quot;STATE_CODE&quot;,</span>
        <span class="c1">#             &quot;POSTAL_CODE&quot;,</span>
        <span class="c1">#             &quot;LATITUDE83&quot;,</span>
        <span class="c1">#             &quot;LONGITUDE83&quot;,</span>
        <span class="c1">#             &quot;HUC8_CODE&quot;,</span>
        <span class="c1">#             &quot;ACCURACY_VALUE&quot;,</span>
        <span class="c1">#             &quot;COLLECT_MTH_DESC&quot;,</span>
        <span class="c1">#             &quot;REF_POINT_DESC&quot;,</span>
        <span class="c1">#             &quot;CREATE_DATE&quot;,</span>
        <span class="c1">#             &quot;UPDATE_DATE&quot;,</span>
        <span class="c1">#             &quot;LAST_REPORTED_DATE&quot;,</span>
        <span class="c1">#             &quot;FAC_URL&quot;,</span>
        <span class="c1">#             &quot;PGM_SYS_ID&quot;,</span>
        <span class="c1">#             &quot;PGM_SYS_ACRNM&quot;,</span>
        <span class="c1">#             &quot;INTEREST_TYPE&quot;,</span>
        <span class="c1">#             &quot;PROGRAM_URL&quot;,</span>
        <span class="c1">#             &quot;PGM_REPORT_URL&quot;,</span>
        <span class="c1">#             &quot;PUBLIC_IND&quot;,</span>
        <span class="c1">#             &quot;ACTIVE_STATUS&quot;,</span>
        <span class="c1">#             &quot;FEDERAL_AGENCY_NAME&quot;,</span>
        <span class="c1">#             &quot;HUC_12&quot;,</span>
        <span class="c1">#             &quot;FEDERAL_LAND_IND&quot;,</span>
        <span class="c1">#             &quot;FED_FACILITY_CODE&quot;,</span>
        <span class="c1">#             &quot;EPA_REGION_CODE&quot;,</span>
        <span class="c1">#             &quot;KEY_FIELD&quot;,</span>
        <span class="c1">#         ]</span>
        <span class="c1">#     ]</span>
        <span class="c1">#     .rename(columns={&quot;LATITUDE83&quot;: &quot;latitude&quot;, &quot;LONGITUDE83&quot;: &quot;longitude&quot;})</span>
        <span class="c1">#     .pipe(simplify_columns)</span>
        <span class="c1"># )</span>
        <span class="c1"># https://www.epa.gov/cleanups/cimc-how-download-data</span>
        <span class="n">repowered</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># noqa: F841</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">())</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2035</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_series</span><span class="p">()</span>
            <span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">rmi_cloud_fs</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="s2">&quot;az://patio-data/20241031/CIMC_Brownfields_Download.csv&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">bfields</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">simplify_columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">bfields</span><span class="p">)</span>
            <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
            <span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="n">needs_cleanup</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;indicate_whether_cleanup_is_necessary&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>
                    <span class="o">==</span> <span class="s2">&quot;Y&quot;</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
                        <span class="s2">&quot;indicate_whether_cleanup_treatment_technology_ies_were_implemented&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
                    <span class="o">==</span> <span class="s2">&quot;N&quot;</span>
                <span class="p">),</span>
                <span class="n">available</span><span class="o">=</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">sum_horizontal</span><span class="p">(</span>
                        <span class="s2">&quot;redevelopment_land_use_residential&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redevelopment_land_use_greenspace&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redevelopment_land_use_industrial&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;redevelopment_land_use_commercial&quot;</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="o">==</span> <span class="mf">0.0</span>
                <span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;redevelopment_start_date&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_null</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;property_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">))</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
                    <span class="s2">&quot;property_name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;property_owner&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;street_address&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;zip_code&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;city&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;latitude_bf&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;longitude_bf&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="s2">&quot;size_in_acres&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;needs_cleanup&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;size_in_acres&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_not_null</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;property_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;plant_id_eia in @repowered&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;final_ba_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">lazy</span><span class="p">()</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;cross&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                <span class="n">pl_distance</span><span class="p">,</span>
                <span class="n">lat1</span><span class="o">=</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
                <span class="n">lat2</span><span class="o">=</span><span class="s2">&quot;latitude_bf&quot;</span><span class="p">,</span>
                <span class="n">lon1</span><span class="o">=</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
                <span class="n">lon2</span><span class="o">=</span><span class="s2">&quot;longitude_bf&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">radius</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.unused_clean_repowering">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.unused_clean_repowering">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unused_clean_repowering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify additional capacity / area at selected CR sites.</span>

<span class="sd">        Calculates how much additional RE could be installed at each fossil generator</span>
<span class="sd">        selected for clean repowering. Provides both installable capacity and area</span>
<span class="sd">         assuming that all selected clean repowering is actually built.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">()</span>
        <span class="n">core</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">econ_results</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="s2">&quot;re_plant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;Int64&quot;</span><span class="p">}))</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;sensitivity&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;least_cost&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2035</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;technology_description&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;Batteries&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;re_plant_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fos_id&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;generator_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fos_gen&quot;</span><span class="p">),</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;MW&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;selected_mw&quot;</span><span class="p">),</span>
                <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">,</span>
                <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parent_name&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;selected_mw&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">core</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;selected_mw&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;fos_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fos_ids&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;re_specs_out&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span> <span class="s2">&quot;area_per_mw&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="s2">&quot;selected_mw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fos_ids&quot;</span><span class="p">,</span>
                <span class="n">selected_sqkm</span><span class="o">=</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_mw&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;area_per_mw&quot;</span><span class="p">))</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">free</span> <span class="o">=</span> <span class="n">selected</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dfs</span><span class="p">[</span><span class="s2">&quot;re_specs_out&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">core</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">,</span> <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
                        <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_name&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span>
                <span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">,</span>
            <span class="n">coalesce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="c1"># sum over to account for multiple RE types at a given NREL site</span>
            <span class="n">available_sqkm</span><span class="o">=</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;area_sq_km&quot;</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_sqkm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;re_site_id&quot;</span><span class="p">),</span>
            <span class="n">available_mw</span><span class="o">=</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;area_sq_km&quot;</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_sqkm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fill_null</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="s2">&quot;re_site_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;area_per_mw&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">detail</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">free</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">free</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;fos_cap&quot;</span><span class="p">,</span> <span class="s2">&quot;incumbent_technology&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;selected_sqkm&quot;</span><span class="p">,</span> <span class="s2">&quot;available_mw&quot;</span><span class="p">,</span> <span class="s2">&quot;available_sqkm&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span>
                    <span class="s2">&quot;owner_utility_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;owner_utility_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;parent_name&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;re_plant_ids&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_id&quot;</span><span class="p">,</span> <span class="s2">&quot;fos_gen&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="BAs.clean_repowering_by_generator">
<a class="viewcode-back" href="../../../autoapi/patio/model/ba_level/index.html#patio.model.ba_level.BAs.clean_repowering_by_generator">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_repowering_by_generator</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">utility</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ba</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ba</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">utility</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ba</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;utility_id_eia&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">utility</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">utility</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">ba</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">utility</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="nb">list</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">blse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">by_lse</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;ba_code&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_in</span><span class="p">(</span><span class="n">ba</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;must provide either utility or ba&quot;</span><span class="p">)</span>
        <span class="n">blse</span> <span class="o">=</span> <span class="n">blse</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;generator_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Utf8</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">blse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;existing_fossil&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">values</span><span class="o">=</span><span class="s2">&quot;MWh&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span> <span class="s2">&quot;technology_description&quot;</span><span class="p">],</span>
                <span class="n">on</span><span class="o">=</span><span class="s2">&quot;portfolio&quot;</span><span class="p">,</span>
                <span class="n">aggregate_function</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ad</span><span class="o">.</span><span class="n">gens</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                    <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span>
                <span class="p">),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">blse</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;patio_clean&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;operating_year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2032</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s2">&quot;MW&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;clean_repowering_mw&quot;</span><span class="p">)),</span>
                <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_id&quot;</span><span class="p">],</span>
                <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s2">&quot;plant_id_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;generator_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;plant_name_eia&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technology_description&quot;</span><span class="p">,</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;counterfactual_mwh&quot;</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;selected_mwh&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;counterfactual&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;selected&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;reduction_mwh&quot;</span><span class="p">),</span>
                <span class="s2">&quot;clean_repowering_mw&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;reduction_mwh&quot;</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># def patio_key(item):</span>
<span class="c1">#     if isinstance(item, pd.Series):</span>
<span class="c1">#         return item.astype(str).str.casefold().replace(ORDERING)</span>
<span class="c1">#     if isinstance(item, pd.Index):</span>
<span class="c1">#         return pd.Index([ORDERING.get(x.casefold(), str(x)) for x in item])</span>
<span class="c1">#     return ORDERING.get(item.casefold(), str(item))</span>

<span class="n">ORDERING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nuclear&quot;</span><span class="p">:</span> <span class="s2">&quot;000&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coal&quot;</span><span class="p">:</span> <span class="s2">&quot;001&quot;</span><span class="p">,</span>
    <span class="s2">&quot;coal ccs&quot;</span><span class="p">:</span> <span class="s2">&quot;0015&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gas cc&quot;</span><span class="p">:</span> <span class="s2">&quot;002&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gas ct&quot;</span><span class="p">:</span> <span class="s2">&quot;004&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gas rice&quot;</span><span class="p">:</span> <span class="s2">&quot;005&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gas st&quot;</span><span class="p">:</span> <span class="s2">&quot;003&quot;</span><span class="p">,</span>
    <span class="s2">&quot;other fossil&quot;</span><span class="p">:</span> <span class="s2">&quot;006&quot;</span><span class="p">,</span>
    <span class="s2">&quot;other&quot;</span><span class="p">:</span> <span class="s2">&quot;006&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hydro&quot;</span><span class="p">:</span> <span class="s2">&quot;007&quot;</span><span class="p">,</span>
    <span class="s2">&quot;biomass&quot;</span><span class="p">:</span> <span class="s2">&quot;008&quot;</span><span class="p">,</span>
    <span class="s2">&quot;solar&quot;</span><span class="p">:</span> <span class="s2">&quot;011&quot;</span><span class="p">,</span>
    <span class="s2">&quot;onshore wind&quot;</span><span class="p">:</span> <span class="s2">&quot;009&quot;</span><span class="p">,</span>
    <span class="s2">&quot;offshore wind&quot;</span><span class="p">:</span> <span class="s2">&quot;010&quot;</span><span class="p">,</span>
    <span class="s2">&quot;storage&quot;</span><span class="p">:</span> <span class="s2">&quot;012&quot;</span><span class="p">,</span>
    <span class="s2">&quot;curtailment&quot;</span><span class="p">:</span> <span class="s2">&quot;013&quot;</span><span class="p">,</span>
    <span class="s2">&quot;january&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span><span class="p">,</span>
    <span class="s2">&quot;february&quot;</span><span class="p">:</span> <span class="s2">&quot;102&quot;</span><span class="p">,</span>
    <span class="s2">&quot;march&quot;</span><span class="p">:</span> <span class="s2">&quot;103&quot;</span><span class="p">,</span>
    <span class="s2">&quot;april&quot;</span><span class="p">:</span> <span class="s2">&quot;104&quot;</span><span class="p">,</span>
    <span class="s2">&quot;may&quot;</span><span class="p">:</span> <span class="s2">&quot;105&quot;</span><span class="p">,</span>
    <span class="s2">&quot;june&quot;</span><span class="p">:</span> <span class="s2">&quot;106&quot;</span><span class="p">,</span>
    <span class="s2">&quot;july&quot;</span><span class="p">:</span> <span class="s2">&quot;107&quot;</span><span class="p">,</span>
    <span class="s2">&quot;august&quot;</span><span class="p">:</span> <span class="s2">&quot;108&quot;</span><span class="p">,</span>
    <span class="s2">&quot;september&quot;</span><span class="p">:</span> <span class="s2">&quot;109&quot;</span><span class="p">,</span>
    <span class="s2">&quot;october&quot;</span><span class="p">:</span> <span class="s2">&quot;110&quot;</span><span class="p">,</span>
    <span class="s2">&quot;november&quot;</span><span class="p">:</span> <span class="s2">&quot;111&quot;</span><span class="p">,</span>
    <span class="s2">&quot;december&quot;</span><span class="p">:</span> <span class="s2">&quot;112&quot;</span><span class="p">,</span>
    <span class="s2">&quot;historical&quot;</span><span class="p">:</span> <span class="s2">&quot;200&quot;</span><span class="p">,</span>
    <span class="s2">&quot;redispatch&quot;</span><span class="p">:</span> <span class="s2">&quot;201&quot;</span><span class="p">,</span>
    <span class="s2">&quot;selected&quot;</span><span class="p">:</span> <span class="s2">&quot;202&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CR&quot;</span><span class="p">:</span> <span class="s2">&quot;202&quot;</span><span class="p">,</span>
    <span class="s2">&quot;counterfactual&quot;</span><span class="p">:</span> <span class="s2">&quot;203&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Planned&quot;</span><span class="p">:</span> <span class="s2">&quot;203&quot;</span><span class="p">,</span>
    <span class="s2">&quot;2021&quot;</span><span class="p">:</span> <span class="s2">&quot;204&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Current&quot;</span><span class="p">:</span> <span class="s2">&quot;204&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">hrs_per_year</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">is_leap_year</span><span class="p">,</span>
            <span class="mi">8784</span><span class="p">,</span>
            <span class="mi">8760</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">is_leap_year</span><span class="p">,</span>
        <span class="mi">8784</span><span class="p">,</span>
        <span class="mi">8760</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    scalene patio/model/ba_level.py --profile-only &#39;model&#39; --profile-all</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">BAs</span><span class="p">(</span>
        <span class="c1"># name=&quot;Coops_&quot; + datetime.now().strftime(&quot;%Y%m%d%H%M&quot;),</span>
        <span class="n">solar_ilr</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
        <span class="n">data_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;re_by_plant&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;include_figs&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
        <span class="n">bas</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;PJM&quot;</span><span class="p">,</span>
            <span class="c1"># &quot;552&quot;,</span>
            <span class="c1"># &quot;554&quot;,</span>
            <span class="c1"># &quot;556&quot;,</span>
            <span class="c1"># &quot;560&quot;,</span>
            <span class="c1"># &quot;562&quot;,</span>
            <span class="c1"># &quot;569&quot;,</span>
            <span class="c1"># &quot;58&quot;,</span>
            <span class="c1"># &quot;AEC&quot;,</span>
            <span class="c1"># &quot;AECI&quot;,</span>
            <span class="c1"># &quot;CAISO&quot;,  # Arizona Electric Pwr Coop Inc?</span>
            <span class="c1"># &quot;DUKE&quot;,</span>
            <span class="c1"># &quot;ERCO&quot;,</span>
            <span class="c1"># &quot;MISO&quot;,</span>
            <span class="c1"># &quot;PAC&quot;,</span>
            <span class="c1"># &quot;PJM&quot;,</span>
            <span class="c1"># &quot;SEC&quot;,</span>
            <span class="c1"># &quot;SOCO&quot;,</span>
            <span class="c1"># &quot;SWPP&quot;,</span>
            <span class="c1"># &quot;WALC&quot;,  # Arizona Electric Pwr Coop Inc?</span>
        <span class="p">],</span>
        <span class="n">scenario_configs</span><span class="o">=</span><span class="p">[</span>
            <span class="n">ScenarioConfig</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">ScenarioConfig</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="c1"># ScenarioConfig(0.9, 0, 0.0, 4, 0),</span>
            <span class="c1"># ScenarioConfig(1.0, 0, 0.0, 4, 0),</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_all</span><span class="p">()</span>
    <span class="c1"># self.select_utils(</span>
    <span class="c1">#     util_ids=(</span>
    <span class="c1">#         39347,</span>
    <span class="c1">#         16624,</span>
    <span class="c1">#         12658,</span>
    <span class="c1">#         4716,</span>
    <span class="c1">#         1692,</span>
    <span class="c1">#         17632,</span>
    <span class="c1">#         1307,</span>
    <span class="c1">#         18315,</span>
    <span class="c1">#         40230,</span>
    <span class="c1">#         30151,</span>
    <span class="c1">#         7570,</span>
    <span class="c1">#         9267,</span>
    <span class="c1">#         5580,</span>
    <span class="c1">#         924,</span>
    <span class="c1">#         21554,</span>
    <span class="c1">#         7353,</span>
    <span class="c1">#         20447,</span>
    <span class="c1">#         796,</span>
    <span class="c1">#         20910,</span>
    <span class="c1">#         189,</span>
    <span class="c1">#         25422,</span>
    <span class="c1">#         17583,</span>
    <span class="c1">#         13683,</span>
    <span class="c1">#         7349,</span>
    <span class="c1">#         7004,</span>
    <span class="c1">#         17568,</span>
    <span class="c1">#         2172,</span>
    <span class="c1">#         13994,</span>
    <span class="c1">#         40229,</span>
    <span class="c1">#         3522,</span>
    <span class="c1">#         13670,</span>
    <span class="c1">#         807,</span>
    <span class="c1">#         40211,</span>
    <span class="c1">#         3258,</span>
    <span class="c1">#         4363,</span>
    <span class="c1">#         19558,</span>
    <span class="c1">#         40307,</span>
    <span class="c1">#         11824,</span>
    <span class="c1">#         19389,</span>
    <span class="c1">#     ),</span>
    <span class="c1">#     export=&quot;xl&quot;,</span>
    <span class="c1"># )</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, RMI, CC-BY-4.0
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/rmi-electricity/patio" aria-label="GitHub">
        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
    </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../../_static/documentation_options.js?v=fce13f47"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>